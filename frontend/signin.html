<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0a">
  <title>XapoBank - Sign In</title>
  <script src="/config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }

    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    * {
      font-family: 'Poppins', system-ui, -apple-system, sans-serif;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .hover-lift {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .form-input {
      background: #0f0f0f !important;
      border: 1px solid #2a2a2a !important;
      border-radius: 999px !important;
      color: white !important;
      transition: all 0.2s ease !important;
    }

    .form-input:focus {
      border-color: #ff6b35 !important;
      outline: none !important;
    }

    .form-input::placeholder {
      color: #9ca3af !important;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      box-sizing: border-box;
    }

    @media (max-width: 640px) {
      .auth-card {
        margin: 0.5rem;
        padding: 1.25rem;
      }
      .form-input { padding: 0.75rem 1rem !important; }
      body { padding: 1rem 0.5rem; }
    }

    @media (max-width: 480px) {
      .auth-card {
        padding: 1rem;
      }
      .logo-container { width: 80px; height: 80px; }
      .auth-card p { font-size: 0.75rem; }
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .auth-card { max-width: 28rem; }
    }
  </style>
 </head>
 <body class="h-full w-full" style="background: #0a0a0a;">
  <div class="min-h-screen flex items-center justify-center px-2 sm:px-4 py-4 sm:py-8">
   <div class="auth-card rounded-lg sm:rounded-xl md:rounded-2xl p-4 sm:p-6 md:p-8 w-full max-w-sm hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
    <!-- Logo/Brand -->
    <div class="text-center mb-6 sm:mb-8">
     <div class="logo-container w-24 h-24 sm:w-32 sm:h-32 mx-auto mb-3 sm:mb-4 flex items-center justify-center">
      <img src="xapo_logo.svg" alt="Xapo Logo" class="w-full h-full object-contain">
     </div>
     <p class="text-gray-400 text-xs sm:text-sm">Secure Bitcoin Banking</p>
    </div>

    <!-- Sign In Form -->
    <form id="signin-form" class="space-y-3 sm:space-y-4">
     <div>
      <label class="text-gray-400 text-xs sm:text-sm mb-1 sm:mb-2 block">Email Address</label>
      <input type="email" name="email" placeholder="Enter your email" required class="form-input w-full px-3 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm">
     </div>
     <div>
      <label class="text-gray-400 text-xs sm:text-sm mb-1 sm:mb-2 block">Password</label>
      <div class="relative">
       <input type="password" name="password" placeholder="Enter your password" required class="form-input w-full px-3 sm:px-4 py-2 sm:py-3 pr-10 text-xs sm:text-sm" id="signin-password">
       <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-orange-500 transition-colors toggle-password" data-target="signin-password">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="eye-open">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </svg>
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="eye-closed hidden">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
        </svg>
       </button>
      </div>
     </div>
     <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
      <label class="flex items-center">
       <input type="checkbox" class="mr-2 accent-orange-500">
       <span class="text-gray-400 text-xs sm:text-sm">Remember me</span>
      </label>
      <a href="reset-password.html" class="text-orange-500 hover:text-orange-400 text-xs sm:text-sm transition-colors">Forgot password?</a>
     </div>
     <button type="submit" class="w-full py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift rounded-full" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">
      Sign In
     </button>
    </form>

    <div class="text-center mt-4 sm:mt-6">
     <p class="text-gray-400 text-xs sm:text-sm">Don't have an account? <button id="toggle-signup" class="text-orange-500 hover:text-orange-400 transition-colors bg-transparent border-0 p-0">Sign up</button></p>
    </div>
    <!-- Collapsible Sign Up Panel (lazy-loaded) -->
    <div id="signup-panel" class="hidden mt-4"></div>
   </div>
  </div>

  <!-- Sign In Modal -->
  <div id="signin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
   <div class="bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4 text-center">
    <div id="modal-content">
     <!-- Loading state -->
     <div id="loading-state" class="hidden">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"></div>
      <p class="text-white text-lg">Signing you in...</p>
     </div>
     <!-- Success state -->
     <div id="success-state" class="hidden">
      <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
       </svg>
      </div>
      <p class="text-white text-lg mb-4">Sign in successful!</p>
      <p class="text-gray-300 text-sm">Redirecting to dashboard...</p>
     </div>
     <!-- Error state -->
     <div id="error-state" class="hidden">
      <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
       <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg>
      </div>
      <p class="text-white text-lg mb-2">Sign in failed</p>
      <p id="error-message" class="text-gray-300 text-sm mb-4"></p>
      <button id="close-modal" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">Try Again</button>
     </div>
    </div>
   </div>
  </div>

  <script>
    function initializeSignIn() {
      const modal = document.getElementById('signin-modal');
      const loadingState = document.getElementById('loading-state');
      const successState = document.getElementById('success-state');
      const errorState = document.getElementById('error-state');
      const errorMessage = document.getElementById('error-message');
      const closeModal = document.getElementById('close-modal');

      function showModal() {
        modal.classList.remove('hidden');
      }

      function hideModal() {
        modal.classList.add('hidden');
        loadingState.classList.add('hidden');
        successState.classList.add('hidden');
        errorState.classList.add('hidden');
      }

      function showLoading() {
        loadingState.classList.remove('hidden');
        successState.classList.add('hidden');
        errorState.classList.add('hidden');
      }

      function showSuccess() {
        loadingState.classList.add('hidden');
        successState.classList.remove('hidden');
        errorState.classList.add('hidden');
      }

      function showError(message) {
        loadingState.classList.add('hidden');
        successState.classList.add('hidden');
        errorState.classList.remove('hidden');
        errorMessage.textContent = message;
      }

      closeModal.addEventListener('click', hideModal);

      document.getElementById('signin-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        showModal();
        showLoading();

        try {
          // Check if API_BASE is available
          if (typeof window.API_BASE === 'undefined') {
            throw new Error('API configuration not loaded');
          }
          
          console.log('API_BASE:', window.API_BASE);
          console.log('Login endpoint:', window.API_BASE + '/api/auth/login');
          const response = await fetch(window.API_BASE + '/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            localStorage.setItem('token', result.token);
            localStorage.setItem('user', JSON.stringify(result.data));
            showSuccess();
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1500);
          } else {
            showError(result.message || 'Login failed');
          }
        } catch (error) {
          console.error('Network error details:', error);
          console.error('Error message:', error.message);
          showError('Network error. Please try again.');
        }
      });
    }

    // Password visibility toggle handler
    function setupPasswordToggle() {
      document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = button.dataset.target;
          const input = document.getElementById(targetId);
          const eyeOpen = button.querySelector('.eye-open');
          const eyeClosed = button.querySelector('.eye-closed');

          if (input.type === 'password') {
            input.type = 'text';
            eyeOpen.classList.add('hidden');
            eyeClosed.classList.remove('hidden');
          } else {
            input.type = 'password';
            eyeOpen.classList.remove('hidden');
            eyeClosed.classList.add('hidden');
          }
        });
      });
    }

    // Wait for config.js to load
    function waitForConfig() {
      if (typeof window.API_BASE !== 'undefined') {
        initializeSignIn();
        setupPasswordToggle();
      } else {
        setTimeout(waitForConfig, 100);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForConfig);
    } else {
      waitForConfig();
    }

    // Toggle and lazy-load signup form into this page
    (function setupInlineSignup() {
      const toggle = document.getElementById('toggle-signup');
      const panel = document.getElementById('signup-panel');
      let loaded = false;

      function showPanel() {
        panel.classList.remove('hidden');
        panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function hidePanel() {
        panel.classList.add('hidden');
      }

      async function loadSignup() {
        if (loaded) return;
        try {
          const resp = await fetch('signup.html');
          const text = await resp.text();
          // extract the signup form from the markup
          const tmp = document.createElement('div');
          tmp.innerHTML = text;
          const signupForm = tmp.querySelector('#signup-form');
          if (signupForm) {
            // insert the form HTML into the panel
            panel.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'rounded-lg p-4 sm:p-6 bg-transparent';
            wrapper.innerHTML = signupForm.outerHTML;
            panel.appendChild(wrapper);
            attachSignupHandler(panel.querySelector('#signup-form'));
            loaded = true;
          } else {
            panel.textContent = 'Unable to load signup form.';
          }
        } catch (e) {
          console.error('Failed to load signup form:', e);
          panel.textContent = 'Unable to load signup form.';
        }
      }

      async function attachSignupHandler(form) {
        if (!form) return;
        // small shim of signup behavior (password confirm + POST)
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const data = Object.fromEntries(new FormData(form));
          if ((data.password || '') !== (data.confirmPassword || '')) {
            alert('Passwords do not match');
            return;
          }
          try {
            if (typeof window.API_BASE === 'undefined') throw new Error('API config missing');
            const payload = {
              name: `${data.firstName || ''} ${data.lastName || ''}`.trim(),
              email: data.email,
              password: data.password,
              phone: data.phone || '',
              country: data.country || '',
              promoCode: (data.promoCode || '').trim() || undefined
            };
            const r = await fetch(window.API_BASE + '/api/auth/register', {
              method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
            });
            const res = await r.json().catch(()=>({success:false}));
            if (res && res.success) {
              localStorage.setItem('token', res.token);
              localStorage.setItem('user', JSON.stringify(Object.assign({}, res.data || {}, { promoCode: payload.promoCode }))); 
              alert('Account created — redirecting to dashboard');
              window.location.href = 'dashboard.html';
            } else {
              alert(res && (res.message || res.error) ? (res.message || res.error) : 'Registration failed');
            }
          } catch (err) {
            console.error(err);
            alert('Registration error — check console');
          }
        });
      }

      if (toggle) {
        toggle.addEventListener('click', async (e) => {
          if (panel.classList.contains('hidden')) {
            await loadSignup();
            showPanel();
          } else {
            hidePanel();
          }
        });
      }
    })();
  </script>
 </body>
</html>
