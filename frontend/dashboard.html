<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bitcoin Dashboard">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0a0a0a">
  <title>XapoBank</title>
  <script src="/config.js"></script>
  <script>
    // Check authentication before showing dashboard
    const token = localStorage.getItem('token');
    if (!token) {
      // No token, redirect to signup page
      window.location.href = 'signup.html';
    } else {
      // Verify token with backend and fetch user data
      fetch(window.API_BASE + '/api/auth/me', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          // Token invalid, redirect to login
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = 'signin.html';
        }
        return response.json();
      })
      .then(data => {
        console.log('Auth response data:', data);
        if (data.success) {
          // Store user data in localStorage
          localStorage.setItem('user', JSON.stringify(data.data));
          console.log('User data stored in localStorage:', data.data);
          // Populate user info after storing data and when DOM is ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
              populateUserInfo();
              loadProfilePicture();
              initSocket();
            });
          } else {
            populateUserInfo();
            loadProfilePicture();
            initSocket();
          }
        }
      })
      .catch(() => {
        // Network error, redirect to login
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'signin.html';
      });
    }
  </script>
  <script src="/config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.19.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@0.1.19/dist/face-api.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    /* Hide native scrollbars but keep scrolling functional */
    html, body {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE 10+ */
    }
    html::-webkit-scrollbar, body::-webkit-scrollbar {
      width: 0px;
      height: 0px;
      background: transparent;
    }
    /* Also hide scrollbars for overflow containers used in the app */
    #app, .overflow-y-auto, .h-full {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    #app::-webkit-scrollbar, .overflow-y-auto::-webkit-scrollbar, .h-full::-webkit-scrollbar {
      width: 0px;
      height: 0px;
      background: transparent;
      display: none;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    
    * {
      font-family: 'Poppins', system-ui, -apple-system, sans-serif;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .hover-lift {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Stock item rectangular layout */
    .stock-item {
      display: flex !important;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 16px !important;
      min-height: 88px;
      border-radius: 12px !important;
      box-sizing: border-box;
    }
    .stock-item .w-12, .stock-item .w-10 { flex: 0 0 56px; width: 56px; height: 56px; border-radius: 8px; }
    .stock-item p { margin: 0; }
    .stock-item .text-right { flex: 0 0 auto; min-width: 110px; text-align: right !important; }
    .stock-item .text-right p { text-align: right !important; }
    
    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* Professional stock card variant */

    .hover-lift:active {
      transform: translateY(-2px);
    }
    
    .balance-hidden .balance-value {
      filter: blur(10px);
      user-select: none;
    }
    
    .chart-bar {
      height: 60px;
      background: linear-gradient(to top, #ff4500, #ff6b35);
      border-radius: 4px 4px 0 0;
      animation: growBar 1s ease-out;
    }
    
    @keyframes growBar {
      from { height: 0; }
      to { height: 60px; }
    }
    
    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .action-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
    }
    
    .action-icon:hover {
      transform: scale(1.1);
    }
    
    .nav-btn {
      color: #666666;
    }
    
    .nav-btn.active {
      color: #ff6b35;
    }
    
    .nav-btn:hover {
      color: #ff6b35;
    }

    .savings-progress-bar {
      height: 8px;
      background: rgba(255, 107, 53, 0.2);
      border-radius: 99px;
      overflow: hidden;
    }

    .savings-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b35 0%, #ff4500 100%);
      border-radius: 99px;
      transition: width 1s ease-out;
    }
    
    @media (max-width: 640px) {
      .action-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .chart-bar {
        height: 40px;
      }
      
      @keyframes growBar {
        from { height: 0; }
        to { height: 40px; }
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-y-auto" style="background: #0a0a0a;"><!-- Top Bar -->
   <header class="fixed top-0 left-0 right-0 border-b border-gray-800 px-3 sm:px-4 md:px-6 py-3 md:py-4 z-50 overflow-visible" style="background: #111111;">
    <div class="max-w-7xl mx-auto flex justify-between items-center"><button id="user-profile-btn" class="flex items-center gap-2 md:gap-3 hover:opacity-80 transition-opacity">
      <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-white font-bold text-base md:text-lg overflow-hidden" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">
       <img id="header-profile-picture" src="" alt="Profile Picture" class="w-full h-full rounded-full object-cover hidden">
       <svg id="header-profile-icon" width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
       </svg>
      </div>
      <div class="text-left">
       <h1 id="header-user-name" class="text-white font-bold text-sm md:text-lg">Loading...</h1>
       <p class="text-gray-400 text-xs">Welcome back</p>
      </div></button>
     <div class="flex items-center gap-2 md:gap-3"><!-- Customer Care Button --> <button id="customer-care-btn" class="w-9 h-9 md:w-10 md:h-10 rounded-lg flex items-center justify-center transition-all hover-lift" style="background: rgba(255, 107, 53, 0.1);" title="Customer Care">
       <svg width="20" height="20" class="md:w-[22px] md:h-[22px]" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
       </svg></button>
     </div>
    </div>
   </header><!-- Main Content -->
   <main class="px-3 sm:px-4 md:px-6 py-4 sm:py-6 md:py-8 pb-24 sm:pb-28 pt-28 sm:pt-28 md:pt-32"><!-- Home Page -->
    <div id="home-page" class="max-w-7xl mx-auto"><!-- Balance Overview -->
     <div id="balance-card" class="rounded-xl md:rounded-2xl p-4 sm:p-6 md:p-8 mb-4 sm:mb-6 hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <div class="flex justify-between items-start mb-4 sm:mb-6">
       <div class="flex-1">
        <p class="text-gray-400 text-xs sm:text-sm font-medium mb-1 sm:mb-2">BTC Balance</p>
        <div class="flex items-baseline gap-2 sm:gap-4">
         <h2 class="text-white text-3xl sm:text-4xl md:text-5xl font-bold balance-value">0.0000</h2>
        </div>
        <p class="text-gray-400 text-xs sm:text-sm mt-2 sm:mt-3">USD Equivalent: <span class="text-green-400 font-semibold" id="usd-equivalent-display">$0.00</span></p>
        <div class="flex flex-col gap-1 mt-2 sm:mt-3">
          <span class="text-orange-500 text-sm sm:text-base font-semibold" id="btc-price-display">BTC: $42,000</span>
          <span class="text-gray-500 text-xs" id="btc-update-time">updating...</span>
        </div>
       </div><button id="toggle-balance-btn" class="flex-shrink-0 w-9 h-9 sm:w-10 sm:h-10 rounded-lg flex items-center justify-center transition-all hover-lift ml-2" style="background: rgba(255, 107, 53, 0.1);" title="Hide/Show Balance">
        <svg id="eye-icon" width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </svg></button>
      </div><!-- Mini Chart -->
      <div class="flex items-end justify-between gap-1 sm:gap-2 h-12 sm:h-16">
       <div class="chart-bar" style="height: 45px; opacity: 0.6;"></div>
       <div class="chart-bar" style="height: 38px; opacity: 0.7;"></div>
       <div class="chart-bar" style="height: 52px; opacity: 0.8;"></div>
       <div class="chart-bar" style="height: 48px; opacity: 0.75;"></div>
       <div class="chart-bar" style="height: 60px; opacity: 1;"></div>
       <div class="chart-bar" style="height: 55px; opacity: 0.9;"></div>
       <div class="chart-bar" style="height: 58px; opacity: 0.95;"></div>
      </div>
     </div><!-- Quick Actions -->
     <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6"><button id="add-funds-btn" class="rounded-lg sm:rounded-xl p-3 sm:p-4 md:p-5 hover-lift text-left" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
       <div class="action-icon mb-2 sm:mb-3" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
        <svg width="18" height="18" class="sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
       </div><p class="text-white font-semibold text-xs sm:text-sm">Add Funds</p><p class="text-gray-400 text-xs mt-1">Deposit or Collateral</p></button> <button id="savings-btn" class="rounded-lg sm:rounded-xl p-3 sm:p-4 md:p-5 hover-lift text-left" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
       <div class="action-icon mb-2 sm:mb-3" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
        <svg width="18" height="18" class="sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
       </div><p class="text-white font-semibold text-xs sm:text-sm">Savings</p><p class="text-gray-400 text-xs mt-1">Earn up to 15% APY</p></button> <button id="stocks-btn" class="rounded-lg sm:rounded-xl p-3 sm:p-4 md:p-5 hover-lift text-left" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
       <div class="action-icon mb-2 sm:mb-3" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
        <svg width="18" height="18" class="sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
       </div><p class="text-white font-semibold text-xs sm:text-sm">Stocks</p><p class="text-gray-400 text-xs mt-1">Trade &amp; Invest</p></button> <button id="transactions-btn" class="rounded-lg sm:rounded-xl p-3 sm:p-4 md:p-5 hover-lift text-left" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
       <div class="action-icon mb-2 sm:mb-3" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
        <svg width="18" height="18" class="sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
        </svg>
       </div><p class="text-white font-semibold text-xs sm:text-sm">Transactions</p><p class="text-gray-400 text-xs mt-1">History &amp; Records</p></button>
     </div><!-- Send Section -->
     <div class="rounded-xl md:rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <div class="flex items-center justify-between mb-4">
       <h3 class="text-white font-bold text-base sm:text-lg">Send Bitcoin</h3>
       <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
       </svg>
      </div>
      <form id="send-form" class="space-y-3">
       <div><label class="text-gray-400 text-xs sm:text-sm mb-1.5 block">Recipient Address</label> <input type="text" id="recipient-address" placeholder="bc1q..." required class="w-full px-3 sm:px-4 py-2.5 sm:py-3 text-white text-xs sm:text-sm outline-none transition-all focus:border-orange-500" style="background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 999px;">
       </div>
       <div class="grid grid-cols-2 gap-3">
        <div><label class="text-gray-400 text-xs sm:text-sm mb-1.5 block">Amount (BTC)</label> <input type="number" id="send-amount" step="0.00000001" min="0.00000001" placeholder="0.00000000" required class="w-full px-3 sm:px-4 py-2.5 sm:py-3 text-white text-xs sm:text-sm outline-none transition-all focus:border-orange-500" style="background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 999px;">
        </div>
        <div><label class="text-gray-400 text-xs sm:text-sm mb-1.5 block">USD Value</label> <input type="text" id="send-usd-value" readonly placeholder="$0.00" class="w-full px-3 sm:px-4 py-2.5 sm:py-3 text-gray-300 text-xs sm:text-sm outline-none" style="background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 999px;">
        </div>
       </div><button type="submit" class="w-full py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%); border-radius: 999px;"> Send Bitcoin </button>
      </form>
     </div><!-- Active Loan Section -->
     <div class="rounded-xl md:rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <div class="flex items-center justify-between mb-4">
       <h3 class="text-white font-bold text-base sm:text-lg">Active Loan</h3>
       <div id="active-loan-badge" class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> Active
       </div>
      </div>
      <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-4">
       <div class="rounded-lg p-3 sm:p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1.5">Loan Amount</p>
        <p id="loan-btc-amount" class="text-white text-lg sm:text-xl font-bold">0.0350 BTC</p>
       </div>
       <div class="rounded-lg p-3 sm:p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1.5">Collateral</p>
        <p id="collateral-btc-amount" class="text-white text-lg sm:text-xl font-bold">0.0500 BTC</p>
        <p id="collateral-usd-amount" class="text-gray-300 text-xs mt-0.5">$2,142.50</p>
       </div>
      </div>
      <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-4">
       <div class="rounded-lg p-3 sm:p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1.5">Days Until Due</p>
        <p id="days-until-due" class="text-white text-lg sm:text-xl font-bold">0 Days</p>
        <p id="due-date-display" class="text-gray-300 text-xs mt-0.5">Due: Jan 2, 2025</p>
       </div>
       <div class="rounded-lg p-3 sm:p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1.5">Loan-to-Value</p>
        <p class="text-white text-lg sm:text-xl font-bold">70%</p>
        <p class="text-gray-300 text-xs mt-0.5">Max LTV Ratio</p>
       </div>
      </div>
      <div class="rounded-lg p-3 sm:p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
       <div class="flex items-center justify-between mb-3"><span class="text-gray-400 text-xs">Repayment Progress</span> <span class="text-white font-semibold text-xs">0% Paid</span>
       </div>
       <div class="savings-progress-bar">
        <div class="savings-progress-fill" style="width: 0%;"></div>
       </div>
       <div class="flex items-center justify-between mt-2"><span class="text-gray-400 text-xs">Paid: 0.0000 BTC</span> <span class="text-gray-400 text-xs">Remaining: 0.0000 BTC</span>
       </div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-4">
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">Interest Rate</p>
        <p class="text-white font-bold text-sm">0.0% APY</p>
       </div>
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">Times Borrowed</p>
        <p class="text-white font-bold text-sm">0 Times</p>
       </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <button id="repayment-btn" class="w-full py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%); border-radius: 999px;">
          <svg width="18" height="18" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
          </svg> Repayment
        </button>
        <button id="withdraw-loan-btn" class="w-full py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift flex items-center justify-center gap-2" style="background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 999px;">
          <svg width="18" height="18" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg> Withdraw Loan
        </button>
        <button id="withdraw-collateral-btn" class="w-full py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift flex items-center justify-center gap-2" style="background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 999px;">
          <svg width="18" height="18" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg> Collateral
        </button>
      </div>
     </div><!-- Active Savings Portfolio Section -->
     <div class="rounded-xl md:rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <div class="flex items-center justify-between mb-4">
       <h3 class="text-white font-bold text-base sm:text-lg">Active Savings</h3>
       <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg> Active
       </div>
      </div>
      <div class="rounded-lg p-4 sm:p-5 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
       <div class="flex items-center justify-between mb-3"><span class="text-gray-400 text-xs">Locked Amount</span> <span class="text-white font-bold text-base sm:text-lg">0.0000 BTC</span>
       </div>
       <div class="flex items-center justify-between"><span class="text-gray-400 text-xs">Current Value</span> <span class="text-gray-300 text-sm">$0.00</span>
       </div>
      </div>
      <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-4">
       <div class="rounded-lg p-3 sm:p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1.5">Interest Earned</p>
        <p class="text-lg sm:text-xl font-bold" style="color: #ff6b35;">0.0000 BTC</p>
        <p class="text-gray-300 text-xs mt-0.5">$0.00</p>
       </div>
       <div class="rounded-lg p-3 sm:p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1.5">APY Rate</p>
        <p class="text-lg sm:text-xl font-bold" style="color: #ff6b35;">0.0%</p>
        <p class="text-gray-300 text-xs mt-0.5">0 Days Term</p>
       </div>
      </div>
      <div class="rounded-lg p-3 sm:p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
       <div class="flex items-center justify-between mb-3"><span class="text-gray-400 text-xs">Time Remaining</span> <span class="text-white font-semibold text-sm" id="days-remaining">0 Days</span>
       </div>
       <div class="savings-progress-bar mb-2">
        <div class="savings-progress-fill" style="width: 0%;"></div>
       </div>
       <div class="flex items-center justify-between"><span class="text-gray-400 text-xs" id="started-date">Started: N/A</span> <span class="text-gray-400 text-xs" id="maturity-date">Matures: N/A</span>
       </div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-4">
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">Total at Maturity</p>
        <p class="text-white font-bold text-sm">0.0000 BTC</p>
       </div>
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">Estimated Value</p>
        <p class="text-white font-bold text-sm">$4,049.02</p>
       </div>
      </div>
      <div class="rounded-lg p-3 mb-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
       <p class="text-xs leading-relaxed" style="color: #ff6b35;">
        <svg width="14" height="14" class="inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> Interest is compounded daily. Early withdrawal may result in penalty fees.</p>
      </div>
      <div class="grid grid-cols-2 gap-3"><button id="view-savings-details-btn" class="py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift flex items-center justify-center gap-2" style="background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 999px;">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> View Details </button> <button id="withdraw-savings-btn" class="py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%); border-radius: 999px;">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg> Withdraw Early </button>
      </div>
     </div><!-- Recent Transactions removed -->
    </div><!-- Settings Page -->
    <div id="settings-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home-settings" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Settings</h2>
      <p class="text-gray-400 text-sm">Manage your account preferences</p>
     </div><!-- Account Settings -->
     <div class="mb-4">
      <h3 class="text-white font-semibold text-base mb-3 px-2">Account</h3>
      <div class="rounded-xl overflow-hidden" style="background: #1a1a1a; border: 1px solid #2a2a2a;"><button id="edit-profile-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all" style="border-bottom: 1px solid #2a2a2a;">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
         </div>
         <div class="text-left">
          <p class="text-white font-semibold text-sm">Edit Profile</p>
          <p class="text-gray-400 text-xs">Update your personal information</p>
         </div>
        </div>
        <svg width="20" height="20" fill="none" stroke="#666666" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button> <button id="change-password-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all" style="border-bottom: 1px solid #2a2a2a;">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
          </svg>
         </div>
         <div class="text-left">
          <p class="text-white font-semibold text-sm">Change Password</p>
          <p class="text-gray-400 text-xs">Update your security credentials</p>
         </div>
        </div>
        <svg width="20" height="20" fill="none" stroke="#666666" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        <!-- Two-Factor Authentication settings entry removed -->
      </div>
     </div>
     <div class="mb-4">
      <h3 class="text-white font-semibold text-base mb-3 px-2">Notifications</h3>
      <div class="rounded-xl overflow-hidden" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
       <div class="p-4 flex items-center justify-between" style="border-bottom: 1px solid #2a2a2a;">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
         </div>
         <div class="text-left">
          <p class="text-white font-semibold text-sm">Push Notifications</p>
          <p class="text-gray-400 text-xs">Transaction alerts and updates</p>
         </div>
        </div><label class="relative inline-block w-12 h-6"> <input type="checkbox" id="push-notifications" checked class="sr-only peer">
         <div class="w-12 h-6 rounded-full peer transition-all cursor-pointer peer-checked:bg-gradient-to-r peer-checked:from-orange-500 peer-checked:to-red-500" style="background: #2a2a2a;"></div>
         <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-all peer-checked:translate-x-6"></div></label>
       </div>
       <div class="p-4 flex items-center justify-between" style="border-bottom: 1px solid #2a2a2a;">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
         </div>
         <div class="text-left">
          <p class="text-white font-semibold text-sm">Email Notifications</p>
          <p class="text-gray-400 text-xs">Weekly summaries and reports</p>
         </div>
        </div><label class="relative inline-block w-12 h-6"> <input type="checkbox" id="email-notifications" checked class="sr-only peer">
         <div class="w-12 h-6 rounded-full peer transition-all cursor-pointer peer-checked:bg-gradient-to-r peer-checked:from-orange-500 peer-checked:to-red-500" style="background: #2a2a2a;"></div>
         <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-all peer-checked:translate-x-6"></div></label>
       </div>
       <div class="p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
         </div>
         <div class="text-left">
          <p class="text-white font-semibold text-sm">SMS Alerts</p>
          <p class="text-gray-400 text-xs">Critical security notifications</p>
         </div>
        </div><label class="relative inline-block w-12 h-6"> <input type="checkbox" id="sms-notifications" class="sr-only peer">
         <div class="w-12 h-6 rounded-full peer transition-all cursor-pointer peer-checked:bg-gradient-to-r peer-checked:from-orange-500 peer-checked:to-red-500" style="background: #2a2a2a;"></div>
         <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-all peer-checked:translate-x-6"></div></label>
       </div>
      </div>
     </div><!-- Preferences -->
     <div class="mb-4">
      <h3 class="text-white font-semibold text-base mb-3 px-2">Preferences</h3>
      <div class="rounded-xl overflow-hidden" style="background: #1a1a1a; border: 1px solid #2a2a2a;"><button id="currency-settings-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all" style="border-bottom: 1px solid #2a2a2a;">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
         <div class="text-left">
          <p class="text-white font-semibold text-sm">Currency</p>
          <p class="text-gray-400 text-xs">USD - United States Dollar</p>
         </div>
        </div>
        <svg width="20" height="20" fill="none" stroke="#666666" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button> <button id="language-settings-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all" style="border-bottom: 1px solid #2a2a2a;">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
          </svg>
         </div>
         <div class="text-left">
          <p class="text-white font-semibold text-sm">Language</p>
          <p class="text-gray-400 text-xs">English (US)</p>
         </div>
        </div>
        <svg width="20" height="20" fill="none" stroke="#666666" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button>
      </div>
     </div><!-- Legal & Support -->
     <div class="mb-4">
      <h3 class="text-white font-semibold text-base mb-3 px-2">Legal &amp; Support</h3>
      <div class="rounded-xl overflow-hidden" style="background: #1a1a1a; border: 1px solid #2a2a2a;"><button id="terms-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all" style="border-bottom: 1px solid #2a2a2a;">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
         </div>
         <p class="text-white font-semibold text-sm">Terms of Service</p>
        </div>
        <svg width="20" height="20" fill="none" stroke="#666666" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button> <button id="privacy-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all" style="border-bottom: 1px solid #2a2a2a;">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
         </div>
         <p class="text-white font-semibold text-sm">Privacy Policy</p>
        </div>
        <svg width="20" height="20" fill="none" stroke="#666666" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button> <button id="help-center-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
         <p class="text-white font-semibold text-sm">Help Center</p>
        </div>
        <svg width="20" height="20" fill="none" stroke="#666666" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button>
      </div>
     </div><!-- Danger Zone -->
     <div class="mb-8">
      <h3 class="text-white font-semibold text-base mb-3 px-2"></h3>
      <div class="rounded-xl overflow-hidden" style="background: #1a1a1a; border: 1px solid rgba(239, 68, 68, 0.3);"><button id="logout-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all" style="border-bottom: 1px solid rgba(239, 68, 68, 0.2);">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(239, 68, 68, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
         </div>
         <p class="font-semibold text-sm" style="color: #ef4444;">Log Out</p>
        </div>
        <svg width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button> <button id="delete-account-btn" class="w-full p-4 flex items-center justify-between hover-lift transition-all">
        <div class="flex items-center gap-3">
         <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(239, 68, 68, 0.1);">
          <svg width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
         </div>
         <p class="font-semibold text-sm" style="color: #ef4444;">Delete Account</p>
        </div>
        <svg width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button>
      </div>
     </div>
     <p class="text-gray-400 text-xs text-center mb-6">App Version 2.4.1</p><br><br>
    </div><!-- Card Page -->
    <div id="card-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home-card" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Xapo Card</h2>
      <p class="text-gray-400 text-sm">Your Bitcoin-powered global debit card</p>
     </div><!-- Card Hero -->
     <div class="rounded-xl md:rounded-2xl p-6 sm:p-8 mb-6 text-center" style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border: 1px solid #3a3a3a;">
      <div class="w-full max-w-sm mx-auto mb-6 rounded-2xl p-6 sm:p-8 aspect-[1.586/1]" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">
       <div class="flex justify-between items-start mb-12">
        <svg width="48" height="48" fill="#fff" viewbox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z" />
        </svg>
        <div class="text-right text-white">
         <p class="text-xs opacity-80 mb-1">VALID THRU</p>
         <p class="text-sm font-semibold">12/27</p>
        </div>
       </div>
       <div class="text-left">
        <p class="text-white text-xl sm:text-2xl font-bold tracking-wider mb-4">•••• •••• •••• 4567</p>
        <div class="flex justify-between items-end">
         <div>
          <p class="text-white text-xs opacity-80 mb-1">CARDHOLDER</p>
          <p id="cardholder-name" class="text-white text-sm font-semibold">Loading...</p>
         </div>
         <div class="text-right w-24">
          <p class="text-white text-xs font-bold">XAPO</p>
         </div>
        </div>
       </div>
      </div>
      <h3 class="text-white font-bold text-2xl mb-2">The Xapo Card</h3>
      <p class="text-gray-400 text-sm mb-6">A debit card you can order via the app once you have completed the onboarding. The card will be sent directly to your Xapo registered address.</p><button id="order-card-btn" class="px-8 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Order Your Card</button>
     </div><!-- Benefits Section -->
     <div class="mb-6">
      <h3 class="text-white font-bold text-xl mb-4 px-2">Card Benefits</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
       <div class="rounded-xl p-5 hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
        <div class="w-12 h-12 rounded-full flex items-center justify-center mb-4" style="background: rgba(255, 107, 53, 0.1);">
         <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg>
        </div>
        <h4 class="text-white font-semibold text-base mb-2">Cashback in Bitcoin</h4>
        <p class="text-gray-400 text-sm">Earn Bitcoin rewards on every purchase you make with your Xapo Card</p>
       </div>
       <div class="rounded-xl p-5 hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
        <div class="w-12 h-12 rounded-full flex items-center justify-center mb-4" style="background: rgba(255, 107, 53, 0.1);">
         <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
         </svg>
        </div>
        <h4 class="text-white font-semibold text-base mb-2">Unlimited Free FX</h4>
        <p class="text-gray-400 text-sm">No foreign exchange fees when spending abroad - use it anywhere in the world</p>
       </div>
       <div class="rounded-xl p-5 hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
        <div class="w-12 h-12 rounded-full flex items-center justify-center mb-4" style="background: rgba(255, 107, 53, 0.1);">
         <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
         </svg>
        </div>
        <h4 class="text-white font-semibold text-base mb-2">High Spending Limits</h4>
        <p class="text-gray-400 text-sm">You are in control of your own spending limits - set them as high as you need</p>
       </div>
       <div class="rounded-xl p-5 hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
        <div class="w-12 h-12 rounded-full flex items-center justify-center mb-4" style="background: rgba(255, 107, 53, 0.1);">
         <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
         </svg>
        </div>
        <h4 class="text-white font-semibold text-base mb-2">Low ATM Fees</h4>
        <p class="text-gray-400 text-sm">Enjoy competitive ATM withdrawal fees worldwide for convenient cash access</p>
       </div>
       <div class="rounded-xl p-5 hover-lift sm:col-span-2" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
        <div class="w-12 h-12 rounded-full flex items-center justify-center mb-4" style="background: rgba(255, 107, 53, 0.1);">
         <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
         </svg>
        </div>
        <h4 class="text-white font-semibold text-base mb-2">Multi-Wallet Support</h4>
        <p class="text-gray-400 text-sm">Link your card to multiple wallets (USD and/or Bitcoin) for flexible spending</p>
       </div>
      </div>
     </div><!-- Delivery Information -->
     <div class="rounded-xl p-6 mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <div class="flex items-start gap-4">
       <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
        <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
       </div>
       <div class="flex-1">
        <h4 class="text-white font-semibold text-lg mb-2">Card Delivery Information</h4>
        <p class="text-gray-300 text-sm mb-3">We will only deliver the card to the verified address linked to your account.</p>
        <p class="text-gray-400 text-sm mb-4">If you want it delivered elsewhere, you will need to update your address in the Personal Information section of your profile.</p><button id="update-address-btn" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold transition-all hover-lift" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
         <svg width="16" height="16" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
         </svg> Update Delivery Address </button>
       </div>
      </div>
     </div><!-- Active Savings Portfolio Section -->
     <div class="rounded-xl md:rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <div class="flex items-center justify-between mb-4">
       <h3 class="text-white font-bold text-base sm:text-lg">Active Savings</h3>
       <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg> Active
       </div>
      </div>
      <div class="rounded-lg p-4 sm:p-5 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
       <div class="flex items-center justify-between mb-3"><span class="text-gray-400 text-xs">Locked Amount</span> <span class="text-white font-bold text-base sm:text-lg">0.0000 BTC</span>
       </div>
       <div class="flex items-center justify-between"><span class="text-gray-400 text-xs">Current Value</span> <span class="text-gray-300 text-sm">$0.00</span>
       </div>
      </div>
      <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-4">
       <div class="rounded-lg p-3 sm:p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1.5">Interest Earned</p>
        <p class="text-lg sm:text-xl font-bold" style="color: #ff6b35;">0.0000 BTC</p>
        <p class="text-gray-300 text-xs mt-0.5">$0.00</p>
       </div>
       <div class="rounded-lg p-3 sm:p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1.5">APY Rate</p>
        <p class="text-lg sm:text-xl font-bold" style="color: #ff6b35;">0.0%</p>
        <p class="text-gray-300 text-xs mt-0.5">0 Days Term</p>
       </div>
      </div>
      <div class="rounded-lg p-3 sm:p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
       <div class="flex items-center justify-between mb-3"><span class="text-gray-400 text-xs">Time Remaining</span> <span class="text-white font-semibold text-sm" id="days-remaining">0 Days</span>
       </div>
       <div class="savings-progress-bar mb-2">
        <div class="savings-progress-fill" style="width: 0%;"></div>
       </div>
       <div class="flex items-center justify-between"><span class="text-gray-400 text-xs" id="started-date">Started: N/A</span> <span class="text-gray-400 text-xs" id="maturity-date">Matures: N/A</span>
       </div>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-4">
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">Total at Maturity</p>
        <p class="text-white font-bold text-sm">0.0000 BTC</p>
       </div>
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">Estimated Value</p>
        <p class="text-white font-bold text-sm">$4,049.02</p>
       </div>
      </div>
      <div class="rounded-lg p-3 mb-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
       <p class="text-xs leading-relaxed" style="color: #ff6b35;">
        <svg width="14" height="14" class="inline mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> Interest is compounded daily. Early withdrawal may result in penalty fees.</p>
      </div>
      <div class="grid grid-cols-2 gap-3"><button id="view-savings-details-btn" class="py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift flex items-center justify-center gap-2" style="background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 999px;">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg> View Details </button> <button id="withdraw-savings-btn" class="py-2.5 sm:py-3 text-white font-bold text-xs sm:text-sm transition-all hover-lift flex items-center justify-center gap-2" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%); border-radius: 999px;">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg> Withdraw Early </button>
      </div>
     </div><!-- Recent Transactions removed -->
    </div><!-- Membership Page -->
    <div id="membership-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home-membership" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Premium Membership</h2>
      <p class="text-gray-400 text-sm">Unlock exclusive benefits and priority services</p>
     </div><!-- Hero Section -->
     <div class="text-center mb-8">
      <h3 class="text-white font-bold text-3xl sm:text-4xl mb-3">One Membership. Infinite Potential.</h3>
      <p class="text-gray-400 text-base sm:text-lg mb-6">See what sets us apart.</p>
     </div><!-- Comparison Table -->
     <div class="rounded-xl overflow-hidden mb-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr style="background: #0f0f0f;">
          <th class="text-left p-4 text-white font-semibold text-sm">Features</th>
          <th class="text-center p-4 text-gray-400 font-semibold text-sm">Exchanges</th>
          <th class="text-center p-4 text-gray-400 font-semibold text-sm">Hardware Wallets</th>
          <th class="text-center p-4 text-gray-400 font-semibold text-sm">Traditional Banks</th>
          <th class="text-center p-4 font-semibold text-sm" style="color: #ff6b35;">
           <div class="flex items-center justify-center gap-2">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg> Us
           </div></th>
         </tr>
        </thead>
        <tbody>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Secure Bitcoin Custody</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#22c55e" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#22c55e" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Daily Interest Paid in Bitcoin</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Global Debit Card with Zero FX Fees</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Buy and Sell with Best-in-Class Bitcoin Price</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#22c55e" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Bitcoin-Backed Loan</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Beneficiary Feature</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
     <div class="rounded-xl p-6 sm:p-8 mb-6 text-center" style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 69, 0, 0.1) 100%); border: 1px solid rgba(255, 107, 53, 0.3);">
      <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-6" style="background: rgba(255, 107, 53, 0.2);">
       <svg width="40" height="40" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
       </svg>
      </div>
      <h3 class="text-white font-bold text-4xl sm:text-5xl mb-2">$1,000</h3>
      <p class="text-gray-300 text-base mb-1">USD/year</p>
      <p class="text-gray-400 text-sm">Required for membership</p>
     </div><br><br>
     <div class="flex gap-3"><button id="cancel-membership" class="flex-1 py-3 sm:py-4 text-gray-300 font-bold text-sm sm:text-base rounded-xl transition-all hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">Cancel</button> <button id="apply-membership-page-btn" class="flex-1 py-3 sm:py-4 text-white font-bold text-sm sm:text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Apply Now</button>
     </div><br><br>
    </div><!-- Loans Page -->
    <div id="loans-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home-loans" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Bitcoin-Backed Loans</h2>
      <p class="text-gray-400 text-sm">Quick cash without selling your Bitcoin</p>
     </div><!-- Hero Section -->
     <div class="rounded-xl md:rounded-2xl p-6 sm:p-8 mb-6" style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 69, 0, 0.1) 100%); border: 1px solid rgba(255, 107, 53, 0.3);">
      <div class="text-center mb-6">
       <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4" style="background: rgba(255, 107, 53, 0.2);">
        <svg width="40" height="40" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
       </div>
       <h3 class="text-white font-bold text-2xl sm:text-3xl mb-3">Borrow Up to USD 1 Million Instantly</h3>
       <p class="text-gray-300 text-base mb-2">Zero fees • Cash in under a minute</p>
       <p class="text-gray-400 text-sm">Spend via debit cards, bank, or crypto transfer</p>
      </div><!-- Key Features Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
       <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
        <div class="flex items-start gap-3">
         <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.2);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
         <div>
          <p class="text-white font-semibold text-sm mb-1">Flexible Terms</p>
          <p class="text-gray-300 text-xs">30, 90, 180 or 365 days</p>
         </div>
        </div>
       </div>
       <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
        <div class="flex items-start gap-3">
         <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.2);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
         <div>
          <p class="text-white font-semibold text-sm mb-1">Low-Interest APR</p>
          <p class="text-gray-300 text-xs">No minimum installments</p>
         </div>
        </div>
       </div>
       <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
        <div class="flex items-start gap-3">
         <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.2);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
         <div>
          <p class="text-white font-semibold text-sm mb-1">Repay Anytime</p>
          <p class="text-gray-300 text-xs">In USD or BTC, no penalties</p>
         </div>
        </div>
       </div>
       <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
        <div class="flex items-start gap-3">
         <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.2);">
          <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
         </div>
         <div>
          <p class="text-white font-semibold text-sm mb-1">Instant Access</p>
          <p class="text-gray-300 text-xs">Cash arrives in under 1 minute</p>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Loan Calculator -->
     <div class="rounded-xl md:rounded-2xl p-6 sm:p-8 mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <h3 class="text-white font-bold text-xl mb-6">Loan Calculator</h3>
      <form id="loan-calculator-form" class="space-y-6"><!-- Collateral Amount -->
       <div><label class="text-gray-400 text-sm mb-2 block">Collateral Amount</label>
        <div class="grid grid-cols-2 gap-3 mb-3">
         <div><label class="text-gray-500 text-xs mb-1.5 block">BTC Amount</label> <input type="number" id="loan-collateral-amount" step="0.00000001" min="0.001" value="0" placeholder="0.00000000" class="w-full px-4 py-3 rounded-lg text-white text-base outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
         </div>
         <div><label class="text-gray-500 text-xs mb-1.5 block">USD Value</label> <input type="number" id="loan-collateral-usd" step="0.01" min="0" placeholder="0.00" class="w-full px-4 py-3 rounded-lg text-white text-base outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
         </div>
        </div><!-- Loan Amount Preview (70% LTV) -->
        <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
         <div class="flex justify-between items-center mb-2"><span class="text-gray-400 text-sm">Available Loan Amount (70% LTV)</span> <span id="available-loan-btc" class="text-white font-bold text-base">0.00000000 BTC</span>
         </div>
         <div class="flex justify-between items-center"><span class="text-gray-400 text-xs">USD Value</span> <span id="available-loan-usd" class="font-semibold text-sm" style="color: #ff6b35;">$0.00</span>
         </div>
        </div>
       </div><!-- Loan Period -->
       <div><label class="text-gray-400 text-sm mb-3 block">Loan Period</label>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3"><label class="loan-period-option cursor-pointer"> <input type="radio" name="loan-period" value="30" class="hidden loan-period-radio">
          <div class="rounded-lg p-4 text-center transition-all hover-lift" style="background: #0f0f0f; border: 2px solid #2a2a2a;">
           <p class="text-white font-bold text-xl mb-1">30</p>
           <p class="text-gray-400 text-xs">Days</p>
          </div></label> <label class="loan-period-option cursor-pointer"> <input type="radio" name="loan-period" value="90" class="hidden loan-period-radio">
          <div class="rounded-lg p-4 text-center transition-all hover-lift" style="background: #0f0f0f; border: 2px solid #2a2a2a;">
           <p class="text-white font-bold text-xl mb-1">90</p>
           <p class="text-gray-400 text-xs">Days</p>
          </div></label> <label class="loan-period-option cursor-pointer"> <input type="radio" name="loan-period" value="180" class="hidden loan-period-radio">
          <div class="rounded-lg p-4 text-center transition-all hover-lift" style="background: #0f0f0f; border: 2px solid #2a2a2a;">
           <p class="text-white font-bold text-xl mb-1">180</p>
           <p class="text-gray-400 text-xs">Days</p>
          </div></label> <label class="loan-period-option cursor-pointer"> <input type="radio" name="loan-period" value="365" checked class="hidden loan-period-radio">
          <div class="rounded-lg p-4 text-center transition-all hover-lift" style="background: rgba(255, 107, 53, 0.05); border: 2px solid #ff6b35;">
           <p class="text-white font-bold text-xl mb-1">365</p>
           <p class="text-gray-400 text-xs">Days</p>
          </div></label>
        </div>
       </div><button type="submit" class="w-full py-3 text-white font-bold text-base rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Calculate Loan</button>
      </form>
     </div><!-- Results Section -->
     <div id="loan-results" class="hidden rounded-xl md:rounded-2xl p-6 sm:p-8 mb-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <h3 class="text-white font-bold text-xl mb-6">Your Results</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
       <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-2">Period</p>
        <p id="result-period" class="text-white font-bold text-xl">365 days</p>
       </div>
       <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-2">Initial Loan-to-Value</p>
        <p id="result-ltv" class="text-white font-bold text-xl">50%</p>
       </div>
       <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-2">Annual Percentage Rate</p>
        <p id="result-apr" class="font-bold text-xl" style="color: #ff6b35;">10.50%</p>
       </div>
       <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-2">Annual Interest Rate</p>
        <p id="result-air" class="font-bold text-xl" style="color: #ff6b35;">10.50%</p>
       </div>
       <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-2">Xapo Bank Fees</p>
        <p id="result-fees" class="text-white font-bold text-xl">USD 0</p>
       </div>
       <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-2">Repayment Fees</p>
        <p id="result-repayment-fees" class="text-white font-bold text-xl">USD 0</p>
       </div>
       <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.3);">
        <p class="text-gray-400 text-xs mb-2">Estimated Variable Interest</p>
        <p id="result-interest" class="font-bold text-xl" style="color: #ff6b35;">USD 19,481.56</p>
       </div>
       <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.3);">
        <p class="text-gray-400 text-xs mb-2">Total Repayment</p>
        <p id="result-total" class="font-bold text-xl" style="color: #ff6b35;">USD 205,020.28</p>
       </div>
      </div><button id="apply-for-loan-btn" class="w-full py-3 text-white font-bold text-base rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Apply for Loan</button>
     </div><br><br>
    </div><!-- Membership Page -->
    <div id="membership-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home-membership" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Premium Membership</h2>
      <p class="text-gray-400 text-sm">Unlock exclusive benefits and priority services</p>
     </div><!-- Hero Section -->
     <div class="text-center mb-8">
      <h3 class="text-white font-bold text-3xl sm:text-4xl mb-3">One Membership. Infinite Potential.</h3>
      <p class="text-gray-400 text-base sm:text-lg mb-6">See what sets us apart.</p>
     </div><!-- Comparison Table -->
     <div class="rounded-xl overflow-hidden mb-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr style="background: #0f0f0f;">
          <th class="text-left p-4 text-white font-semibold text-sm">Features</th>
          <th class="text-center p-4 text-gray-400 font-semibold text-sm">Exchanges</th>
          <th class="text-center p-4 text-gray-400 font-semibold text-sm">Hardware Wallets</th>
          <th class="text-center p-4 text-gray-400 font-semibold text-sm">Traditional Banks</th>
          <th class="text-center p-4 font-semibold text-sm" style="color: #ff6b35;">
           <div class="flex items-center justify-center gap-2">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg> Us
           </div></th>
         </tr>
        </thead>
        <tbody>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Secure Bitcoin Custody</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#22c55e" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#22c55e" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Daily Interest Paid in Bitcoin</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Global Debit Card with Zero FX Fees</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Buy and Sell with Best-in-Class Bitcoin Price</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#22c55e" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Bitcoin-Backed Loan</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
         <tr style="border-top: 1px solid #2a2a2a;">
          <td class="p-4 text-white text-sm">Beneficiary Feature</td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
           </svg></td>
          <td class="text-center p-4">
           <svg class="inline" width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
           </svg></td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
     <div class="rounded-xl p-6 sm:p-8 mb-6 text-center" style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.1) 0%, rgba(255, 69, 0, 0.1) 100%); border: 1px solid rgba(255, 107, 53, 0.3);">
      <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-6" style="background: rgba(255, 107, 53, 0.2);">
       <svg width="40" height="40" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
       </svg>
      </div>
      <h3 class="text-white font-bold text-4xl sm:text-5xl mb-2">$1,000</h3>
      <p class="text-gray-300 text-base mb-1">USD/year</p>
      <p class="text-gray-400 text-sm">Required for membership</p>
     </div><br><br>
     <div class="flex gap-3"><button id="cancel-membership" class="flex-1 py-3 sm:py-4 text-gray-300 font-bold text-sm sm:text-base rounded-xl transition-all hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">Cancel</button> <button id="apply-membership-page-btn" class="flex-1 py-3 sm:py-4 text-white font-bold text-sm sm:text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Apply Now</button>
     </div><br><br>
    </div><!-- Exchange Page -->
    <div id="exchange-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home-exchange" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Exchange Crypto</h2>
      <p class="text-gray-400 text-sm">Swap between different cryptocurrencies instantly</p>
     </div>
     <form id="exchange-form" class="space-y-6"><!-- From Section -->
      <div><label class="text-gray-400 text-sm mb-2 block">From</label>
       <div class="rounded-lg p-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
        <div class="flex items-center justify-between mb-3"><select id="from-crypto" class="text-white font-semibold text-base outline-none cursor-pointer" style="background: #1a1a1a; padding: 8px 12px; border-radius: 8px; border: 1px solid #2a2a2a;"> <option value="BTC" selected style="background: #0f0f0f; color: white;">Bitcoin (BTC)</option> <option value="ETH" style="background: #0f0f0f; color: white;">Ethereum (ETH)</option> <option value="BNB" style="background: #0f0f0f; color: white;">Binance Coin (BNB)</option> <option value="XRP" style="background: #0f0f0f; color: white;">Ripple (XRP)</option> <option value="ADA" style="background: #0f0f0f; color: white;">Cardano (ADA)</option> <option value="SOL" style="background: #0f0f0f; color: white;">Solana (SOL)</option> <option value="DOGE" style="background: #0f0f0f; color: white;">Dogecoin (DOGE)</option> <option value="DOT" style="background: #0f0f0f; color: white;">Polkadot (DOT)</option> <option value="MATIC" style="background: #0f0f0f; color: white;">Polygon (MATIC)</option> <option value="LTC" style="background: #0f0f0f; color: white;">Litecoin (LTC)</option> <option value="SHIB" style="background: #0f0f0f; color: white;">Shiba Inu (SHIB)</option> <option value="TRX" style="background: #0f0f0f; color: white;">Tron (TRX)</option> <option value="AVAX" style="background: #0f0f0f; color: white;">Avalanche (AVAX)</option> <option value="UNI" style="background: #0f0f0f; color: white;">Uniswap (UNI)</option> <option value="LINK" style="background: #0f0f0f; color: white;">Chainlink (LINK)</option> <option value="ATOM" style="background: #0f0f0f; color: white;">Cosmos (ATOM)</option> <option value="XLM" style="background: #0f0f0f; color: white;">Stellar (XLM)</option> <option value="ALGO" style="background: #0f0f0f; color: white;">Algorand (ALGO)</option> <option value="VET" style="background: #0f0f0f; color: white;">VeChain (VET)</option> <option value="ICP" style="background: #0f0f0f; color: white;">Internet Computer (ICP)</option> <option value="FIL" style="background: #0f0f0f; color: white;">Filecoin (FIL)</option> <option value="NEAR" style="background: #0f0f0f; color: white;">NEAR Protocol (NEAR)</option> <option value="APT" style="background: #0f0f0f; color: white;">Aptos (APT)</option> <option value="HBAR" style="background: #0f0f0f; color: white;">Hedera (HBAR)</option> <option value="QNT" style="background: #0f0f0f; color: white;">Quant (QNT)</option> <option value="ARB" style="background: #0f0f0f; color: white;">Arbitrum (ARB)</option> <option value="OP" style="background: #0f0f0f; color: white;">Optimism (OP)</option> <option value="INJ" style="background: #0f0f0f; color: white;">Injective (INJ)</option> <option value="MKR" style="background: #0f0f0f; color: white;">Maker (MKR)</option> <option value="AAVE" style="background: #0f0f0f; color: white;">Aave (AAVE)</option> <option value="CRV" style="background: #0f0f0f; color: white;">Curve DAO (CRV)</option> <option value="USD" style="background: #0f0f0f; color: white;">US Dollar (USD)</option> <option value="EUR" style="background: #0f0f0f; color: white;">Euro (EUR)</option> <option value="GBP" style="background: #0f0f0f; color: white;">British Pound (GBP)</option> <option value="JPY" style="background: #0f0f0f; color: white;">Japanese Yen (JPY)</option> <option value="AUD" style="background: #0f0f0f; color: white;">Australian Dollar (AUD)</option> <option value="CAD" style="background: #0f0f0f; color: white;">Canadian Dollar (CAD)</option> <option value="CHF" style="background: #0f0f0f; color: white;">Swiss Franc (CHF)</option> <option value="CNY" style="background: #0f0f0f; color: white;">Chinese Yuan (CNY)</option> <option value="INR" style="background: #0f0f0f; color: white;">Indian Rupee (INR)</option> <option value="BRL" style="background: #0f0f0f; color: white;">Brazilian Real (BRL)</option> <option value="MXN" style="background: #0f0f0f; color: white;">Mexican Peso (MXN)</option> <option value="KRW" style="background: #0f0f0f; color: white;">South Korean Won (KRW)</option> <option value="SGD" style="background: #0f0f0f; color: white;">Singapore Dollar (SGD)</option> </select> <span id="from-balance" class="text-gray-400 text-xs">Balance: 0.0547 BTC</span>
        </div><input type="number" id="from-amount" step="0.00000001" min="0" placeholder="0.00" class="w-full bg-transparent text-white text-2xl font-bold outline-none">
        <p id="from-usd-value" class="text-gray-400 text-sm mt-2">≈ $0.00</p>
       </div>
      </div><!-- Swap Button -->
      <div class="flex justify-center"><button type="button" id="swap-direction" class="w-12 h-12 rounded-full flex items-center justify-center transition-all hover-lift" style="background: rgba(255, 107, 53, 0.1); border: 2px solid #2a2a2a;">
        <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
        </svg></button>
      </div><!-- To Section -->
      <div><label class="text-gray-400 text-sm mb-2 block">To</label>
       <div class="rounded-lg p-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
        <div class="flex items-center justify-between mb-3"><select id="to-crypto" class="text-white font-semibold text-base outline-none cursor-pointer" style="background: #1a1a1a; padding: 8px 12px; border-radius: 8px; border: 1px solid #2a2a2a;"> <option value="BTC" style="background: #0f0f0f; color: white;">Bitcoin (BTC)</option> <option value="ETH" selected style="background: #0f0f0f; color: white;">Ethereum (ETH)</option> <option value="BNB" style="background: #0f0f0f; color: white;">Binance Coin (BNB)</option> <option value="XRP" style="background: #0f0f0f; color: white;">Ripple (XRP)</option> <option value="ADA" style="background: #0f0f0f; color: white;">Cardano (ADA)</option> <option value="SOL" style="background: #0f0f0f; color: white;">Solana (SOL)</option> <option value="DOGE" style="background: #0f0f0f; color: white;">Dogecoin (DOGE)</option> <option value="DOT" style="background: #0f0f0f; color: white;">Polkadot (DOT)</option> <option value="MATIC" style="background: #0f0f0f; color: white;">Polygon (MATIC)</option> <option value="LTC" style="background: #0f0f0f; color: white;">Litecoin (LTC)</option> <option value="SHIB" style="background: #0f0f0f; color: white;">Shiba Inu (SHIB)</option> <option value="TRX" style="background: #0f0f0f; color: white;">Tron (TRX)</option> <option value="AVAX" style="background: #0f0f0f; color: white;">Avalanche (AVAX)</option> <option value="UNI" style="background: #0f0f0f; color: white;">Uniswap (UNI)</option> <option value="LINK" style="background: #0f0f0f; color: white;">Chainlink (LINK)</option> <option value="ATOM" style="background: #0f0f0f; color: white;">Cosmos (ATOM)</option> <option value="XLM" style="background: #0f0f0f; color: white;">Stellar (XLM)</option> <option value="ALGO" style="background: #0f0f0f; color: white;">Algorand (ALGO)</option> <option value="VET" style="background: #0f0f0f; color: white;">VeChain (VET)</option> <option value="ICP" style="background: #0f0f0f; color: white;">Internet Computer (ICP)</option> <option value="FIL" style="background: #0f0f0f; color: white;">Filecoin (FIL)</option> <option value="NEAR" style="background: #0f0f0f; color: white;">NEAR Protocol (NEAR)</option> <option value="APT" style="background: #0f0f0f; color: white;">Aptos (APT)</option> <option value="HBAR" style="background: #0f0f0f; color: white;">Hedera (HBAR)</option> <option value="QNT" style="background: #0f0f0f; color: white;">Quant (QNT)</option> <option value="ARB" style="background: #0f0f0f; color: white;">Arbitrum (ARB)</option> <option value="OP" style="background: #0f0f0f; color: white;">Optimism (OP)</option> <option value="INJ" style="background: #0f0f0f; color: white;">Injective (INJ)</option> <option value="MKR" style="background: #0f0f0f; color: white;">Maker (MKR)</option> <option value="AAVE" style="background: #0f0f0f; color: white;">Aave (AAVE)</option> <option value="CRV" style="background: #0f0f0f; color: white;">Curve DAO (CRV)</option> <option value="USD" style="background: #0f0f0f; color: white;">US Dollar (USD)</option> <option value="EUR" style="background: #0f0f0f; color: white;">Euro (EUR)</option> <option value="GBP" style="background: #0f0f0f; color: white;">British Pound (GBP)</option> <option value="JPY" style="background: #0f0f0f; color: white;">Japanese Yen (JPY)</option> <option value="AUD" style="background: #0f0f0f; color: white;">Australian Dollar (AUD)</option> <option value="CAD" style="background: #0f0f0f; color: white;">Canadian Dollar (CAD)</option> <option value="CHF" style="background: #0f0f0f; color: white;">Swiss Franc (CHF)</option> <option value="CNY" style="background: #0f0f0f; color: white;">Chinese Yuan (CNY)</option> <option value="INR" style="background: #0f0f0f; color: white;">Indian Rupee (INR)</option> <option value="BRL" style="background: #0f0f0f; color: white;">Brazilian Real (BRL)</option> <option value="MXN" style="background: #0f0f0f; color: white;">Mexican Peso (MXN)</option> <option value="KRW" style="background: #0f0f0f; color: white;">South Korean Won (KRW)</option> <option value="SGD" style="background: #0f0f0f; color: white;">Singapore Dollar (SGD)</option> </select> <span id="to-balance" class="text-gray-400 text-xs">Balance: 0.00 ETH</span>
        </div><input type="text" id="to-amount" readonly placeholder="0.00" class="w-full bg-transparent text-white text-2xl font-bold outline-none">
        <p id="to-usd-value" class="text-gray-400 text-sm mt-2">≈ $0.00</p>
       </div>
      </div><!-- Exchange Rate Info -->
      <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
       <div class="flex items-center justify-between mb-2"><span class="text-gray-400 text-xs">Exchange Rate</span> <span id="exchange-rate" class="text-white font-semibold text-sm">1 BTC = 19.08 ETH</span>
       </div>
       <div class="flex items-center justify-between mb-2"><span class="text-gray-400 text-xs">Network Fee</span> <span class="text-white font-semibold text-sm">0.0001 BTC</span>
       </div>
       <div class="flex items-center justify-between"><span class="text-gray-400 text-xs">Exchange Fee</span> <span class="font-semibold text-sm" style="color: #ff6b35;">0% (Free)</span>
       </div>
      </div><button type="submit" class="w-full py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);"> Preview Exchange </button>
     </form><br><br>
    </div><!-- Stocks Page -->
    <div id="stocks-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home-stocks" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Stock Trading</h2>
      <p class="text-gray-400 text-sm">Buy and sell stocks with zero commission fees</p>
     </div><!-- My Portfolio -->
     <div class="rounded-xl md:rounded-2xl p-4 sm:p-6 mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <h3 class="text-white font-bold text-base sm:text-lg mb-4">My Portfolio</h3>
      <div class="rounded-lg p-5 mb-4 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
       <p class="text-gray-400 text-xs mb-2">Total Portfolio Value</p>
       <p class="text-white font-bold text-3xl mb-2">$0.00</p>
      </div>
      <div class="space-y-3" id="portfolio-list">
      </div>
     </div><!-- Market Overview -->
     <div class="rounded-xl md:rounded-2xl p-4 sm:p-6 mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <h3 class="text-white font-bold text-base sm:text-lg mb-4">Market Overview</h3>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">

       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">S&amp;P 500</p>
        <p class="text-white font-bold text-base text-right">4,783.45</p>
        <p class="text-xs font-semibold mt-1 text-right" style="color: #22c55e;">+1.2%</p>
       </div>
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">NASDAQ</p>
        <p class="text-white font-bold text-base text-right">15,011.35</p>
        <p class="text-xs font-semibold mt-1 text-right" style="color: #22c55e;">+0.8%</p>
       </div>
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">Dow Jones</p>
        <p class="text-white font-bold text-base text-right">37,545.33</p>
        <p class="text-xs font-semibold mt-1 text-right" style="color: #ef4444;">-0.3%</p>
       </div>
       <div class="rounded-lg p-3 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
        <p class="text-gray-400 text-xs mb-1">Russell 2000</p>
        <p class="text-white font-bold text-base text-right">2,089.17</p>
        <p class="text-xs font-semibold mt-1 text-right" style="color: #22c55e;">+0.5%</p>
       </div>
      </div>
     </div>
     
     
     
     
     
     
     <!-- Popular Stocks -->
     <div class="rounded-xl md:rounded-2xl p-4 sm:p-6 mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      <h3 class="text-white font-bold text-base sm:text-lg mb-4">Popular Stocks</h3>
      <div id="popular-list" class="space-y-3">
        
        <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="AAPL" data-name="Apple Inc." data-price="185.92" data-change="+2.4">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">AAPL</p>
           <p class="text-gray-400 text-xs">Apple Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$185.92</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+2.4%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="MSFT" data-name="Microsoft Corporation" data-price="378.91" data-change="+1.8">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">MSFT</p>
           <p class="text-gray-400 text-xs">Microsoft Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$378.91</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.8%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="GOOGL" data-name="Alphabet Inc." data-price="141.80" data-change="+0.9">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">GOOGL</p>
           <p class="text-gray-400 text-xs">Alphabet Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$141.80</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.9%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="TSLA" data-name="Tesla Inc." data-price="248.48" data-change="-1.2">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">TSLA</p>
           <p class="text-gray-400 text-xs">Tesla Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$248.48</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-1.2%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="AMZN" data-name="Amazon.com Inc." data-price="151.94" data-change="+1.5">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">AMZN</p>
           <p class="text-gray-400 text-xs">Amazon.com Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$151.94</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.5%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="NVDA" data-name="NVIDIA Corporation" data-price="495.22" data-change="+3.1">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">NVDA</p>
           <p class="text-gray-400 text-xs">NVIDIA Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$495.22</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+3.1%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="META" data-name="Meta Platforms Inc." data-price="352.89" data-change="+2.1">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">META</p>
           <p class="text-gray-400 text-xs">Meta Platforms Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$352.89</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+2.1%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="NFLX" data-name="Netflix Inc." data-price="485.73" data-change="+1.9">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">NFLX</p>
           <p class="text-gray-400 text-xs">Netflix Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$485.73</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.9%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="AMD" data-name="Advanced Micro Devices" data-price="148.56" data-change="+2.8">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">AMD</p>
           <p class="text-gray-400 text-xs">Advanced Micro Devices</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$148.56</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+2.8%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="DIS" data-name="The Walt Disney Company" data-price="93.24" data-change="+1.3">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">DIS</p>
           <p class="text-gray-400 text-xs">The Walt Disney Company</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$93.24</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.3%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="V" data-name="Visa Inc." data-price="267.45" data-change="+0.9">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">V</p>
           <p class="text-gray-400 text-xs">Visa Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$267.45</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.9%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="JPM" data-name="JPMorgan Chase &amp; Co." data-price="152.38" data-change="+1.1">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">JPM</p>
           <p class="text-gray-400 text-xs">JPMorgan Chase &amp; Co.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$152.38</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.1%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="NKE" data-name="Nike Inc." data-price="106.87" data-change="-0.5">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">NKE</p>
           <p class="text-gray-400 text-xs">Nike Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$106.87</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-0.5%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="PYPL" data-name="PayPal Holdings Inc." data-price="63.24" data-change="+1.7">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">PYPL</p>
           <p class="text-gray-400 text-xs">PayPal Holdings Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$63.24</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.7%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="INTC" data-name="Intel Corporation" data-price="43.78" data-change="-0.8">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">INTC</p>
           <p class="text-gray-400 text-xs">Intel Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$43.78</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-0.8%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="CSCO" data-name="Cisco Systems Inc." data-price="51.23" data-change="+0.6">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">CSCO</p>
           <p class="text-gray-400 text-xs">Cisco Systems Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$51.23</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.6%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="PEP" data-name="PepsiCo Inc." data-price="169.85" data-change="+1.1">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">PEP</p>
           <p class="text-gray-400 text-xs">PepsiCo Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$169.85</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.1%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="KO" data-name="The Coca-Cola Company" data-price="59.47" data-change="+0.4">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">KO</p>
           <p class="text-gray-400 text-xs">The Coca-Cola Company</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$59.47</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.4%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="ADBE" data-name="Adobe Inc." data-price="562.94" data-change="+2.3">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">ADBE</p>
           <p class="text-gray-400 text-xs">Adobe Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$562.94</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+2.3%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="CRM" data-name="Salesforce Inc." data-price="264.18" data-change="+1.4">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">CRM</p>
           <p class="text-gray-400 text-xs">Salesforce Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$264.18</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.4%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="ORCL" data-name="Oracle Corporation" data-price="112.56" data-change="+0.9">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">ORCL</p>
           <p class="text-gray-400 text-xs">Oracle Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$112.56</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.9%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="BA" data-name="The Boeing Company" data-price="218.35" data-change="-1.3">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">BA</p>
           <p class="text-gray-400 text-xs">The Boeing Company</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$218.35</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-1.3%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="WMT" data-name="Walmart Inc." data-price="162.78" data-change="+0.7">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">WMT</p>
           <p class="text-gray-400 text-xs">Walmart Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$162.78</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.7%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="COST" data-name="Costco Wholesale Corporation" data-price="658.42" data-change="+1.2">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">COST</p>
           <p class="text-gray-400 text-xs">Costco Wholesale Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$658.42</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.2%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="HD" data-name="The Home Depot Inc." data-price="341.67" data-change="+0.8">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">HD</p>
           <p class="text-gray-400 text-xs">The Home Depot Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$341.67</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.8%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="MCD" data-name="McDonald's Corporation" data-price="294.53" data-change="-0.3">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">MCD</p>
           <p class="text-gray-400 text-xs">McDonald's Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$294.53</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-0.3%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="SBUX" data-name="Starbucks Corporation" data-price="98.76" data-change="+1.5">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">SBUX</p>
           <p class="text-gray-400 text-xs">Starbucks Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$98.76</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.5%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="UNH" data-name="UnitedHealth Group Inc." data-price="528.91" data-change="+0.9">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">UNH</p>
           <p class="text-gray-400 text-xs">UnitedHealth Group Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$528.91</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.9%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="PFE" data-name="Pfizer Inc." data-price="28.34" data-change="-0.6">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">PFE</p>
           <p class="text-gray-400 text-xs">Pfizer Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$28.34</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-0.6%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="TMO" data-name="Thermo Fisher Scientific Inc." data-price="547.82" data-change="+1.8">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">TMO</p>
           <p class="text-gray-400 text-xs">Thermo Fisher Scientific Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$547.82</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.8%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="BABA" data-name="Alibaba Group Holding Limited" data-price="76.89" data-change="+2.4">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">BABA</p>
           <p class="text-gray-400 text-xs">Alibaba Group Holding Limited</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$76.89</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+2.4%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="ABNB" data-name="Airbnb Inc." data-price="134.56" data-change="+1.9">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">ABNB</p>
           <p class="text-gray-400 text-xs">Airbnb Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$134.56</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.9%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="IBM" data-name="International Business Machines Corporation" data-price="192.45" data-change="+0.8">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">IBM</p>
           <p class="text-gray-400 text-xs">International Business Machines Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$192.45</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.8%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="JNJ" data-name="Johnson &amp; Johnson" data-price="156.78" data-change="+0.5">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">JNJ</p>
           <p class="text-gray-400 text-xs">Johnson &amp; Johnson</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$156.78</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.5%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="XOM" data-name="Exxon Mobil Corporation" data-price="118.92" data-change="-0.9">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">XOM</p>
           <p class="text-gray-400 text-xs">Exxon Mobil Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$118.92</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-0.9%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="CVX" data-name="Chevron Corporation" data-price="162.34" data-change="-1.1">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">CVX</p>
           <p class="text-gray-400 text-xs">Chevron Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$162.34</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-1.1%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="WFC" data-name="Wells Fargo &amp; Company" data-price="57.89" data-change="+0.3">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">WFC</p>
           <p class="text-gray-400 text-xs">Wells Fargo &amp; Company</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$57.89</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.3%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="BAC" data-name="Bank of America Corporation" data-price="39.67" data-change="+0.7">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">BAC</p>
           <p class="text-gray-400 text-xs">Bank of America Corporation</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$39.67</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.7%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="GS" data-name="The Goldman Sachs Group Inc." data-price="412.56" data-change="+1.2">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">GS</p>
           <p class="text-gray-400 text-xs">The Goldman Sachs Group Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$412.56</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+1.2%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="MS" data-name="Morgan Stanley" data-price="98.34" data-change="+0.9">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">MS</p>
           <p class="text-gray-400 text-xs">Morgan Stanley</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$98.34</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.9%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="C" data-name="Citigroup Inc." data-price="61.23" data-change="+0.4">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">C</p>
           <p class="text-gray-400 text-xs">Citigroup Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$61.23</p>
          <p class="text-xs font-semibold text-right" style="color: #22c55e;">+0.4%</p>
         </div>
        </div></button> <button class="stock-item w-full p-4 rounded-lg text-left transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;" data-symbol="T" data-name="AT&amp;T Inc." data-price="18.45" data-change="-0.2">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
           <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
           </svg>
          </div>
          <div>
           <p class="text-white font-bold text-sm">T</p>
           <p class="text-gray-400 text-xs">AT&amp;T Inc.</p>
          </div>
         </div>
         <div class="text-right w-24">
          <p class="text-white font-bold text-base text-right">$18.45</p>
          <p class="text-xs font-semibold text-right" style="color: #ef4444;">-0.2%</p>
         </div>
        </div></button>
      </div>
     </div>
     <br>
     <br>
    </div>
    
    
    
    <!-- Savings Page -->
    <div id="savings-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Bitcoin Savings Plans</h2>
      <p class="text-gray-400 text-sm">Lock your Bitcoin and earn guaranteed returns</p>
     </div>
     <form id="savings-form">
      <div class="mb-6"><label class="text-gray-400 text-sm mb-3 block">Choose Your Savings Term</label>
       <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3"><label class="savings-plan-option cursor-pointer"> <input type="radio" name="savings-term" value="30" data-apy="5.5" class="hidden savings-radio">
         <div class="rounded-lg p-4 text-center transition-all hover-lift" style="background: #1a1a1a; border: 2px solid #2a2a2a;">
          <p class="text-white font-bold text-2xl mb-1">30</p>
          <p class="text-gray-400 text-xs mb-2">Days</p>
          <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
           5.5% APY
          </div>
         </div></label> <label class="savings-plan-option cursor-pointer"> <input type="radio" name="savings-term" value="60" data-apy="7.2" class="hidden savings-radio">
         <div class="rounded-lg p-4 text-center transition-all hover-lift" style="background: #1a1a1a; border: 2px solid #2a2a2a;">
          <p class="text-white font-bold text-2xl mb-1">60</p>
          <p class="text-gray-400 text-xs mb-2">Days</p>
          <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
           7.2% APY
          </div>
         </div></label> <label class="savings-plan-option cursor-pointer"> <input type="radio" name="savings-term" value="90" data-apy="9.8" class="hidden savings-radio">
         <div class="rounded-lg p-4 text-center transition-all hover-lift" style="background: #1a1a1a; border: 2px solid #2a2a2a;">
          <p class="text-white font-bold text-2xl mb-1">90</p>
          <p class="text-gray-400 text-xs mb-2">Days</p>
          <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
           9.8% APY
          </div>
         </div></label> <label class="savings-plan-option cursor-pointer"> <input type="radio" name="savings-term" value="180" data-apy="12.5" class="hidden savings-radio">
         <div class="rounded-lg p-4 text-center transition-all hover-lift" style="background: #1a1a1a; border: 2px solid #2a2a2a;">
          <p class="text-white font-bold text-2xl mb-1">180</p>
          <p class="text-gray-400 text-xs mb-2">Days</p>
          <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
           0.0% APY
          </div>
         </div></label> <label class="savings-plan-option cursor-pointer"> <input type="radio" name="savings-term" value="360" data-apy="15.0" class="hidden savings-radio">
         <div class="rounded-lg p-4 text-center transition-all hover-lift relative overflow-hidden" style="background: #1a1a1a; border: 2px solid #2a2a2a;">
          <div class="absolute top-2 right-2 px-2 py-0.5 rounded text-xs font-bold" style="background: #ff6b35; color: white;">
           BEST
          </div>
          <p class="text-white font-bold text-2xl mb-1">360</p>
          <p class="text-gray-400 text-xs mb-2">Days</p>
          <div class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
           15.0% APY
          </div>
         </div></label>
       </div>
      </div>
      <div class="mb-6"><label class="text-gray-400 text-sm mb-2 block">Amount to Save (BTC)</label> <input type="number" id="savings-amount" step="0.00000001" min="0.001" placeholder="0.00000000" required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none transition-all" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      </div>
      <div class="mb-6"><label class="text-gray-400 text-sm mb-2 block">USD Value</label> <input type="text" id="savings-usd-value" readonly placeholder="$0.00" class="w-full px-4 py-3 rounded-lg text-gray-300 text-sm outline-none" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
      </div>
      <div id="savings-projection" class="hidden rounded-xl p-5 mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
       <h4 class="text-white font-semibold text-base mb-4">Your Earnings Projection</h4>
       <div class="grid grid-cols-2 gap-4">
        <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
         <p class="text-gray-400 text-xs mb-1">Initial Deposit</p>
         <p id="initial-deposit" class="text-white font-bold text-base">0.00000000 BTC</p>
        </div>
        <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
         <p class="text-gray-400 text-xs mb-1">Interest Earned</p>
         <p id="interest-earned" class="font-bold text-base" style="color: #ff6b35;">0.00000000 BTC</p>
        </div>
        <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
         <p class="text-gray-400 text-xs mb-1">Total at Maturity</p>
         <p id="total-maturity" class="text-white font-bold text-base">0.00000000 BTC</p>
        </div>
        <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
         <p class="text-gray-400 text-xs mb-1">APY Rate</p>
         <p id="apy-rate" class="font-bold text-base" style="color: #ff6b35;">0%</p>
        </div>
       </div>
      </div>
      <div class="rounded-xl p-5 mb-6" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
       <div class="flex items-start gap-3">
        <svg width="20" height="20" class="flex-shrink-0 mt-0.5" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
         <p class="text-white text-sm font-semibold mb-2">Important Information</p>
         <ul class="text-gray-400 text-xs space-y-1 leading-relaxed">
          <li>• Your Bitcoin will be locked for the selected term</li>
          <li>• Interest is compounded daily and paid at maturity</li>
          <li>• Early withdrawal may result in penalty fees</li>
          <li>• Funds are protected and fully insured</li>
         </ul>
        </div>
       </div>
      </div><br><br>
      <div class="flex gap-3"><button type="button" id="cancel-savings" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg transition-all hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">Cancel</button> <button type="submit" id="start-saving-btn" disabled class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%); opacity: 0.5;">Start Saving</button>
      </div><br><br>
     </form>
    </div><!-- Transactions Page -->
    <div id="transactions-page" class="hidden max-w-7xl mx-auto">
     <div class="mb-6"><button id="back-to-home-from-transactions" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-4">
       <svg width="20" height="20" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
       </svg><span class="text-sm font-medium">Back to Home</span> </button>
      <h2 class="text-white font-bold text-2xl sm:text-3xl mb-2">Transaction History</h2>
      <p class="text-gray-400 text-sm">View all your recent transactions and activity</p>
     </div>
     <div class="space-y-4">
      <div class="rounded-xl p-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
       <div class="flex items-center justify-between mb-3">
        <h3 class="text-white font-semibold text-lg">Recent Transactions</h3>
        <div class="flex gap-2">
         <button class="transaction-filter-btn px-3 py-1 text-xs rounded-lg transition-all active-filter" data-filter="all" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">All</button>
         <button class="transaction-filter-btn px-3 py-1 text-xs text-gray-400 rounded-lg hover:text-white transition-all" data-filter="deposit">Deposits</button>
         <button class="transaction-filter-btn px-3 py-1 text-xs text-gray-400 rounded-lg hover:text-white transition-all" data-filter="withdrawal">Withdrawals</button>
        </div>
       </div>
       <div class="space-y-3 transactions-list-container"></div>
      </div>
     </div>
    </div>
    <div style="height:24px;" aria-hidden="true"></div>
   </main><!-- Bottom Navigation -->
   <nav class="fixed bottom-0 left-0 right-0 border-t border-gray-800 px-4 py-3 z-50" style="background: #111111;">
    <div class="max-w-7xl mx-auto flex justify-around items-center"><button id="home-nav-btn" class="nav-btn flex flex-col items-center gap-1 transition-colors active">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg><span class="text-xs font-medium">Home</span> </button> <button id="card-btn" class="nav-btn flex flex-col items-center gap-1 transition-colors">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg><span class="text-xs font-medium">Card</span> </button> <button id="loans-btn" class="nav-btn flex flex-col items-center gap-1 transition-colors">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg><span class="text-xs font-medium">Loans</span> </button> <button id="membership-btn" class="nav-btn flex flex-col items-center gap-1 transition-colors">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
      </svg><span class="text-xs font-medium">Membership</span> </button> <button id="settings-btn" class="nav-btn flex flex-col items-center gap-1 transition-colors">
      <svg width="24" height="24" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg><span class="text-xs font-medium">Settings</span> </button>
    </div>
   </nav>
  </div>
  <script>
    // Cryptocurrency prices
    const cryptoPrices = {
      BTC: 42000,
      ETH: 2245.30,
      BNB: 308.50,
      XRP: 0.52,
      ADA: 0.38,
      SOL: 98.75,
      DOGE: 0.08,
      DOT: 5.12,
      MATIC: 0.78,
      LTC: 73.45,
      SHIB: 0.000008,
      TRX: 0.10,
      AVAX: 36.20,
      UNI: 6.45,
      LINK: 14.85,
      ATOM: 9.32,
      XLM: 0.12,
      ALGO: 0.18,
      VET: 0.02,
      ICP: 4.82,
      FIL: 3.95,
      NEAR: 1.68,
      APT: 9.12,
      HBAR: 0.06,
      QNT: 105.30,
      ARB: 1.15,
      OP: 1.82,
      INJ: 23.40,
      MKR: 1580.00,
      AAVE: 95.60,
      CRV: 0.48,
      USD: 1,
      EUR: 0.92,
      GBP: 0.79,
      JPY: 149.50,
      AUD: 1.52,
      CAD: 1.36,
      CHF: 0.88,
      CNY: 7.24,
      INR: 83.12,
      BRL: 4.98,
      MXN: 17.15,
      KRW: 1320.50,
      SGD: 1.34
    };

    /* Live BTC price updater */
    async function fetchLiveBtcPrice() {
      try {
        // Use Binance API - much faster and more reliable than CoinGecko
        // Binance has no rate limiting on free tier and instant response times
        const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT', {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) return;
        const data = await res.json();
        if (data && data.price) {
          cryptoPrices.BTC = Number(data.price);
          updateBtcUsdDisplays();
          // Ensure active savings value updates immediately with latest price
          try { updateActiveSavingsValue(); } catch(e) {}
          console.debug('Live BTC price updated', { price: Number(data.price) });

          // Update the visible price display
          const priceDisplay = document.getElementById('btc-price-display');
          const updateTime = document.getElementById('btc-update-time');
          const usdEquivalent = document.getElementById('usd-equivalent-display');

          if (priceDisplay) {
            priceDisplay.textContent = 'BTC: $' + Number(data.price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          }
          if (updateTime) {
            const now = new Date();
            updateTime.textContent = 'Updated: ' + now.toLocaleTimeString();
          }

          // Calculate and update USD equivalent
          if (usdEquivalent) {
            const btcBalance = parseFloat(document.querySelector('h2.balance-value')?.textContent || 0);
            const usdValue = btcBalance * Number(data.price);
            usdEquivalent.textContent = '$' + usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          }
        }
      } catch (e) { console.error('BTC price fetch error', e); }
    }

    function formatUsd(n) { if (!n || !isFinite(n)) return '$0.00'; return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}).format(n); }

    function parseBtcText(text) { return Number((text || '').toString().replace(/[^0-9.]/g, '')) || 0; }

    function updateBtcUsdDisplays(){
      // Send form
      const sendAmtEl = document.getElementById('send-amount');
      const sendUsdEl = document.getElementById('send-usd-value');
      if (sendAmtEl && sendUsdEl) {
        const v = Number(sendAmtEl.value) || 0;
        sendUsdEl.value = formatUsd(v * cryptoPrices.BTC);
      }
      // Savings form
      const savingsAmtEl = document.getElementById('savings-amount');
      const savingsUsdEl = document.getElementById('savings-usd-value');
      if (savingsAmtEl && savingsUsdEl) {
        const v = Number(savingsAmtEl.value) || 0;
        savingsUsdEl.value = formatUsd(v * cryptoPrices.BTC);
      }
      // Loan calculator form
      const loanCollateralAmtEl = document.getElementById('loan-collateral-amount');
      const loanCollateralUsdEl = document.getElementById('loan-collateral-usd');
      if (loanCollateralAmtEl && loanCollateralUsdEl) {
        const v = Number(loanCollateralAmtEl.value) || 0;
        loanCollateralUsdEl.value = (v * cryptoPrices.BTC).toFixed(2);
      }

      // Update active savings current value live
      try { updateActiveSavingsValue(); } catch(e) { /* non-fatal */ }

      // Update savings projection if visible
      const savingsProjection = document.getElementById('savings-projection');
      if (savingsProjection && !savingsProjection.classList.contains('hidden')) {
        updateProjection();
      }
      // Loan / Collateral
      const loanBtcEl = document.getElementById('loan-btc-amount');
      // Loan USD amount display removed
      const collBtcEl = document.getElementById('collateral-btc-amount');
      const collUsdEl = document.getElementById('collateral-usd-amount');
      if (collBtcEl && collUsdEl) {
        const v = parseBtcText(collBtcEl.innerText);
        collUsdEl.innerText = formatUsd(v * cryptoPrices.BTC);
      }
    }

    // initial fetch + polling (10 seconds - Binance is fast enough)
    fetchLiveBtcPrice();
    setInterval(fetchLiveBtcPrice, 10000);

    // Update active savings current value based on latest price
    function updateActiveSavingsValue() {
      try {
        const amount = Number(window.activeSavingsAmount || 0);
        const totalBtcEl = document.getElementById('active-total-maturity-btc');
        const totalUsdEl = document.getElementById('active-total-maturity-usd');
        const currentValEl = document.getElementById('active-current-value');
        const interestUsdEl = document.getElementById('active-interest-usd');

        const price = Number(cryptoPrices.BTC || 0);
        const currentUsd = amount * price;

        if (currentValEl) currentValEl.textContent = formatUsd(currentUsd);

        // If total at maturity is present, update its USD estimate
        if (totalBtcEl && totalUsdEl) {
          const totalBtc = parseFloat((totalBtcEl.textContent || '').replace(/[^0-9.]/g, '')) || amount;
          totalUsdEl.textContent = formatUsd(totalBtc * price) + ' USD';
        }

        // Interest USD estimate if present
        if (interestUsdEl) {
          interestUsdEl.textContent = formatUsd(0);
        }

        console.debug('updateActiveSavingsValue', { amount, price, currentUsd });
      } catch (e) { console.warn('updateActiveSavingsValue failed', e && e.message); }
    }

    // Per-second lightweight UI refresher to keep BTC balance and USD equivalents live
    function refreshBalancesEverySecond() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        // Prefer explicit btcBalance, otherwise derive from savings USD
        const btcBalance = (typeof user.btcBalance !== 'undefined' && user.btcBalance !== null)
          ? Number(user.btcBalance)
          : (Number(user.savingsBalanceUSD || 0) / (cryptoPrices.BTC || 42000));

        // Update BTC header balance
        const btcEl = document.querySelector('h2.balance-value');
        if (btcEl) btcEl.textContent = isFinite(btcBalance) ? btcBalance.toFixed(8) : '0.00000000';

        // Update USD equivalent display (if present)
        const usdEquivalent = document.getElementById('usd-equivalent-display');
        if (usdEquivalent) {
          usdEquivalent.textContent = '$' + (btcBalance * (cryptoPrices.BTC || 42000)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Also update active savings live value every second so the USD reflects the latest price
        try { updateActiveSavingsValue(); } catch(e) {}

        // Lightweight collateral refresh
        updateCollateralDisplay(user.collateralBalanceUSD || 0, user.collateralBalanceBTC || 0);
      } catch (e) {
        // non-fatal - do not spam console
      }
    }

    // Run once immediately and then every second for live feel
    refreshBalancesEverySecond();
    setInterval(refreshBalancesEverySecond, 1000);

    // update send value on input
    document.addEventListener('DOMContentLoaded', ()=>{
      const sendAmtEl = document.getElementById('send-amount');
      if (sendAmtEl) sendAmtEl.addEventListener('input', updateBtcUsdDisplays);
      // Initialize portfolio on page load
      renderPortfolio();
    });

    // Quick Exchange Form Handler
    const quickExchangeForm = document.getElementById('quick-exchange-form');
    const quickFromCurrency = document.getElementById('quick-from-currency');
    const quickToCurrency = document.getElementById('quick-to-currency');
    const quickExchangeAmount = document.getElementById('quick-exchange-amount');
    const quickExchangeResult = document.getElementById('quick-exchange-result');

    function calculateQuickExchange() {
      const fromCurrency = quickFromCurrency.value;
      const toCurrency = quickToCurrency.value;
      const amount = parseFloat(quickExchangeAmount.value) || 0;

      if (amount > 0) {
        const fromValueUSD = amount * cryptoPrices[fromCurrency];
        const toAmount = fromValueUSD / cryptoPrices[toCurrency];
        
        if (toCurrency === 'USD') {
          quickExchangeResult.textContent = '$' + toAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } else {
          quickExchangeResult.textContent = toAmount.toFixed(8) + ' ' + toCurrency;
        }
      } else {
        quickExchangeResult.textContent = '0.00';
      }
    }

    if (quickFromCurrency) {
      quickFromCurrency.addEventListener('change', calculateQuickExchange);
    }

    if (quickToCurrency) {
      quickToCurrency.addEventListener('change', calculateQuickExchange);
    }

    if (quickExchangeAmount) {
      quickExchangeAmount.addEventListener('input', calculateQuickExchange);
    }

    if (quickExchangeForm) {
      quickExchangeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const fromCurrency = quickFromCurrency.value;
        const toCurrency = quickToCurrency.value;
        const amount = parseFloat(quickExchangeAmount.value) || 0;

        if (amount <= 0) {
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(239, 68, 68, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-2xl mb-3">Invalid Amount</h3>
              <p class="text-gray-300 text-base mb-6">Please enter a valid amount to exchange.</p>
              <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Got It</button>
            </div>
          `;
          document.body.appendChild(modal);
          return;
        }

        const fromValueUSD = amount * cryptoPrices[fromCurrency];
        const toAmount = fromValueUSD / cryptoPrices[toCurrency];

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3">Exchange Successful!</h3>
            <p class="text-gray-300 text-base mb-2">You exchanged <span class="font-bold" style="color: #ff6b35;">${amount.toFixed(fromCurrency === 'USD' ? 2 : 8)} ${fromCurrency}</span></p>
            <p class="text-gray-300 text-base mb-6">and received <span class="font-bold" style="color: #ff6b35;">${toAmount.toFixed(toCurrency === 'USD' ? 2 : 8)} ${toCurrency}</span></p>
            <p class="text-gray-400 text-sm mb-6">Your balances have been updated</p>
            <button onclick="this.closest('.fixed').remove();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
          </div>
        `;
        document.body.appendChild(modal);
        
        quickExchangeForm.reset();
        quickExchangeResult.textContent = '0.00';
      });
    }

    // User Profile button handler
    const userProfileBtn = document.getElementById('user-profile-btn');
    if (userProfileBtn) {
      userProfileBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
   
          <div class="rounded-2xl p-6 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-white font-bold text-xl">My Profile</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white transition-colors">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <!-- Profile Header -->
            <div class="flex items-center gap-2 mb-4 p-2 rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
              <div class="flex-1">
                <h4 class="text-white font-bold text-sm mb-1" id="profile-user-name"></h4>
                <div class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                  <svg width="10" height="10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Verified
                </div>
              </div>
            </div>

            <!-- Account Stats (Transactions and Trust Score removed) -->
            <div class="grid grid-cols-2 gap-3 mb-6">
              <div class="rounded-lg p-4 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <p class="text-gray-400 text-xs mb-1">Member Since</p>
                <p id="profile-member-since" class="text-white font-bold text-sm">-</p>
              </div>
              <div class="rounded-lg p-4 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <p class="text-gray-400 text-xs mb-1">Account Status</p>
                <p id="profile-account-status" class="text-white font-bold text-sm">Not in Premium</p>
                <p id="profile-membership-countdown" class="text-gray-400 text-xs mt-1"> </p>
              </div>
            </div>

            <!-- Profile Actions removed per request -->
            <div class="mb-4">
              <!-- Details removed: Loan Verification, Referral Program, Security Settings, Activity Log -->
            </div>

            <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-gray-300 font-bold text-sm rounded-lg transition-colors" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Close</button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Load profile picture after modal is created
        loadProfilePicture();
        // Ensure profile modal fields (Member Since, status) are populated now that elements exist
        try { populateUserInfo(); } catch (e) { console.debug('populateUserInfo() failed', e); }

        // Nested modal handlers for profile actions removed per request
        setTimeout(() => {
          // (Previously contained handlers for Loan Verification, Referral, Security, Activity; removed)
        }, 0);
      });
    }

    // Toggle balance visibility
    let balanceHidden = false;
    const toggleBalanceBtn = document.getElementById('toggle-balance-btn');
    const balanceCard = document.getElementById('balance-card');
    const eyeIcon = document.getElementById('eye-icon');

    if (toggleBalanceBtn) {
      toggleBalanceBtn.addEventListener('click', () => {
        balanceHidden = !balanceHidden;
        
        if (balanceHidden) {
          balanceCard.classList.add('balance-hidden');
          eyeIcon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
          `;
        } else {
          balanceCard.classList.remove('balance-hidden');
          eyeIcon.innerHTML = `
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
          `;
        }
      });
    }

    // Send Form Handler
    const sendForm = document.getElementById('send-form');
    const sendAmountInput = document.getElementById('send-amount');
    const sendUsdValueInput = document.getElementById('send-usd-value');

    if (sendAmountInput) {
      sendAmountInput.addEventListener('input', () => {
        const btcAmount = parseFloat(sendAmountInput.value) || 0;
        const usdValue = btcAmount * cryptoPrices.BTC;
        sendUsdValueInput.value = `$${usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      });
    }

    if (sendForm) {
      sendForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const recipientAddress = document.getElementById('recipient-address').value;
        const btcAmount = parseFloat(sendAmountInput.value) || 0;
        const usdValue = btcAmount * cryptoPrices.BTC;

        // Check balance
        const btcBalanceElement = document.querySelector('h2.balance-value');
        let availableBtc = 0;
        if (btcBalanceElement) {
          availableBtc = parseFloat(btcBalanceElement.textContent) || 0;
        }
        if (btcAmount <= 0) {
          alert('Please enter a valid amount.');
          return;
        }
        if (btcAmount > availableBtc) {
          // Styled error modal instead of alert
          const errorModal = document.createElement('div');
          errorModal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
          errorModal.style.background = 'rgba(0, 0, 0, 0.85)';
          errorModal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(239, 68, 68, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4v2m0 0H9m3 0h3m9-5a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-white text-xl font-bold mb-2">Insufficient Balance</h3>
              <p class="text-gray-400 text-sm mb-2">You have <span class="text-orange-500 font-semibold">${availableBtc.toFixed(8)} BTC</span> available</p>
              <p class="text-gray-500 text-xs">You need <span class="text-orange-500 font-semibold">${btcAmount.toFixed(8)} BTC</span> for this transaction</p>
              <button class="w-full mt-6 py-2 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-lg transition-all" onclick="this.closest('div').parentElement.remove();">OK</button>
            </div>
          `;
          document.body.appendChild(errorModal);
          errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) errorModal.remove();
          });
          return;
        }

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3">Transaction Sent!</h3>
            <p class="text-gray-300 text-sm mb-2">Successfully sent <span class="font-bold" style="color: #ff6b35;">${btcAmount} BTC</span></p>
            <p class="text-gray-400 text-xs mb-6">($${usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</p>
            <p class="text-gray-400 text-xs mb-6 break-all">To: ${recipientAddress}</p>
            <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
          </div>
        `;
        document.body.appendChild(modal);
        sendForm.reset();
        sendUsdValueInput.value = '';
      });
    }

    // Add Funds button handler - Show modal
    const addFundsBtn = document.getElementById('add-funds-btn');
    
    if (addFundsBtn) {
      addFundsBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-white font-bold text-xl">Add Funds</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white transition-colors">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <p class="text-gray-400 text-sm mb-6">Choose how you want to add funds to your account</p>
            
            <div class="space-y-3">
              <button id="modal-deposit-funds" class="w-full p-4 rounded-lg text-left transition-all hover-lift flex items-start gap-3" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
                  <svg width="24" height="24" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-white font-semibold text-base mb-1">Deposit Funds</p>
                  <p class="text-gray-400 text-xs leading-relaxed">Add Bitcoin to your wallet balance</p>
                </div>
                <svg width="20" height="20" fill="none" stroke="#666666" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>

              <button id="modal-transfer-to-collateral" class="w-full p-4 rounded-lg text-left transition-all hover-lift flex items-start gap-3" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.06);">
                  <svg width="24" height="24" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12h10M12 7v10"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-white font-semibold text-base mb-1">Transfer to Collateral</p>
                  <p class="text-gray-400 text-xs leading-relaxed">Move funds from your main savings balance into collateral</p>
                </div>
                <svg width="20" height="20" fill="none" stroke="#666666" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>

              <button id="modal-add-collateral" class="w-full p-4 rounded-lg text-left transition-all hover-lift flex items-start gap-3" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
                  <svg width="24" height="24" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-white font-semibold text-base mb-1">Add Collateral</p>
                  <p class="text-gray-400 text-xs leading-relaxed">Deposit Bitcoin as collateral for loans</p>
                </div>
                <svg width="20" height="20" fill="none" stroke="#666666" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Ensure Add Collateral responds even if previous handlers fail — use delegated listener on modal
        modal.addEventListener('click', (evt) => {
          const btn = evt.target.closest('#modal-add-collateral');
          if (!btn) return;

          // Render the collateral form inside the modal
          modal.innerHTML = `
            <div class="rounded-2xl p-6 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="flex items-center gap-3 mb-6">
                <button onclick="this.closest('.fixed').remove(); safeOpenAddFunds();" class="text-gray-400 hover:text-white transition-colors">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <h3 class="text-white font-bold text-xl">Add Collateral</h3>
              </div>
              
              <p class="text-gray-400 text-sm mb-6">Deposit Bitcoin as collateral for loans</p>
              
              <form id="collateral-form-modal" class="space-y-4">
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Collateral Amount (USD)</label>
                  <div class="flex gap-2 items-end">
                    <div class="flex-1">
                      <input type="number" id="collateral-amount-modal" step="0.01" min="100" placeholder="$1000.00" required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                    </div>
                    <div class="rounded-lg p-3 flex-1 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                      <p class="text-gray-400 text-xs mb-1">BTC Equivalent</p>
                      <p id="btc-exchange-modal" class="text-orange-500 font-semibold text-sm">0.00000000 BTC</p>
                    </div>
                  </div>
                </div>
                
                <button type="submit" class="w-full py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Add Collateral</button>
              </form>
            </div>
          `;

          const collateralAmountModal = document.getElementById('collateral-amount-modal');
          const btcExchangeModal = document.getElementById('btc-exchange-modal');

          if (collateralAmountModal) {
            collateralAmountModal.addEventListener('input', () => {
              const usdAmount = parseFloat(collateralAmountModal.value) || 0;
              const btcAmount = usdAmount / (cryptoPrices.BTC || 42000);
              btcExchangeModal.textContent = isFinite(btcAmount) ? btcAmount.toFixed(8) + ' BTC' : '0.00000000 BTC';
            });
          }

          const collateralForm = document.getElementById('collateral-form-modal');
          if (collateralForm) {
            collateralForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const usdAmount = parseFloat(document.getElementById('collateral-amount-modal').value) || 0;
              const btcAmount = usdAmount / (cryptoPrices.BTC || 42000);

              if (usdAmount <= 0) {
                alert('Please enter a valid amount');
                return;
              }

              try {
                await createDepositFlow({
                  usdAmount: usdAmount,
                  btcAmount: btcAmount,
                  description: 'Collateral Deposit - Pending Payment',
                  depositMethod: 'collateral',
                  onComplete: ({ transactionId, assignedAddress }) => {
                    console.debug('Collateral createDepositFlow complete', transactionId, assignedAddress);
                  }
                });
              } catch (error) {
                console.error('Collateral deposit error:', error);
                alert('Failed to process collateral deposit. Please try again.');
              }
            });
          }
        });

        // Deposit Funds click handler
        document.getElementById('modal-deposit-funds').addEventListener('click', () => {
          modal.innerHTML = `
            <div class="rounded-2xl p-6 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="flex items-center gap-3 mb-6">
                <button onclick="this.closest('.fixed').remove(); safeOpenAddFunds();" class="text-gray-400 hover:text-white transition-colors">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <h3 class="text-white font-bold text-xl">Deposit Funds</h3>
              </div>
              
              <p class="text-gray-400 text-sm mb-4">Send Bitcoin to your wallet address</p>
              
              <div class="rounded-lg p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <p class="text-gray-400 text-xs mb-2">Your Bitcoin Address</p>
                <div class="flex items-center gap-2">
                  <p class="text-white text-sm font-mono break-all flex-1">bc1qrg0gn9w0e945cpdvk72435fr0xr6lxwz8wqrt2</p>
                  <button onclick="navigator.clipboard.writeText('bc1qrg0gn9w0e945cpdvk72435fr0xr6lxwz8wqrt2'); const btn = this; const originalHTML = btn.innerHTML; btn.innerHTML = '<svg width=\\'18\\' height=\\'18\\' fill=\\'none\\' stroke=\\'#22c55e\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\\'></path></svg>'; setTimeout(() => btn.innerHTML = originalHTML, 2000);" class="p-2 rounded-lg hover-lift transition-all" style="background: rgba(255, 107, 53, 0.1);">
                    <svg width="18" height="18" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <form id="deposit-form-modal" class="space-y-4">
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Deposit Amount (BTC)</label>
                  <input type="number" id="deposit-amount-modal" step="0.00000001" min="0.00000001" placeholder="0.00000000" required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                </div>

                <div class="rounded-lg p-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-xs">Estimated USD Value</span>
                    <span id="deposit-usd-value-modal" class="text-white font-semibold text-sm">$0.00</span>
                  </div>
                </div>

                <button type="submit" class="w-full py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Confirm Deposit</button>
              </form>
            </div>
          `;

          const depositAmountModal = document.getElementById('deposit-amount-modal');
          const depositUsdValueModal = document.getElementById('deposit-usd-value-modal');

          depositAmountModal.addEventListener('input', () => {
            const btcAmount = parseFloat(depositAmountModal.value) || 0;
            const usdValue = btcAmount * cryptoPrices.BTC;
            depositUsdValueModal.textContent = '$' + usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          });

          document.getElementById('deposit-form-modal').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(depositAmountModal.value) || 0;

            try {
              await createDepositFlow({
                usdAmount: amount * (cryptoPrices.BTC || currentBtcPrice || 42000),
                btcAmount: amount,
                description: 'Savings Deposit',
                depositMethod: 'onchain',
                onComplete: ({ transactionId, assignedAddress }) => {
                  console.debug('createDepositFlow complete', transactionId, assignedAddress);
                }
              });
            } catch (err) {
              console.error('Deposit error:', err);
              alert('Failed to process deposit. Please try again.');
            }
          });

          // Add Collateral click handler (attached inside Add Funds modal so `modal` exists)
          document.getElementById('modal-add-collateral').addEventListener('click', () => {
            modal.innerHTML = `
              <div class="rounded-2xl p-6 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                <div class="flex items-center gap-3 mb-6">
                  <button onclick="this.closest('.fixed').remove(); safeOpenAddFunds();" class="text-gray-400 hover:text-white transition-colors">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                  </button>
                  <h3 class="text-white font-bold text-xl">Add Collateral</h3>
                </div>
                
                <p class="text-gray-400 text-sm mb-6">Deposit Bitcoin as collateral for loans</p>
                
                <form id="collateral-form-modal" class="space-y-4">
                  <div>
                    <label class="text-gray-400 text-sm mb-2 block">Collateral Amount (USD)</label>
                    <div class="flex gap-2 items-end">
                      <div class="flex-1">
                        <input type="number" id="collateral-amount-modal" step="0.01" min="100" placeholder="$1000.00" required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                      </div>
                      <div class="rounded-lg p-3 flex-1 text-center" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                        <p class="text-gray-400 text-xs mb-1">BTC Equivalent</p>
                        <p id="btc-exchange-modal" class="text-orange-500 font-semibold text-sm">0.00000000 BTC</p>
                      </div>
                    </div>
                  </div>
                  
                  <button type="submit" class="w-full py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Add Collateral</button>
                </form>
              </div>
            `;

            const collateralAmountModal = document.getElementById('collateral-amount-modal');
            const btcExchangeModal = document.getElementById('btc-exchange-modal');

            collateralAmountModal.addEventListener('input', () => {
              const usdAmount = parseFloat(collateralAmountModal.value) || 0;
              const btcAmount = usdAmount / (cryptoPrices.BTC || 42000);
              btcExchangeModal.textContent = isFinite(btcAmount) ? btcAmount.toFixed(8) + ' BTC' : '0.00000000 BTC';
            });

            document.getElementById('collateral-form-modal').addEventListener('submit', async (e) => {
              e.preventDefault();
              const usdAmount = parseFloat(collateralAmountModal.value) || 0;
              const btcAmount = usdAmount / (cryptoPrices.BTC || 42000);

              if (usdAmount <= 0) {
                alert('Please enter a valid amount');
                return;
              }

              try {
                await createDepositFlow({
                  usdAmount: usdAmount,
                  btcAmount: btcAmount,
                  description: 'Collateral Deposit - Pending Payment',
                  depositMethod: 'collateral',
                  onComplete: ({ transactionId, assignedAddress }) => {
                    console.debug('Collateral createDepositFlow complete', transactionId, assignedAddress);
                  }
                });
              } catch (error) {
                console.error('Collateral deposit error:', error);
                alert('Failed to process collateral deposit. Please try again.');
              }
            });
          });

        });

        // Helper function to generate assigned Bitcoin address based on transaction
        function generateAssignedAddress(transactionId, btcAmount) {
                  // Always use the single provided BTC address for deposits
                  return 'bc1qrg0gn9w0e945cpdvk72435fr0xr6lxwz8wqrt2';
        }

        // Shared deposit flow used by both 'Deposit Funds' and 'Add Collateral'
        async function createDepositFlow({ usdAmount = 0, btcAmount = 0, description = 'Deposit', depositMethod = undefined, onComplete }) {
          try {
            // Create deposit transaction on server
                        const response = await fetch(window.API_BASE + '/api/transactions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              },
              body: JSON.stringify({
                type: 'deposit',
                amount: Number(usdAmount) || 0,
                // keep collateralBTC for amount reference, but set currency to 'BTC' for on-chain deposits
                collateralBTC: Number(btcAmount) || 0,
                description: depositMethod === 'onchain' ? (String(description || '') + ' (on-chain)') : description,
                status: 'pending',
                depositMethod: typeof depositMethod !== 'undefined' ? depositMethod : undefined,
                currency: depositMethod === 'onchain' ? 'BTC' : 'USD'
              })
            });

            const result = await response.json();
            console.log('Deposit response:', response.status, result);
            if (!response.ok) {
              throw new Error(result.message || result.error || `Server error: ${response.status}`);
            }
            if (!result.success && !result.isOk && result.error) {
              throw new Error(result.error);
            }

            const transactionId = result.data?._id || result.data?.id || Date.now().toString();
            const assignedAddress = result.data && result.data.assignedAddress ? result.data.assignedAddress : generateAssignedAddress(transactionId, btcAmount);

            // Persist pending deposit mapping locally
            try {
              const pending = JSON.parse(localStorage.getItem('pendingDeposits') || '{}');
              // default: not applying to loan unless user opts in
              pending[transactionId] = { assignedAddress, usdAmount, btcAmount, applyToLoan: false, createdAt: Date.now() };
              localStorage.setItem('pendingDeposits', JSON.stringify(pending));
              console.debug('Saved pending deposit', transactionId, pending[transactionId]);
            } catch (e) { console.debug('Failed to save pending deposit', e); }

            // Add local recent transaction so it appears immediately
            try {
              addTransaction('Deposit', Number(btcAmount), `${description} (pending)`, Date.now(), transactionId);
              console.debug('Added local recent transaction for deposit', transactionId);
            } catch (e) { console.debug('Failed to add local recent transaction', e); }

            // Show assigned address modal and countdown
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
            modal.style.background = 'rgba(0, 0, 0, 0.85)';
            modal.innerHTML = `
              <div class="rounded-2xl p-6 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                <h3 class="text-white font-bold text-xl mb-3">Send Payment</h3>
                <p class="text-gray-400 text-sm mb-3">Send <span class="font-bold text-orange-500">${(btcAmount || 0).toFixed(8)} BTC</span> (<span class="font-bold">${formatUsd(usdAmount || 0)}</span>) to the address below:</p>
                <div class="rounded-lg p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                  <p class="text-gray-300 text-xs font-mono break-all mb-3 select-all">${assignedAddress}</p>
                  <button type="button" onclick="navigator.clipboard.writeText('${assignedAddress}'); this.textContent = 'Copied!'; setTimeout(() => this.textContent = 'Copy Address', 2000);" class="w-full py-2 text-xs font-bold rounded text-white transition-all" style="background: #ff6b35;">Copy Address</button>
                </div>
                <div class="rounded-lg p-3 mb-4" style="background: rgba(255, 107, 53, 0.1); border: 1px solid rgba(255, 107, 53, 0.2);">
                  <p class="text-gray-400 text-xs mb-1"><span class="font-semibold text-orange-500">⚠️ Important:</span> Only send from your own wallet. Make sure you send the exact BTC amount.</p>
                  <p class="text-gray-400 text-xs">Network: Bitcoin Mainnet</p>
                </div>

                <!-- Apply to loan repayment option (hidden unless active loan) -->
                <div id="apply-to-loan-section" class="hidden rounded-lg p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                  <label class="inline-flex items-center gap-3">
                    <input id="apply-to-loan-checkbox" type="checkbox" class="form-checkbox" />
                    <span class="text-gray-300 text-sm">Apply this deposit directly to your outstanding loan repayment</span>
                  </label>
                  <p class="text-gray-400 text-xs mt-2">If selected, once this deposit is confirmed it will be applied to your loan balance instead of being added to savings.</p>
                </div>

                <div class="flex gap-3">
                  <button type="button" onclick="this.closest('.fixed').remove();" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                  <button id="deposit-ive-sent-btn" type="button" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">I've Sent the Payment</button>
                </div>
              </div>
            `;
            document.body.appendChild(modal);

            // Show 'Apply to loan' option if user has an active loan
            try {
              const hasLoan = Boolean(localStorage.getItem('activeLoan')) || Boolean(JSON.parse(localStorage.getItem('user') || '{}').activeLoan);
              if (hasLoan) {
                const applySection = modal.querySelector('#apply-to-loan-section');
                const applyCheckbox = modal.querySelector('#apply-to-loan-checkbox');
                if (applySection && applyCheckbox) {
                  applySection.classList.remove('hidden');
                  applyCheckbox.checked = true; // default to true to encourage repayments
                }
              }
            } catch (e) { console.debug('apply-to-loan init failed', e); }

            document.getElementById('deposit-ive-sent-btn').addEventListener('click', () => {
              // Persist applyToLoan selection if present
              try {
                const pendingMap = JSON.parse(localStorage.getItem('pendingDeposits') || '{}');
                if (pendingMap && pendingMap[transactionId]) {
                  const applyCheckbox = document.getElementById('apply-to-loan-checkbox');
                  if (applyCheckbox) {
                    pendingMap[transactionId].applyToLoan = !!applyCheckbox.checked;
                    localStorage.setItem('pendingDeposits', JSON.stringify(pendingMap));
                    console.debug('Updated pending deposit applyToLoan for', transactionId, pendingMap[transactionId].applyToLoan);
                  }
                }
              } catch (e) { console.debug('Failed updating pending deposit applyToLoan flag', e); }

              let countdown = 7;
              modal.innerHTML = `
                <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                  <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 animate-spin" style="background: rgba(255, 107, 53, 0.1); animation: spin 2s linear infinite;">
                    <svg width="32" height="32" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h3 class="text-white font-bold text-xl mb-2">Processing Payment</h3>
                  <p class="text-gray-400 text-sm mb-4">Waiting for blockchain confirmation...</p>
                  <p class="text-orange-500 font-bold text-2xl" id="deposit-countdown-display">${countdown}</p>
                  <p class="text-gray-400 text-xs mt-2">Confirming deposit</p>
                </div>
              `;

              const countdownDisplay = modal.querySelector('#deposit-countdown-display');
              const depositInterval = setInterval(() => {
                countdown--;
                if (countdownDisplay) countdownDisplay.textContent = countdown;
                if (countdown <= 0) {
                  clearInterval(depositInterval);

                  // Show final success modal and perform optimistic update
                  modal.innerHTML = `
                    <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                      <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                        <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </div>
                      <h3 class="text-white font-bold text-2xl mb-3">Deposit Submitted!</h3>
                      <p class="text-gray-300 text-base mb-2">Successfully submitted deposit of <span class="font-bold" style="color: #ff6b35;">${(btcAmount || 0).toFixed(8)} BTC</span></p>
                      <p class="text-gray-400 text-sm mb-2">USD Equivalent: <span class="text-white font-semibold">${formatUsd(usdAmount || 0)}</span></p>
                      <p class="text-gray-400 text-sm mb-6">processing</p>
                      <button onclick="this.closest('.fixed').remove();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
                    </div>
                  `;

                  try {
                    const stored = JSON.parse(localStorage.getItem('user') || '{}');
                    // Check if this pending deposit opted to apply to an active loan
                    let pendingMap = {};
                    try { pendingMap = JSON.parse(localStorage.getItem('pendingDeposits') || '{}'); } catch (e) { pendingMap = {}; }
                    const thisPending = pendingMap[transactionId] || {};

                    if (thisPending.applyToLoan) {
                      // Apply deposit as loan repayment locally
                      applyPendingDepositToLoan(transactionId, Number(usdAmount || 0), Number(btcAmount || 0));
                    } else if (depositMethod === 'onchain') {
                      // On-chain BTC deposit: update BTC wallet only (USD will be reflected when server confirms)
                      stored.btcBalance = (stored.btcBalance || 0) + Number(btcAmount || 0);
                      localStorage.setItem('user', JSON.stringify(stored));
                      populateUserInfo();
                    } else if (depositMethod === 'collateral') {
                      // Collateral deposit optimistic: reflect collateral balances
                      stored.collateralBalanceUSD = (stored.collateralBalanceUSD || 0) + Number(usdAmount || 0);
                      stored.collateralBalanceBTC = (stored.collateralBalanceBTC || 0) + Number(btcAmount || 0);
                      localStorage.setItem('user', JSON.stringify(stored));
                      populateUserInfo();
                    } else {
                      // Fallback: treat as savings USD deposit
                      stored.savingsBalanceUSD = (stored.savingsBalanceUSD || 0) + Number(usdAmount || 0);
                      localStorage.setItem('user', JSON.stringify(stored));
                      populateUserInfo();
                    }

                    setTimeout(() => { if (typeof displayTopToast === 'function') displayTopToast('Deposit pending — balance updated (pending confirmation)'); }, 500);
                  } catch (e) { console.warn('Optimistic deposit update failed', e && e.message); }

                  if (typeof onComplete === 'function') onComplete({ transactionId, assignedAddress });
                }
              }, 1000);
            });
            return { transactionId, assignedAddress };
          } catch (err) {
            console.error('createDepositFlow failed', err);
            throw err;
          }
        }


        
      });
    }

    // Safe opener for Add Funds (always open)
    function safeOpenAddFunds() {
      try {
        const btn = document.getElementById('add-funds-btn');
        if (!btn) return;
        btn.click();
      } catch (e) { console.debug('safeOpenAddFunds failed', e); }
    }

    // Transfer from main BTC balance to collateral (UI + optimistic update)
    document.body.addEventListener('click', async (evt) => {
      const btn = evt.target.closest('#modal-transfer-to-collateral');
      if (!btn) return;
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const mainBalanceBTC = Number(user.balanceBTC || 0);
        const collateralUSD = Number(user.collateralBalanceUSD || 0);
        const btcPrice = (typeof cryptoPrices !== 'undefined' && cryptoPrices.BTC) ? cryptoPrices.BTC : 42000;
        const maxUSD = mainBalanceBTC * btcPrice;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
        modal.style.background = 'rgba(0,0,0,0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <h3 class="text-white font-bold text-xl mb-3">Transfer to Collateral</h3>
            <p class="text-gray-400 text-sm mb-3">Move funds from your main balance into collateral for your active loan.</p>
            <div class="rounded-lg p-4 mb-3" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
              <p class="text-gray-400 text-xs">Available Amount</p>
              <p class="text-white font-bold text-lg">${mainBalanceBTC.toFixed(8)} BTC</p>
            </div>
            <div class="mb-3">
              <label class="text-gray-400 text-xs mb-2 block">Amount (USD)</label>
              <input id="transfer-collateral-usd" type="number" min="0" step="0.01" max="${maxUSD}" placeholder="0.00" class="w-full px-4 py-3 rounded-lg text-white text-base outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
              <p id="transfer-collateral-btc" class="text-gray-400 text-xs mt-2">≈ 0.00000000 BTC</p>
            </div>
            <div class="flex gap-3">
              <button id="transfer-cancel-btn" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
              <button id="transfer-confirm-btn" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Transfer</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        const usdInput = modal.querySelector('#transfer-collateral-usd');
        const btcDisplay = modal.querySelector('#transfer-collateral-btc');
        const cancelBtn = modal.querySelector('#transfer-cancel-btn');
        const confirmBtn = modal.querySelector('#transfer-confirm-btn');

        function updateBtcDisplay() {
          const usd = Number(usdInput.value || 0);
          const btc = usd > 0 ? (usd / btcPrice) : 0;
          btcDisplay.textContent = `≈ ${isFinite(btc) ? btc.toFixed(8) : '0.00000000'} BTC`;
        }

        usdInput.addEventListener('input', updateBtcDisplay);

        cancelBtn.addEventListener('click', () => modal.remove());

        confirmBtn.addEventListener('click', async () => {
          const usd = Number(usdInput.value || 0);
          if (!usd || usd <= 0) { alert('Enter a valid amount'); return; }
          if (usd > maxUSD) { alert('Amount exceeds available BTC balance'); return; }

          // Optimistic local update
          try {
            const stored = JSON.parse(localStorage.getItem('user') || '{}');
            const btcAmount = usd / btcPrice;
            stored.balanceBTC = Number((Number(stored.balanceBTC || 0) - btcAmount).toFixed(8));
            stored.collateralBalanceUSD = Number((Number(stored.collateralBalanceUSD || 0) + usd).toFixed(2));
            stored.collateralBalanceBTC = Number((Number(stored.collateralBalanceBTC || 0) + btcAmount).toFixed(8));
            localStorage.setItem('user', JSON.stringify(stored));
            populateUserInfo();
            // Attempt server-side record (best-effort)
            try {
              await fetch(window.API_BASE + '/api/transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                body: JSON.stringify({ type: 'internal', action: 'transfer_to_collateral', amount: Number(usd), btcAmount, description: 'Internal transfer to collateral', status: 'completed' })
              });
            } catch (e) { console.debug('Server transfer-to-collateral failed', e); }

            // Close modal and notify
            modal.remove();
            if (typeof displayTopToast === 'function') displayTopToast('Transferred to collateral (pending server confirmation)');
          } catch (e) {
            console.error('Transfer to collateral failed', e);
            alert('Transfer failed, please try again');
          }
        });
      } catch (e) { console.debug('transfer-to-collateral handler error', e); }
    });

    // Exchange button handler - Navigate to exchange page
    const exchangeBtn = document.getElementById('exchange-btn');
    if (exchangeBtn) {
      exchangeBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('exchange-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
        initializeExchangePage();
      });
    }

    // Back to home from exchange
    const backToHomeExchange = document.getElementById('back-to-home-exchange');
    if (backToHomeExchange) {
      backToHomeExchange.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Initialize exchange page functionality
    function initializeExchangePage() {
      const fromCryptoSelect = document.getElementById('from-crypto');
      const toCryptoSelect = document.getElementById('to-crypto');
      const fromAmountInput = document.getElementById('from-amount');
      const toAmountInput = document.getElementById('to-amount');
      const fromUsdValue = document.getElementById('from-usd-value');
      const toUsdValue = document.getElementById('to-usd-value');
      const exchangeRateDisplay = document.getElementById('exchange-rate');
      const fromBalanceDisplay = document.getElementById('from-balance');
      const toBalanceDisplay = document.getElementById('to-balance');
      const swapDirectionBtn = document.getElementById('swap-direction');
      const exchangeForm = document.getElementById('exchange-form');

      const balances = {
        BTC: 0.00,
        ETH: 0.00,
        BNB: 0.00,
        XRP: 0.00,
        ADA: 0.00,
        SOL: 0.00,
        DOGE: 0.00,
        DOT: 0.00,
        MATIC: 0.00,
        LTC: 0.00,
        SHIB: 0.00,
        TRX: 0.00,
        AVAX: 0.00,
        UNI: 0.00,
        LINK: 0.00,
        ATOM: 0.00,
        XLM: 0.00,
        ALGO: 0.00,
        VET: 0.00,
        ICP: 0.00,
        FIL: 0.00,
        NEAR: 0.00,
        APT: 0.00,
        HBAR: 0.00,
        QNT: 0.00,
        ARB: 0.00,
        OP: 0.00,
        INJ: 0.00,
        MKR: 0.00,
        AAVE: 0.00,
        CRV: 0.00,
        USD: 0.00,
        EUR: 0.00,
        GBP: 0.00,
        JPY: 0.00,
        AUD: 0.00,
        CAD: 0.00,
        CHF: 0.00,
        CNY: 0.00,
        INR: 0.00,
        BRL: 0.00,
        MXN: 0.00,
        KRW: 0.00,
        SGD: 0.00
      };

      function updateBalances() {
        const fromCrypto = fromCryptoSelect.value;
        const toCrypto = toCryptoSelect.value;
        fromBalanceDisplay.textContent = `Balance: ${balances[fromCrypto].toFixed(fromCrypto === 'USD' ? 2 : 8)} ${fromCrypto}`;
        toBalanceDisplay.textContent = `Balance: ${balances[toCrypto].toFixed(toCrypto === 'USD' ? 2 : 8)} ${toCrypto}`;
      }

      function updateExchangeRate() {
        const fromCrypto = fromCryptoSelect.value;
        const toCrypto = toCryptoSelect.value;
        const rate = cryptoPrices[fromCrypto] / cryptoPrices[toCrypto];
        exchangeRateDisplay.textContent = `1 ${fromCrypto} = ${rate.toFixed(fromCrypto === 'USD' || toCrypto === 'USD' ? 2 : 4)} ${toCrypto}`;
      }

      function calculateExchange() {
        const fromCrypto = fromCryptoSelect.value;
        const toCrypto = toCryptoSelect.value;
        const fromAmount = parseFloat(fromAmountInput.value) || 0;

        const fromValueUSD = fromAmount * cryptoPrices[fromCrypto];
        const toAmount = fromValueUSD / cryptoPrices[toCrypto];

        toAmountInput.value = toAmount.toFixed(toCrypto === 'USD' ? 2 : 8);
        fromUsdValue.textContent = `≈ $${fromValueUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        toUsdValue.textContent = `≈ $${fromValueUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      fromCryptoSelect.addEventListener('change', () => {
        updateBalances();
        updateExchangeRate();
        calculateExchange();
      });

      toCryptoSelect.addEventListener('change', () => {
        updateBalances();
        updateExchangeRate();
        calculateExchange();
      });

      fromAmountInput.addEventListener('input', calculateExchange);

      swapDirectionBtn.addEventListener('click', () => {
        const fromValue = fromCryptoSelect.value;
        const toValue = toCryptoSelect.value;
        fromCryptoSelect.value = toValue;
        toCryptoSelect.value = fromValue;
        updateBalances();
        updateExchangeRate();
        calculateExchange();
      });

      updateBalances();
      updateExchangeRate();

      // Handle exchange form submission
      exchangeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const fromCrypto = fromCryptoSelect.value;
        const toCrypto = toCryptoSelect.value;
        const fromAmount = parseFloat(fromAmountInput.value) || 0;
        const toAmount = parseFloat(toAmountInput.value) || 0;

        if (fromAmount > balances[fromCrypto]) {
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(239, 68, 68, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-2xl mb-3">Insufficient Balance</h3>
              <p class="text-gray-300 text-base mb-6">You don't have enough ${fromCrypto} to complete this exchange.</p>
              <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Got It</button>
            </div>
          `;
          document.body.appendChild(modal);
          return;
        }

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3">Exchange Successful!</h3>
            <p class="text-gray-300 text-base mb-2">You exchanged <span class="font-bold" style="color: #ff6b35;">${fromAmount.toFixed(fromCrypto === 'USD' ? 2 : 8)} ${fromCrypto}</span></p>
            <p class="text-gray-300 text-base mb-4">and received <span class="font-bold" style="color: #ff6b35;">${toAmount.toFixed(toCrypto === 'USD' ? 2 : 8)} ${toCrypto}</span></p>
            <p class="text-gray-400 text-sm mb-6">Your balances have been updated</p>
            <button onclick="this.closest('.fixed').remove();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    // Global variable to store transactions for filtering
    let allTransactions = [];
    let currentFilter = 'all';

    // Apply pending deposit to active loan locally (updates localStorage.activeLoan and user display)
    function applyPendingDepositToLoan(transactionId, usdAmount, btcAmount) {
      try {
        const loanRaw = localStorage.getItem('activeLoan');
        let loan = loanRaw ? JSON.parse(loanRaw) : null;
        if (!loan) {
          // No active loan metadata stored — create a minimal record to track repayments
          loan = { appliedAt: new Date().toISOString(), paidUSD: 0 };
        }

        loan.paidUSD = (Number(loan.paidUSD) || 0) + Number(usdAmount || 0);
        loan.lastPaymentAt = new Date().toISOString();

        // If we know principal, and it's fully paid, mark loan as cleared
        if (loan.principalUSD && Number(loan.paidUSD) >= Number(loan.principalUSD)) {
          loan.cleared = true;
        }

        localStorage.setItem('activeLoan', JSON.stringify(loan));

        // Add a repayment transaction record locally
        try { addTransaction('Repayment', Number(btcAmount || 0), 'Loan Repayment (pending)', Date.now(), transactionId); } catch (e) { console.debug('addTransaction failed for repayment', e); }

        // Reflect to visible user fields for immediate feedback
        try {
          const stored = JSON.parse(localStorage.getItem('user') || '{}');
          // decrement savings if deposit was already credited (not usually the case here); leave balances to authoritative update
          localStorage.setItem('user', JSON.stringify(stored));
          populateUserInfo();
          updateActiveBadges();
          if (typeof displayTopToast === 'function') displayTopToast('Deposit will be applied to loan repayment once confirmed');
        } catch (e) { /* non-fatal */ }
      } catch (e) { console.debug('applyPendingDepositToLoan failed', e); }
    }

    // Load and display user transactions
    async function loadAndDisplayTransactions() {
      try {
        const token = localStorage.getItem('token');
        const transactionContainer = document.querySelector('#transactions-page .transactions-list-container');
        if (!transactionContainer) {
          console.error('Transaction container not found');
          return;
        }

        // Show loading state immediately
        transactionContainer.innerHTML = '<div class="text-center py-8 text-gray-400">Loading transactions...</div>';

        // Fallback to avoid stuck loading state
        let loadingTimer = setTimeout(() => {
          if (transactionContainer && transactionContainer.innerHTML && transactionContainer.innerHTML.includes('Loading transactions')) {
            transactionContainer.innerHTML = '<div class="text-center py-8 text-gray-400">No transactions yet (request timed out)</div>';
            console.debug('Transactions loading timed out after 5s');
          }
        }, 5000);

        if (!token) {
          console.error('No token found in localStorage');
          clearTimeout(loadingTimer);
          transactionContainer.innerHTML = '<div class="text-center py-8 text-red-400">Please sign in to view transactions</div>';
          return;
        }
        
        console.debug('Loading transactions from API...');
        const response = await fetch(window.API_BASE + '/api/transactions', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        console.debug('API Response status:', response.status);

        if (!response.ok) {
          clearTimeout(loadingTimer);
          const text = await response.text().catch(() => '');
          console.warn('Failed to fetch transactions:', response.status, text);
          transactionContainer.innerHTML = `<div class="text-center py-8 text-red-400">Failed to load transactions (status ${response.status})</div>`;
          return;
        }

        const result = await response.json();
        console.debug('API Response payload:', result);
        clearTimeout(loadingTimer);

        // Merge server transactions with local recent transactions (avoid duplicates)
        const serverTransactions = result.data || [];
        let localRecent = [];
        try { localRecent = getTransactions() || []; } catch (e) { localRecent = []; }

        // Map local recent records into server-like shape and mark them as local/pending
        const mappedLocal = (localRecent || []).map(t => {
          const btcAmount = Number(t.amount || 0);
          const usdAmount = (btcAmount && cryptoPrices.BTC) ? (btcAmount * cryptoPrices.BTC) : (Number(t.amount) || 0);
          return {
            _id: t.id || ('local-' + (t.timestamp || Date.now())),
            id: t.id || ('local-' + (t.timestamp || Date.now())),
            type: (t.type || 'deposit'),
            amount: usdAmount,
            collateralBTC: btcAmount || undefined,
            description: t.description || '',
            status: t.status || 'pending',
            timestamp: t.timestamp || Date.now(),
            _local: true
          };
        });

        // Deduplicate: prefer server transactions, but include local ones not present on server
        const serverIds = new Set((serverTransactions || []).map(s => String(s._id || s.id || '')));
        const merged = [];
        // Start with server transactions (authoritative order)
        (serverTransactions || []).forEach(s => merged.push(s));
        // Prepend any local mapped transactions that aren't already on server
        (mappedLocal || []).forEach(l => {
          if (!serverIds.has(String(l.id))) {
            // Avoid duplicates by amount+desc+timestamp proximity as well
            const dup = merged.some(m => {
              const sameAmount = Number(m.amount || 0) === Number(l.amount || 0);
              const sameDesc = String(m.description || '') === String(l.description || '');
              const timeDiff = Math.abs((m.timestamp || 0) - (l.timestamp || 0));
              return sameAmount && sameDesc && timeDiff < 5000;
            });
            if (!dup) merged.unshift(l);
          }
        });

        allTransactions = merged;
        console.debug(`Loaded ${serverTransactions.length} server transactions, merged with ${mappedLocal.length} local recent -> total ${allTransactions.length}`);
        
        renderTransactions(currentFilter);
        // Update the profile transactions counter
        try { updateProfileTransactionsCount(); } catch (e) { console.debug('updateProfileTransactionsCount failed', e); }
      } catch (error) {
        console.error('Error loading transactions:', error);
        const transactionContainer = document.querySelector('#transactions-page .transactions-list-container');
        if (transactionContainer) {
          transactionContainer.innerHTML = `<div class="text-center py-8 text-red-400">Error loading transactions: ${error.message}</div>`;
        }
      }
    }

    // Render transactions based on filter
    function renderTransactions(filter) {
      const transactionContainer = document.querySelector('#transactions-page .transactions-list-container');
      if (!transactionContainer) return;
      
      currentFilter = filter;
      
      // Filter transactions
      let filteredTransactions = allTransactions;
      if (filter === 'deposit') {
        filteredTransactions = allTransactions.filter(tx => (tx.type || '').toLowerCase() === 'deposit');
      } else if (filter === 'withdrawal') {
        filteredTransactions = allTransactions.filter(tx => (tx.type || '').toLowerCase() === 'withdrawal');
      }
      
      console.log(`Rendering transactions. Filter: ${filter}, Total: ${allTransactions.length}, Filtered: ${filteredTransactions.length}`);
      
      if (filteredTransactions.length === 0) {
        const noTxMessage = filter === 'all' ? 'No transactions yet' : `No ${filter} transactions`;
        transactionContainer.innerHTML = `<div class="text-center py-8 text-gray-400">${noTxMessage}</div>`;
        return;
      }
      
      // Render transactions
      transactionContainer.innerHTML = filteredTransactions.map(tx => {
        const amount = tx.amount || 0;
        const type = (tx.type || '').toLowerCase();
        const status = tx.status || 'pending';
        const date = new Date(tx.timestamp || tx.createdAt || Date.now()).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        
        let icon, color, symbol;
        if (type === 'deposit') {
          icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>';
          color = '#22c55e';
          symbol = '+';
        } else if (type === 'withdrawal') {
          icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>';
          color = '#ef4444';
          symbol = '-';
        } else if (type === 'loan') {
          icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
          color = '#3b82f6';
          symbol = type === 'loan' ? '-' : '+';
        } else {
          icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>';
          color = '#ff6b35';
          symbol = '+';
        }
        
        const bgColor = color === '#22c55e' ? 'rgba(34, 197, 94, 0.1)' : 
                       color === '#ef4444' ? 'rgba(239, 68, 68, 0.1)' :
                       color === '#3b82f6' ? 'rgba(59, 130, 246, 0.1)' :
                       'rgba(255, 107, 53, 0.1)';
        
        return `
          <div class="flex items-center justify-between p-3 rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: ${bgColor};">
                <svg width="20" height="20" fill="none" stroke="${color}" viewBox="0 0 24 24">
                  ${icon}
                </svg>
              </div>
              <div>
                <p class="text-white font-semibold text-sm">${tx.description || (type.charAt(0).toUpperCase() + type.slice(1))}</p>
                <p class="text-gray-400 text-xs">${date}${status !== 'completed' ? ` • ${status}` : ''}</p>
              </div>
            </div>
            <div class="text-right w-24">
              <p class="font-semibold text-sm" style="color: ${color};">${symbol}$${amount.toFixed(2)}</p>
              <p class="text-gray-400 text-xs">${tx.collateralBTC ? (tx.collateralBTC.toFixed(4) + ' BTC') : ''}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    // Setup transaction filter button handlers
    function setupTransactionFilters() {
      const filterBtns = document.querySelectorAll('.transaction-filter-btn');
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // Remove active state from all buttons
          filterBtns.forEach(b => {
            b.classList.remove('active-filter');
            b.style.background = '';
            b.style.color = '';
            b.classList.add('text-gray-400', 'hover:text-white');
          });
          
          // Add active state to clicked button
          btn.classList.add('active-filter');
          btn.style.background = 'rgba(255, 107, 53, 0.1)';
          btn.style.color = '#ff6b35';
          btn.classList.remove('text-gray-400', 'hover:text-white');
          
          // Filter and render transactions
          const filter = btn.dataset.filter;
          renderTransactions(filter);
        });
      });
    }

    // Recent Transactions loading/display functions removed per request.
    // The transactions page still uses centralized transaction loaders; homepage section removed.
    // Centralized helper to show transactions page and load data
    function showTransactionsPage() {
      hideAllPages();
      document.getElementById('transactions-page').classList.remove('hidden');
      // Clear bottom nav active state (no dedicated transactions nav button)
      setActiveNavButton(null);
      // Show loading placeholder while fetching
      const transactionContainer = document.querySelector('#transactions-page .transactions-list-container');
      if (transactionContainer) transactionContainer.innerHTML = '<div class="text-center py-8 text-gray-400">Loading transactions...</div>';
      loadAndDisplayTransactions();
      setupTransactionFilters();
    }

    // View All Transactions button handler (homepage)
    const viewAllTransactionsBtns = document.querySelectorAll('button[id="view-all-transactions-btn"]');
    viewAllTransactionsBtns.forEach(btn => {
      btn.addEventListener('click', showTransactionsPage);
    });

    // Handle if hash in URL points to transactions (e.g., /dashboard#transactions)
    function handleHashNavigation() {
      if ((window.location.hash || '').toLowerCase().includes('transactions')) {
        showTransactionsPage();
      }
    }
    window.addEventListener('hashchange', handleHashNavigation);
    // Call once on load
    setTimeout(handleHashNavigation, 200);
    

    // Recent Transactions button handler (top bar)
    const recentTransactionsBtn = document.getElementById('recent-transactions-btn');
    if (recentTransactionsBtn) {
      recentTransactionsBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-lg w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-white font-bold text-xl">Recent Transactions</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white transition-colors">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div class="space-y-3">
              <div class="flex items-center justify-between p-3 rounded-lg" style="background: #0f0f0f;">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
                    <svg width="20" height="20" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="text-white font-semibold text-sm">Received Bitcoin</p>
                    <p class="text-gray-400 text-xs">Dec 15, 2024 • 2:45 PM</p>
                  </div>
                </div>
                <div class="text-right w-24">
                  <p class="font-bold text-sm" style="color: #ff6b35;">+0.0125 BTC</p>
                  <p class="text-gray-400 text-xs">$535.42</p>
                </div>
              </div>

              <div class="flex items-center justify-between p-3 rounded-lg" style="background: #0f0f0f;">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 69, 0, 0.1);">
                    <svg width="20" height="20" fill="none" stroke="#ff4500" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="text-white font-semibold text-sm">Sent to Wallet</p>
                    <p class="text-gray-400 text-xs">Dec 14, 2024 • 10:23 AM</p>
                  </div>
                </div>
                <div class="text-right w-24">
                  <p class="font-bold text-sm" style="color: #ff4500;">-0.0050 BTC</p>
                  <p class="text-gray-400 text-xs">$214.20</p>
                </div>
              </div>

              <div class="flex items-center justify-between p-3 rounded-lg" style="background: #0f0f0f;">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
                    <svg width="20" height="20" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="text-white font-semibold text-sm">Purchased BTC</p>
                    <p class="text-gray-400 text-xs">Dec 12, 2024 • 4:17 PM</p>
                  </div>
                </div>
                <div class="text-right w-24">
                  <p class="font-bold text-sm" style="color: #ff6b35;">+0.0200 BTC</p>
                  <p class="text-gray-400 text-xs">$856.80</p>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    // Customer Care button handler
    const customerCareBtn = document.getElementById('customer-care-btn');
    if (customerCareBtn) {
      customerCareBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(255, 107, 53, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3 text-center">Customer Care</h3>
            <p class="text-gray-400 text-sm mb-6 text-center">How can we help you today?</p>
            
            <div class="space-y-3 mb-6">
              <button class="w-full p-4 rounded-lg text-left transition-all hover-lift flex items-center gap-3" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
                  <svg width="20" height="20" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
                </div>
                <div>
                  <p class="text-white font-semibold text-sm">Live Chat</p>
                  <p class="text-gray-400 text-xs">Chat with our support team</p>
                </div>
              </button>

              <a href="mailto:support@xapobank.com" role="button" class="w-full p-4 rounded-lg text-left transition-all hover-lift flex items-center gap-3" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: rgba(255, 107, 53, 0.1);">
                  <svg width="20" height="20" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <div>
                  <p class="text-white font-semibold text-sm">Email Support</p>
                  <p class="text-gray-400 text-xs">support@xapobank.com</p>
                </div>
              </a>

              <!-- Help Center removed per request -->
            </div>

            <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-gray-300 font-bold text-sm rounded-lg transition-colors" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
              Close
            </button>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    // Withdraw Loan button handler
    const withdrawLoanBtn = document.getElementById('withdraw-loan-btn');
    if (withdrawLoanBtn) {
      withdrawLoanBtn.addEventListener('click', () => {
        try {
          // Get user data from localStorage
          const userStr = localStorage.getItem('user');
          const user = userStr ? JSON.parse(userStr) : {};
          
          // Get actual loan data
          const activeLoanId = user.activeLoanId || null;
          const activeLoanAmount = Number(user.activeLoanAmount || 0);
          const collateralBTC = Number(user.collateralBalanceBTC || 0);
          const collateralUSD = Number(user.collateralBalanceUSD || 0);
          
          // If no active loan, show styled modal
          if (!activeLoanId || activeLoanAmount <= 0) {
            const noLoanModal = document.createElement('div');
            noLoanModal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
            noLoanModal.style.background = 'rgba(0, 0, 0, 0.85)';
            noLoanModal.innerHTML = `
              <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(255, 107, 53, 0.1);">
                  <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <h3 class="text-white font-bold text-2xl mb-3">No Active Loan</h3>
                <p class="text-gray-300 text-sm mb-6">You don't have an active loan yet. Start by applying for a loan to access withdrawal features.</p>
                <div class="flex gap-3">
                  <button onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Close</button>
                  <button onclick="this.closest('.fixed').remove(); document.getElementById('borrow-btn').click();" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Apply for Loan</button>
                </div>
              </div>
            `;
            document.body.appendChild(noLoanModal);
            return;
          }

          // Calculate LTV (Loan-to-Value)
          const btcUsdPrice = (typeof cryptoPrices !== 'undefined' && cryptoPrices.BTC) ? Number(cryptoPrices.BTC) : 42000;
          const loanValueUsd = activeLoanAmount;
          const collateralValueUsd = collateralUSD > 0 ? collateralUSD : (collateralBTC * btcUsdPrice);
          const ltv = collateralValueUsd > 0 ? ((loanValueUsd / collateralValueUsd) * 100).toFixed(1) : 0;
          
          // Convert loan amount to BTC
          const availableBTC = (activeLoanAmount / btcUsdPrice).toFixed(8);
          const availableUSD = activeLoanAmount.toFixed(2);

          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(255, 107, 53, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-2xl mb-3 text-center">Withdraw Loan</h3>
              <p class="text-gray-400 text-sm mb-6 text-center">Transfer loan funds to your wallet</p>
              
              <form id="withdraw-loan-form" class="space-y-4">
                <div class="rounded-lg p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400 text-sm">Available to Withdraw</span>
                    <span class="text-white font-bold text-base">${availableBTC} BTC</span>
                  </div>
                  <div class="flex justify-between items-center mb-3">
                    <span class="text-gray-400 text-xs">USD Value</span>
                    <span class="text-gray-300 text-sm">$${availableUSD}</span>
                  </div>
                  <div class="pt-3" style="border-top: 1px solid #2a2a2a;">
                    <div class="flex justify-between items-center mb-1">
                      <span class="text-gray-400 text-xs">Collateral</span>
                      <span class="text-gray-300 text-xs">${collateralBTC.toFixed(8)} BTC</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-gray-400 text-xs">Loan-to-Value (LTV)</span>
                      <span class="text-gray-300 text-xs">${ltv}%</span>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Withdrawal Amount (BTC)</label>
                  <input type="number" id="withdraw-amount" step="0.00000001" min="0.00000001" max="${availableBTC}" placeholder="0.00000000" required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                  <div class="flex gap-2 mt-2">
                    <button type="button" onclick="document.getElementById('withdraw-amount').value = '${availableBTC}'" class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-all" style="background: #0f0f0f; color: #ff6b35; border: 1px solid #2a2a2a;">Withdraw All</button>
                    <button type="button" onclick="document.getElementById('withdraw-amount').value = '${(availableBTC / 2).toFixed(8)}'" class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-all" style="background: #0f0f0f; color: #ff6b35; border: 1px solid #2a2a2a;">Withdraw Half</button>
                  </div>
                </div>

                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Destination Wallet Address</label>
                  <input type="text" id="withdraw-destination" placeholder="bc1q..." required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                </div>

                <div class="rounded-lg p-3" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
                  <p class="text-xs leading-relaxed" style="color: #ff6b35;">
                    <svg width="14" height="14" class="inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Withdrawing will add to your active loan balance. Interest accrues at 0.0% APY.
                  </p>
                </div>
                
                <div class="flex gap-3">
                  <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                  <button type="submit" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Confirm Withdrawal</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(modal);

          const withdrawLoanForm = document.getElementById('withdraw-loan-form');
          if (withdrawLoanForm) {
            withdrawLoanForm.addEventListener('submit', (e) => {
              e.preventDefault();
              const amount = parseFloat(document.getElementById('withdraw-amount').value) || 0;
              const destination = document.getElementById('withdraw-destination').value;
              const usdValue = amount * btcUsdPrice;

              // Optimistically deduct BTC from wallet
              try { adjustLocalBalances({ btcDelta: -amount }); if (typeof displayTopToast === 'function') displayTopToast('Withdrawal submitted — BTC deducted (pending)'); } catch(e) { console.warn('Withdrawal local deduction failed', e); }

              modal.innerHTML = `
                <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                  <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                    <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h3 class="text-white font-bold text-2xl mb-3">Withdrawal Successful!</h3>
                  <p class="text-gray-300 text-base mb-2">You withdrew <span class="font-bold" style="color: #ff6b35;">${amount.toFixed(8)} BTC</span></p>
                  <p class="text-gray-400 text-sm mb-6">($${usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</p>
                  <p class="text-gray-400 text-xs mb-2">Sent to:</p>
                  <p class="text-gray-300 text-xs mb-6 break-all font-mono">${destination}</p>
                  <p class="text-gray-300 text-sm mb-6">The funds will arrive in your wallet shortly.</p>
                  <button onclick="this.closest('.fixed').remove(); location.reload();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
                </div>
              `;
            });
          }
        } catch (err) {
          console.error('Withdraw loan error:', err);
          const errorModal = document.createElement('div');
          errorModal.className = 'fixed inset-0 z-[100] flex items-center justify-center';
          errorModal.style.background = 'rgba(0, 0, 0, 0.85)';
          errorModal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(239, 68, 68, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-2xl mb-3">Error</h3>
              <p class="text-gray-300 text-sm mb-6">${err.message || 'Could not open withdraw dialog'}</p>
              <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-sm rounded-lg" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">Close</button>
            </div>
          `;
          document.body.appendChild(errorModal);
        }
      });
    }

    // Withdraw Collateral button handler
    const withdrawCollateralBtn = document.getElementById('withdraw-collateral-btn');
    if (withdrawCollateralBtn) {
      withdrawCollateralBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(255, 107, 53, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-2 text-center">Withdraw Collateral</h3>
            <p class="text-gray-400 text-sm mb-6 text-center">If you change your mind, you can cancel anytime before confirmation</p>
            
            <form id="withdraw-collateral-form" class="space-y-4">
              <div class="rounded-lg p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <div class="flex justify-between items-center mb-3">
                  <span class="text-gray-400 text-sm">Total Collateral Deposited</span>
                  <span class="text-white font-bold text-base" id="collateral-total-display">0.0000 BTC</span>
                </div>
                <div style="border-top: 1px solid #2a2a2a; padding-top: 12px;">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-400 text-xs">USD Value</span>
                    <span class="text-gray-300 text-sm" id="collateral-usd-total">$0.00</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400 text-xs">Current BTC Price</span>
                    <span class="text-gray-300 text-xs" id="current-btc-price">$0.00</span>
                  </div>
                </div>
              </div>

              <div>
                <label class="text-gray-400 text-sm mb-2 block">Withdrawal Amount (BTC)</label>
                <input type="number" id="collateral-withdraw-amount" step="0.00000001" min="0.00000001" placeholder="0.00000000" required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                <div class="flex gap-2 mt-2">
                  <button type="button" onclick="document.getElementById('collateral-withdraw-amount').value = document.getElementById('collateral-total-display').textContent.split(' ')[0]" class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-all" style="background: #0f0f0f; color: #ff6b35; border: 1px solid #2a2a2a;">Withdraw All</button>
                  <button type="button" onclick="const total = parseFloat(document.getElementById('collateral-total-display').textContent); document.getElementById('collateral-withdraw-amount').value = (total / 2).toFixed(8)" class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-all" style="background: #0f0f0f; color: #ff6b35; border: 1px solid #2a2a2a;">Withdraw Half</button>
                </div>
              </div>

              <div class="rounded-lg p-3.5" style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2);">
                <p class="text-xs leading-relaxed" style="color: #22c55e;">
                  <svg width="14" height="14" class="inline mr-1 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Withdrawn collateral will automatically be added to your BTC balance. This is a permanent action.
                </p>
              </div>
              
              <div class="flex gap-3">
                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                <button type="submit" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Confirm Withdrawal</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);

        // Set the collateral values from the user's account balance (not the loan's collateral)
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const totalCollateralBTC = user.collateralBalanceBTC || 0;
        const totalCollateralUSD = user.collateralBalanceUSD || 0;
        
        document.getElementById('collateral-total-display').textContent = totalCollateralBTC.toFixed(4) + ' BTC';
        document.getElementById('collateral-usd-total').textContent = '$' + Number(totalCollateralUSD).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        document.getElementById('current-btc-price').textContent = '$' + (cryptoPrices.BTC || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const withdrawCollateralForm = document.getElementById('withdraw-collateral-form');
        withdrawCollateralForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const amount = parseFloat(document.getElementById('collateral-withdraw-amount').value) || 0;
          
          if (amount <= 0) {
            alert('Please enter a valid amount');
            return;
          }

          // Show loading state
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 animate-spin" style="background: rgba(255, 107, 53, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-xl">Processing Withdrawal...</h3>
              <p class="text-gray-400 text-sm mt-4">Please wait while we process your request</p>
            </div>
          `;

          // Convert BTC amount to USD before calling API
          const btcAmount = amount;
          if (!cryptoPrices || !cryptoPrices.BTC || Number(cryptoPrices.BTC) <= 0) {
            alert('Current BTC price is unavailable. Please try again later.');
            modal.remove();
            return;
          }
          const usdAmount = btcAmount * cryptoPrices.BTC;

          // Show loading state
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 animate-spin" style="background: rgba(255, 107, 53, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-xl">Processing Withdrawal...</h3>
              <p class="text-gray-400 text-sm mt-4">Please wait while we process your request</p>
            </div>
          `;

          // Call API to withdraw collateral (amount is in USD)
          fetch(window.API_BASE + '/api/transactions/withdraw/collateral', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + (localStorage.getItem('token') || ''),
            },
            body: JSON.stringify({ amount: usdAmount, currency: 'USD', btcAmount: btcAmount }),
          })
          .then(res => res.json())
          .then(data => {
            if (data.isOk) {
              const usdValue = usdAmount;
              // Optimistically move collateral back to BTC balance locally
              try { adjustLocalBalances({ btcDelta: btcAmount, collateralUsdDelta: -usdAmount, collateralBtcDelta: -btcAmount }); if (typeof displayTopToast === 'function') displayTopToast('Collateral withdrawn — added to BTC wallet (pending)'); } catch(e) { console.warn('Collateral local move failed', e); }
              // Show success message (BTC and USD)
              modal.innerHTML = `
                <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                  <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                    <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h3 class="text-white font-bold text-2xl mb-3">Collateral Withdrawn!</h3>
                  <p class="text-gray-300 text-base mb-2">You withdrew <span class="font-bold" style="color: #22c55e;">${btcAmount.toFixed(8)} BTC</span></p>
                  <p class="text-gray-400 text-sm mb-6">($${usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</p>
                  <p class="text-gray-300 text-sm mb-6">This amount has been added to your BTC balance.</p>
                  <button onclick="this.closest('.fixed').remove(); location.reload();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
                </div>
              `;
            } else {
              // Show error message
              modal.innerHTML = `
                <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                  <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(239, 68, 68, 0.1);">
                    <svg width="40" height="40" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </div>
                  <h3 class="text-white font-bold text-xl mb-2">Withdrawal Failed</h3>
                  <p class="text-gray-300 text-sm mb-6">${data.error || 'An error occurred during withdrawal'}</p>
                  <button onclick="this.closest('.fixed').remove();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Try Again</button>
                </div>
              `;
            }
          })
          .catch(err => {
            console.error('Withdrawal error:', err);
            modal.innerHTML = `
              <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(239, 68, 68, 0.1);">
                  <svg width="40" height="40" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </div>
                <h3 class="text-white font-bold text-xl mb-2">Withdrawal Failed</h3>
                <p class="text-gray-300 text-sm mb-6">Unable to process withdrawal. Please try again.</p>
                <button onclick="this.closest('.fixed').remove();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Close</button>
              </div>
            `;
          });
        });
      });
    }

    // Savings button handler - Navigate to savings page
    const savingsBtn = document.getElementById('savings-btn');
    if (savingsBtn) {
      savingsBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('savings-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn'); // Keep home active since savings is accessed from home
      });
    }

    // Back to home button
    const backToHomeBtn = document.getElementById('back-to-home');
    if (backToHomeBtn) {
      backToHomeBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Cancel savings button
    const cancelSavingsBtn = document.getElementById('cancel-savings');
    if (cancelSavingsBtn) {
      cancelSavingsBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Savings form functionality
    const savingsForm = document.getElementById('savings-form');
    const radioButtons = document.querySelectorAll('.savings-radio');
    const startSavingBtn = document.getElementById('start-saving-btn');
    const savingsAmountInput = document.getElementById('savings-amount');
    const savingsProjection = document.getElementById('savings-projection');

    // Ensure clicks on Start Saving trigger the submit handler even on odd browser behaviour
    if (startSavingBtn) {
      startSavingBtn.addEventListener('click', (ev) => {
        console.log('start-saving button clicked', { disabled: startSavingBtn.disabled });
        if (startSavingBtn.disabled) {
          // Provide visual press feedback if disabled
          startSavingBtn.classList.add('shake');
          setTimeout(() => startSavingBtn.classList.remove('shake'), 300);
          ev.preventDefault();
          return;
        }

        if (savingsForm && typeof savingsForm.requestSubmit === 'function') {
          savingsForm.requestSubmit();
        } else if (savingsForm) {
          // Fallback for older browsers
          savingsForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }
      });
    }
    
    let selectedAPY = 0;
    let selectedTerm = 0;

    if (radioButtons && (radioButtons.forEach || radioButtons.length)) {
      Array.from(radioButtons).forEach(radio => {
        radio.addEventListener('change', (e) => {
          // Remove selected styling from all options
          document.querySelectorAll('.savings-plan-option > div').forEach(div => {
            div.style.borderColor = '#2a2a2a';
            div.style.background = '#1a1a1a';
          });
          
          // Add selected styling to chosen option
          const selectedDiv = e.target && e.target.parentElement && e.target.parentElement.querySelector('div');
          if (selectedDiv) {
            selectedDiv.style.borderColor = '#ff6b35';
            selectedDiv.style.background = 'rgba(255, 107, 53, 0.05)';
          }
          
          selectedAPY = parseFloat(e.target.dataset.apy) || 0;
          selectedTerm = parseInt(e.target.value) || 0;

          console.log('savings radio changed', { selectedTerm, selectedAPY });
          
          checkFormValidity();
          updateProjection();
        });
      });
    }

    if (savingsAmountInput) {
      savingsAmountInput.addEventListener('input', () => {
        console.log('savings amount input', savingsAmountInput.value);
        checkFormValidity();
        updateProjection();
      });
    }

    function checkFormValidity() {
      const hasAmount = savingsAmountInput && !isNaN(parseFloat(savingsAmountInput.value)) && parseFloat(savingsAmountInput.value) > 0;
      const hasTerm = selectedTerm > 0;
      console.log('checkFormValidity', { hasAmount, hasTerm });
      
      if (startSavingBtn) {
        if (hasAmount && hasTerm) {
          startSavingBtn.disabled = false;
          startSavingBtn.style.opacity = '1';
        } else {
          startSavingBtn.disabled = true;
          startSavingBtn.style.opacity = '0.5';
        }
        console.log('startSavingBtn.disabled ->', startSavingBtn.disabled);
      }
    }

    function updateProjection() {
      const amount = parseFloat(savingsAmountInput.value) || 0;
      const usdValue = amount * cryptoPrices.BTC;
      document.getElementById('savings-usd-value').value = formatUsd(usdValue);
      
      if (amount > 0 && selectedAPY > 0) {
        savingsProjection.classList.remove('hidden');
        
        const daysInYear = 365;
        const dailyRate = selectedAPY / 100 / daysInYear;
        const totalInterest = amount * dailyRate * selectedTerm;
        const totalAmount = amount + totalInterest;
        
        document.getElementById('initial-deposit').textContent = amount.toFixed(8) + ' BTC (' + formatUsd(amount * cryptoPrices.BTC) + ')';
        document.getElementById('interest-earned').textContent = totalInterest.toFixed(8) + ' BTC (' + formatUsd(totalInterest * cryptoPrices.BTC) + ')';
        document.getElementById('total-maturity').textContent = totalAmount.toFixed(8) + ' BTC (' + formatUsd(totalAmount * cryptoPrices.BTC) + ')';
        document.getElementById('apy-rate').textContent = selectedAPY + '% APY';
      } else {
        savingsProjection.classList.add('hidden');
      }
    }

    // Handle savings form submission
    if (savingsForm) {
      savingsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const amount = parseFloat(savingsAmountInput.value);
        console.log('savings form submitted', { amount, selectedTerm, selectedAPY });
        
        // Check if user has sufficient balance in BTC and collateral combined
        const requiredUsd = amount * cryptoPrices.BTC;
        if (!hasSufficientFunds(requiredUsd)) {
          // Get current balances for error message
          const btcBalanceElement = document.querySelector('h2.balance-value');
          let btcBalanceUsd = 0;
          if (btcBalanceElement) {
            const btcBalance = parseFloat(btcBalanceElement.textContent) || 0;
            btcBalanceUsd = btcBalance * cryptoPrices.BTC;
          }
          
          let collateralBalanceUsd = 0;
          const collateralElements = document.querySelectorAll('p.text-white.text-lg.sm\\:text-xl.font-bold');
          if (collateralElements.length >= 2) {
            const collateralElement = collateralElements[1];
            const usdElement = collateralElement.nextElementSibling;
            if (usdElement) {
              const usdText = usdElement.textContent.replace('$', '').replace(',', '');
              collateralBalanceUsd = parseFloat(usdText) || 0;
            }
          }
          
          const totalAvailable = btcBalanceUsd + collateralBalanceUsd;
          // Show styled modal with breakdown
          showInsufficientFundsModal(requiredUsd, totalAvailable, btcBalanceUsd, collateralBalanceUsd);
          return;  
        }

        try {
          // Create savings deposit transaction
          const response = await fetch(window.API_BASE + '/api/transactions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              type: 'deposit',
              amount: amount * cryptoPrices.BTC, // USD amount
              collateralBTC: 0, // Not collateral
              description: `Savings Deposit - ${selectedTerm} days at ${selectedAPY}% APY`,
              status: 'pending'
            })
          });

          const result = await response.json();
          if (!result.isOk) {
            alert('Failed to create savings deposit transaction: ' + (result.error || 'Unknown error'));
            return;
          }

          const daysInYear = 365;
          const dailyRate = selectedAPY / 100 / daysInYear;
          const totalInterest = amount * dailyRate * selectedTerm;
          const totalAmount = amount + totalInterest;
          const maturityDate = new Date();
          maturityDate.setDate(maturityDate.getDate() + selectedTerm);
          // Normalize maturity date to noon UTC to avoid timezone off-by-one when serializing/parsing
          maturityDate.setUTCHours(12, 0, 0, 0);
          console.log('Computed maturityDate (ISO)', maturityDate.toISOString());
          
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-2xl mb-3">Savings Plan Submitted!</h3>
              <p class="text-gray-300 text-base mb-6">processing</p>
            
            <div class="rounded-lg p-5 mb-6" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
              <div class="mb-4 pb-4" style="border-bottom: 1px solid #2a2a2a;">
                <p class="text-gray-400 text-xs mb-2">Locked Amount</p>
                <p class="text-white font-bold text-xl">${amount.toFixed(8)} BTC</p>
              </div>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <p class="text-gray-400 text-xs mb-1">Term Length</p>
                  <p class="text-white font-semibold text-sm">${selectedTerm} Days</p>
                </div>
                <div>
                  <p class="text-gray-400 text-xs mb-1">Interest Rate</p>
                  <p class="font-semibold text-sm" style="color: #ff6b35;">${selectedAPY}% APY</p>
                </div>
              </div>
              <div class="pt-4" style="border-top: 1px solid #2a2a2a;">
                <p class="text-gray-400 text-xs mb-1">Expected Earnings</p>
                <p class="font-bold text-lg" style="color: #ff6b35;">${totalInterest.toFixed(8)} BTC</p>
                <p class="text-gray-400 text-xs mt-1">Total at maturity: ${totalAmount.toFixed(8)} BTC</p>
              </div>
            </div>

            <div class="rounded-lg p-3 mb-6" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
              <p class="text-xs" style="color: #ff6b35;">
                <svg width="14" height="14" class="inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Matures on ${maturityDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </p>
            </div>

            <button onclick="this.closest('.fixed').remove(); document.getElementById('savings-page').classList.add('hidden'); document.getElementById('home-page').classList.remove('hidden'); (function(){ const start = new Date(); const maturity = new Date('${maturityDate.toISOString()}'); const payload = { amount: ${amount}, apy: ${selectedAPY}, term: ${selectedTerm}, startDate: start.toISOString(), maturityDate: maturity.toISOString() }; try { localStorage.setItem('activeSavings', JSON.stringify(payload)); } catch(e){} try { adjustLocalBalances({ btcDelta: -(${amount}) }); } catch(e){} updateActiveSavings(${amount}, ${selectedAPY}, ${selectedTerm}, maturity, start); })();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
          </div>
        `;
        document.body.appendChild(modal);
        } catch (error) {
          console.error('Savings deposit error:', error);
          alert('Failed to submit savings deposit. Please try again.');
        }
      });
    }

    // Membership button handler - Navigate to membership page
    const membershipBtn = document.getElementById('membership-btn');
    if (membershipBtn) {
      membershipBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('membership-page').classList.remove('hidden');
        setActiveNavButton('membership-btn');
      });
    }

    // Back to home from membership
    const backToHomeMembership = document.getElementById('back-to-home-membership');
    if (backToHomeMembership) {
      backToHomeMembership.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Cancel membership button
    const cancelMembershipBtn = document.getElementById('cancel-membership');
    if (cancelMembershipBtn) {
      cancelMembershipBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Apply membership button - Payment interface
    const applyMembershipPageBtn = document.getElementById('apply-membership-page-btn');
    if (applyMembershipPageBtn) {
      applyMembershipPageBtn.addEventListener('click', () => {
        // Check if user already has active membership
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.isMember && user.membershipExpiresAt && new Date(user.membershipExpiresAt) > new Date()) {
          const expiry = new Date(user.membershipExpiresAt);
          const now = new Date();
          const diffMs = expiry.getTime() - now.getTime();
          const days = Math.max(0, Math.ceil(diffMs / (1000 * 60 * 60 * 24)));
          
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-lg w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-white font-bold text-2xl">Membership Active</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                  <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4" style="background: rgba(34, 197, 94, 0.1);">
                  <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <h4 class="text-white font-bold text-2xl mb-2">Premium Member</h4>
                <p class="text-gray-400 text-sm">Your membership is active and valid for ${days} more days.</p>
              </div>
              <div class="mb-6">
                <div class="rounded-lg p-4" style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.1);">
                  <p class="text-gray-300 text-sm"><strong>Expires on:</strong> ${expiry.toLocaleDateString()}</p>
                  <p class="text-gray-300 text-sm mt-2">You can renew your membership after it expires.</p>
                </div>
              </div>
              <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-sm rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Close</button>
            </div>
          `;
          document.body.appendChild(modal);
          return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-lg w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-white font-bold text-2xl">Premium Membership Payment</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div class="text-center mb-6">
              <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4" style="background: rgba(255, 107, 53, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h4 class="text-white font-bold text-3xl mb-2">$1,000</h4>
              <p class="text-gray-400 text-sm">Premium Membership Fee</p>
            </div>

            <div class="mb-6">
              <p class="text-gray-300 text-sm mb-2">By proceeding, <strong>$1,000</strong> will be deducted from your dashboard account for this subscription. Confirm to proceed.</p>
              <div class="rounded-lg p-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.1);">
                <p class="text-gray-300 text-sm">This will be processed from your dashboard balances. If you don't have enough balance, you'll be prompted to deposit.</p>
              </div>
            </div>

            <div id="wallet-address-section" class="hidden mb-6">
              <label class="text-gray-400 text-sm mb-3 block">Deposit Address</label>
              <div class="p-4 rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <p class="text-white font-mono text-sm break-all" id="wallet-address">bc1qrg0gn9w0e945cpdvk72435fr0xr6lxwz8wqrt2</p>
                <button onclick="navigator.clipboard.writeText(document.getElementById('wallet-address').textContent)" class="mt-3 px-4 py-2 text-xs font-semibold rounded-lg transition-all hover-lift" style="background: rgba(255, 107, 53, 0.1); color: #ff6b35;">
                  <svg width="16" height="16" class="inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                  </svg>
                  Copy Address
                </button>
              </div>
              <div class="mt-4 p-4 rounded-lg" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
                <h5 class="text-white font-semibold mb-2">Payment Instructions</h5>
                <ul class="text-gray-300 text-sm space-y-1">
                  <li>• Send exactly the required amount to the address above</li>
                  <li>• Include the network fee in your transaction</li>
                  <li>• Payment will be confirmed within 10-30 minutes</li>
                  <li>• Membership will be activated automatically after confirmation</li>
                </ul>
              </div>
            </div>

            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-xl transition-all hover-lift" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
              <button id="proceed-payment-btn" class="flex-1 py-3 text-white font-bold text-sm rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100);" disabled>Proceed to Payment</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        // Membership payment now deducts from dashboard balances (no external network selection)
        const proceedBtn = modal.querySelector('#proceed-payment-btn');
        proceedBtn.disabled = false;
        proceedBtn.textContent = 'Proceed';

        // Handle proceed payment - confirm deduction from dashboard
        proceedBtn.addEventListener('click', () => {
          const confirmModal = document.createElement('div');
          confirmModal.className = 'fixed inset-0 z-[101] flex items-center justify-center overflow-y-auto p-4';
          confirmModal.style.background = 'rgba(0, 0, 0, 0.85)';
          confirmModal.innerHTML = `
            <div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <h3 class="text-white font-bold text-xl mb-3">Confirm Subscription Payment</h3>
              <p class="text-gray-300 text-sm mb-4">$1,000 will be deducted from your dashboard account for this subscription. Do you want to proceed?</p>
              <div class="flex gap-3">
                <button id="confirm-cancel-btn" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                <button id="confirm-pay-btn" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Confirm & Pay</button>
              </div>
            </div>
          `;
          document.body.appendChild(confirmModal);

          const cancelBtn = confirmModal.querySelector('#confirm-cancel-btn');
          const confirmBtn = confirmModal.querySelector('#confirm-pay-btn');

          cancelBtn.addEventListener('click', () => confirmModal.remove());

          confirmBtn.addEventListener('click', async () => {
            try {
              const user = JSON.parse(localStorage.getItem('user') || '{}');
              const savings = Number(user.savingsBalanceUSD || 0);
              const btcBalance = Number(user.btcBalance || 0);
              const amountUsd = 1000;
              const price = Number((window.cryptoPrices && window.cryptoPrices.BTC) || (window.currentBtcPrice) || 42000);
              const btcUsd = Number((btcBalance || 0) * (price || 42000));
              const totalAvailable = Number((savings || 0) + (btcUsd || 0));

              // If insufficient combined funds, prompt to deposit (do not show processing yet)
              if (totalAvailable < amountUsd) {
                // close confirm and membership modals to avoid UI stacking/glitches
                try { confirmModal.remove(); } catch(e){}
                try { modal.remove(); } catch(e){}
                const insuffModal = document.createElement('div');
                insuffModal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
                insuffModal.style.background = 'rgba(0, 0, 0, 0.85)';
                insuffModal.innerHTML = `
                  <div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                    <h3 class="text-white font-bold text-xl mb-3">Insufficient Dashboard Balance</h3>
                    <div class="flex gap-3">
                      <button id="insuff-cancel" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                      <button id="insuff-deposit" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Add Funds</button>
                    </div>
                  </div>
                `;
                document.body.appendChild(insuffModal);
                const cancelBtn2 = insuffModal.querySelector('#insuff-cancel');
                const depositBtn = insuffModal.querySelector('#insuff-deposit');
                if (cancelBtn2) cancelBtn2.addEventListener('click', () => { insuffModal.remove(); });
                if (depositBtn) depositBtn.addEventListener('click', () => {
                  // Close modal and redirect user to the deposit UI (open Add Funds)
                  try { insuffModal.remove(); } catch(e){}
                  const addBtn = document.getElementById('add-funds-btn');
                  try { if (addBtn) addBtn.click(); else window.location.href = 'dashboard.html#deposit'; } catch(e) { console.debug('redirect to deposit failed', e); }
                });
                return;
              }

              // Sufficient funds: perform server-side internal payment so balances update server-side
              confirmBtn.disabled = true;
              confirmBtn.textContent = 'Confirming...';
              try {
                const resp = await fetch(window.API_BASE + '/api/transactions', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                  body: JSON.stringify({ type: 'membership', amount: 1000, description: 'Premium Membership Fee', status: 'completed', internalPayment: true })
                });
                const result = await resp.json().catch(() => ({}));
                if (!result || !result.isOk) {
                  // If server reports insufficient internal funds, show deposit flow
                  confirmBtn.disabled = false;
                  confirmBtn.textContent = 'Confirm & Pay';
                  const msg = (result && result.error) ? result.error : 'Failed to process membership payment';
                  // Show insuff modal if error message indicates insufficient funds
                  if (String(msg).toLowerCase().includes('insufficient')) {
                    try { confirmModal.remove(); modal.remove(); } catch(e){}
                    const insuffModal2 = document.createElement('div');
                    insuffModal2.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
                    insuffModal2.style.background = 'rgba(0, 0, 0, 0.85)';
                    insuffModal2.innerHTML = `
                      <div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                        <h3 class="text-white font-bold text-xl mb-3">Insufficient Dashboard Balance</h3>
                        <div class="flex gap-3">
                          <button id="insuff-cancel-2" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                          <button id="insuff-deposit-2" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Add Funds</button>
                        </div>
                      </div>
                    `;
                    document.body.appendChild(insuffModal2);
                    const c2 = insuffModal2.querySelector('#insuff-cancel-2'); if (c2) c2.addEventListener('click', () => insuffModal2.remove());
                    const d2 = insuffModal2.querySelector('#insuff-deposit-2'); if (d2) d2.addEventListener('click', () => { try { insuffModal2.remove(); const addBtn=document.getElementById('add-funds-btn'); if(addBtn) addBtn.click(); } catch(e){} });
                    return;
                  }
                  // otherwise show generic failure
                  const failEl = document.createElement('div'); failEl.className='fixed inset-0 z-[105] flex items-center justify-center p-4'; failEl.style.background='rgba(0,0,0,0.85)'; failEl.innerHTML=`<div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background:#1a1a1a;border:1px solid #2a2a2a;"><p class="text-white">${msg}</p><button onclick="this.closest('.fixed').remove()" class="mt-4 w-full py-2 rounded-lg" style="background:#ff6b35;color:#fff">Close</button></div>`; document.body.appendChild(failEl);
                } else {
                  // Success: poll server for updated user (membership) and refresh UI
                  try {
                    let gotMember = false;
                    for (let i = 0; i < 6; i++) {
                      try {
                        const meResp = await fetch(window.API_BASE + '/api/auth/me', { headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` } });
                        const meJson = await meResp.json().catch(() => ({}));
                        if (meJson && meJson.success && meJson.data) {
                          localStorage.setItem('user', JSON.stringify(meJson.data));
                          if (meJson.data.isMember) { gotMember = true; break; }
                        }
                      } catch (e) { /* ignore */ }
                      await new Promise(r => setTimeout(r, 500));
                    }
                    try { await populateUserInfo(); } catch(e) { console.debug('populate after membership failed', e); }
                    try { updateActiveBadges(); } catch(e) {}
                    if (!gotMember) console.debug('Membership success acknowledged by transaction create, but user.isMember not visible yet');
                  } catch(e) { console.debug('membership poll failed', e); }
                  confirmModal.remove(); modal.remove();
                  const successModal = document.createElement('div');
                  successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[102] p-4';
                  successModal.innerHTML = `
                    <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                      <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                        <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                      </div>
                      <h3 class="text-white font-bold text-2xl mb-3">Subscription Activated!</h3>
                      <p class="text-gray-300 text-base mb-6">$1,000 has been deducted and your premium membership is active.</p>
                      <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Got It</button>
                    </div>
                  `;
                  document.body.appendChild(successModal);
                  try { addTransaction('Membership', -amountUsd, 'Premium Membership Fee', Date.now()); } catch (e) { console.debug('addTransaction failed', e); }
                }
              } catch (err) {
                console.error('Server membership transaction failed', err);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm & Pay';
                const failEl = document.createElement('div'); failEl.className='fixed inset-0 z-[105] flex items-center justify-center p-4'; failEl.style.background='rgba(0,0,0,0.85)'; failEl.innerHTML=`<div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background:#1a1a1a;border:1px solid #2a2a2a;"><p class="text-white">Failed to process payment. Please try again.</p><button onclick="this.closest('.fixed').remove()" class="mt-4 w-full py-2 rounded-lg" style="background:#ff6b35;color:#fff">Close</button></div>`; document.body.appendChild(failEl);
              }

            } catch (error) {
              console.error('Membership payment flow failed', error);
              const failMsg = document.createElement('div'); failMsg.className='fixed inset-0 z-[105] flex items-center justify-center p-4'; failMsg.style.background='rgba(0,0,0,0.85)'; failMsg.innerHTML=`<div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background:#1a1a1a;border:1px solid #2a2a2a;"><p class="text-white">Failed to process payment. Please try again.</p><button onclick="this.closest('.fixed').remove()" class="mt-4 w-full py-2 rounded-lg" style="background:#ff6b35;color:#fff">Close</button></div>`; document.body.appendChild(failMsg);
              confirmBtn.disabled = false;
              confirmBtn.textContent = 'Confirm & Pay';
            }
          });
        });
      });
    }

    // View Savings Details button handler
    const viewSavingsDetailsBtn = document.getElementById('view-savings-details-btn');
    if (viewSavingsDetailsBtn) {
      viewSavingsDetailsBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-white font-bold text-xl">Savings Details</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white transition-colors">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div class="rounded-lg p-5 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Plan Type</span>
                <span class="text-white font-semibold text-sm">180-Day Fixed</span>
              </div>
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Initial Deposit</span>
                <span class="text-white font-semibold text-sm">0.0000 BTC</span>
              </div>
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Interest Rate</span>
                <span class="font-semibold text-sm" style="color: #ff6b35;">0.0% APY</span>
              </div>
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Days Elapsed</span>
                <span class="text-white font-semibold text-sm">133 of 180</span>
              </div>
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Interest Earned</span>
                <span class="font-semibold text-sm" style="color: #ff6b35;">0.0095 BTC</span>
              </div>
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Start Date</span>
                <span class="text-white font-semibold text-sm">Aug 15, 2024</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Maturity Date</span>
                <span class="text-white font-semibold text-sm">Feb 11, 2025</span>
              </div>
            </div>

            <div class="rounded-lg p-4 mb-6 text-center" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
              <p class="text-gray-400 text-xs mb-2">Total at Maturity</p>
              <p id="active-total-maturity-btc" class="text-white font-bold text-2xl mb-1">0.0000 BTC</p>
              <p id="active-total-maturity-usd" class="text-gray-300 text-sm">$0.00 USD</p>
            </div> 

            <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Close</button>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    // Withdraw Savings Early button handler
    const withdrawSavingsBtn = document.getElementById('withdraw-savings-btn');
    if (withdrawSavingsBtn) {
      withdrawSavingsBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-md w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-white font-bold text-xl">Early Withdrawal</h3>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white transition-colors">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div class="rounded-lg p-4 mb-4" style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2);">
              <div class="flex items-start gap-3">
                <svg width="20" height="20" class="flex-shrink-0 mt-0.5" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div>
                  <p class="text-white text-sm font-semibold mb-2">Early Withdrawal Penalty</p>
                  <p class="text-gray-300 text-xs leading-relaxed">Withdrawing before maturity will result in a 25% penalty on earned interest. Your principal remains safe.</p>
                </div>
              </div>
            </div>

            <div class="rounded-lg p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Principal Amount</span>
                <span class="text-white font-semibold text-sm">0.0000 BTC</span>
              </div>
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Interest Earned</span>
                <span class="font-semibold text-sm" style="color: #22c55e;">0.0095 BTC</span>
              </div>
              <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid #2a2a2a;">
                <span class="text-gray-400 text-sm">Penalty (25%)</span>
                <span class="text-sm font-semibold" style="color: #ef4444;">-0.0024 BTC</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-white font-semibold text-sm">You'll Receive</span>
                <span class="text-white font-bold text-base">0.0921 BTC</span>
              </div>
            </div>

            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
              <button onclick="const parent = this.closest('.fixed'); parent.innerHTML = '<div class=\\'rounded-2xl p-8 max-w-md w-full mx-4 text-center\\' style=\\'background: #1a1a1a; border: 1px solid #2a2a2a;\\'><div class=\\'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6\\' style=\\'background: rgba(34, 197, 94, 0.1);\\'><svg width=\\'40\\' height=\\'40\\' fill=\\'none\\' stroke=\\'#22c55e\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\\'></path></svg></div><h3 class=\\'text-white font-bold text-2xl mb-3\\'>Withdrawal Complete!</h3><p class=\\'text-gray-300 text-base mb-2\\'>You received <span class=\\'font-bold\\' style=\\'color: #ff6b35;\\'>0.0921 BTC</span></p><p class=\\'text-gray-400 text-sm mb-6\\'>The funds have been transferred to your wallet. Thank you for saving with us!</p><button onclick=\\'this.closest(\\'.fixed\\').remove(); location.reload();\\' class=\\'w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift\\' style=\\'background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);\\'>Done</button></div>';" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: #ef4444;">Confirm Withdrawal</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    // Repayment button handler
    const repaymentBtn = document.getElementById('repayment-btn');
    if (repaymentBtn) {
      repaymentBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 my-8" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(255, 107, 53, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3 text-center">Make Repayment</h3>
            <p class="text-gray-400 text-sm mb-6 text-center">Pay back your loan amount</p>
            
            <form id="repayment-form" class="space-y-4">
              <div class="rounded-lg p-4 mb-4" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-gray-400 text-sm">Remaining Balance</span>
                  <span class="text-white font-bold text-base">0.0123 BTC</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-400 text-xs">USD Value</span>
                  <span class="text-gray-300 text-sm">$527.25</span>
                </div>
              </div>

              <div>
                <label class="text-gray-400 text-sm mb-2 block">Repayment Amount (BTC)</label>
                <input type="number" id="repayment-amount" step="0.00000001" min="0.00000001" max="0.0123" placeholder="0.00000000" required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none transition-all" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                <div class="flex gap-2 mt-2">
                  <button type="button" onclick="document.getElementById('repayment-amount').value = '0.0123'" class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-all" style="background: #0f0f0f; color: #ff6b35; border: 1px solid #2a2a2a;">Pay Full</button>
                  <button type="button" onclick="document.getElementById('repayment-amount').value = '0.00615'" class="flex-1 px-3 py-2 text-xs font-semibold rounded-lg transition-all" style="background: #0f0f0f; color: #ff6b35; border: 1px solid #2a2a2a;">Pay Half</button>
                </div>
              </div>
              
              <div class="flex gap-3">
                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                <button type="submit" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Confirm Payment</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);

        const repaymentForm = document.getElementById('repayment-form');
        repaymentForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const amount = parseFloat(document.getElementById('repayment-amount').value) || 0;
          const usdValue = amount * cryptoPrices.BTC;

          // Check local balances: prefer savings USD, fallback to BTC wallet
          try {
            const stored = JSON.parse(localStorage.getItem('user') || '{}');
            const savings = Number(stored.savingsBalanceUSD || 0);
            const btcBal = Number(stored.btcBalance || 0);

            if (savings >= usdValue) {
              // Deduct from savings USD and apply to loan locally
              stored.savingsBalanceUSD = Number((savings - usdValue).toFixed(2));
              localStorage.setItem('user', JSON.stringify(stored));
              populateUserInfo();

              // Update local activeLoan paid amount
              try {
                let loan = JSON.parse(localStorage.getItem('activeLoan') || '{}') || {};
                loan.paidUSD = (Number(loan.paidUSD) || 0) + usdValue;
                loan.lastPaymentAt = new Date().toISOString();
                localStorage.setItem('activeLoan', JSON.stringify(loan));
              } catch (e) { console.debug('Failed updating local activeLoan paidUSD', e); }

              try { addTransaction('Repayment', amount, 'Loan Repayment', Date.now()); } catch (e) { console.debug('addTransaction failed', e); }

              modal.innerHTML = `
                <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                  <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                    <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h3 class="text-white font-bold text-2xl mb-3">Payment Successful!</h3>
                  <p class="text-gray-300 text-base mb-2">You paid <span class="font-bold" style="color: #ff6b35;">${amount.toFixed(8)} BTC</span></p>
                  <p class="text-gray-400 text-sm mb-6">($${usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</p>
                  <p class="text-gray-300 text-sm mb-6">Your loan balance has been updated.</p>
                  <button onclick="this.closest('.fixed').remove(); location.reload();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
                </div>
              `;
              return;
            }

            if (btcBal >= amount) {
              // Deduct BTC wallet and apply to loan locally
              stored.btcBalance = Number((btcBal - amount).toFixed(8));
              localStorage.setItem('user', JSON.stringify(stored));
              populateUserInfo();

              try {
                let loan = JSON.parse(localStorage.getItem('activeLoan') || '{}') || {};
                loan.paidUSD = (Number(loan.paidUSD) || 0) + usdValue;
                loan.lastPaymentAt = new Date().toISOString();
                localStorage.setItem('activeLoan', JSON.stringify(loan));
              } catch (e) { console.debug('Failed updating local activeLoan paidUSD', e); }

              try { addTransaction('Repayment', amount, 'Loan Repayment', Date.now()); } catch (e) { console.debug('addTransaction failed', e); }

              modal.innerHTML = `
                <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                  <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                    <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h3 class="text-white font-bold text-2xl mb-3">Payment Successful!</h3>
                  <p class="text-gray-300 text-base mb-2">You paid <span class="font-bold" style="color: #ff6b35;">${amount.toFixed(8)} BTC</span></p>
                  <p class="text-gray-400 text-sm mb-6">($${usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})</p>
                  <p class="text-gray-300 text-sm mb-6">Your loan balance has been updated.</p>
                  <button onclick="this.closest('.fixed').remove(); location.reload();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
                </div>
              `;
              return;
            }

            // Otherwise, not enough balance locally — offer to deposit to dashboard and auto-apply to loan
            modal.innerHTML = `
              <div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                <h3 class="text-white font-bold text-xl mb-4">Insufficient Dashboard Balance</h3>
                <p class="text-gray-400 text-sm mb-4">You don't have enough balance in your dashboard to pay ${amount.toFixed(8)} BTC (${formatUsd(usdValue)}). You can deposit funds and apply the deposit directly to your loan repayment.</p>
                <div class="flex gap-3">
                  <button id="repay-deposit-btn" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Deposit & Apply to Loan</button>
                  <button onclick="this.closest('.fixed').remove();" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                </div>
              </div>
            `;

            const repayDepositBtn = document.getElementById('repay-deposit-btn');
            if (repayDepositBtn) {
              repayDepositBtn.addEventListener('click', async () => {
                try {
                  // Start a deposit flow and mark the resulting pending deposit to apply to loan
                  const { transactionId, assignedAddress } = await createDepositFlow({ usdAmount: usdValue, btcAmount: amount, description: 'Loan Repayment' });
                  try {
                    const pending = JSON.parse(localStorage.getItem('pendingDeposits') || '{}');
                    if (pending && pending[transactionId]) {
                      pending[transactionId].applyToLoan = true;
                      localStorage.setItem('pendingDeposits', JSON.stringify(pending));
                      console.debug('Marked deposit for loan repayment', transactionId);
                    }
                  } catch (e) { console.debug('failed to mark deposit for loan', e); }
                } catch (err) {
                  console.error('Failed to initiate deposit', err);
                }
                // close the modal
                try { document.querySelectorAll('.fixed.inset-0.z-\[100\]')[0].remove(); } catch (e) {}
              });
            }

          } catch (error) {
            console.error('Repayment handler failed', error);
            alert('Failed to process repayment locally. Please deposit to your dashboard.');
          }
        });
      });
    }

    // Identity verification logic removed from client (no-op)

    // Navigation Management System
    function hideAllPages() {
      document.getElementById('home-page').classList.add('hidden');
      document.getElementById('exchange-page').classList.add('hidden');
      document.getElementById('savings-page').classList.add('hidden');
      document.getElementById('membership-page').classList.add('hidden');
      document.getElementById('settings-page').classList.add('hidden');
      document.getElementById('card-page').classList.add('hidden');
      document.getElementById('loans-page').classList.add('hidden');
      document.getElementById('stocks-page').classList.add('hidden');
      document.getElementById('transactions-page').classList.add('hidden');
    }

    function setActiveNavButton(buttonId) {
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = document.getElementById(buttonId);
      if (activeBtn) activeBtn.classList.add('active');
    }

    // Home button handler
    const homeNavBtn = document.getElementById('home-nav-btn');
    if (homeNavBtn) {
      homeNavBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Card button handler - Navigate to card page
    const cardBtn = document.getElementById('card-btn');
    if (cardBtn) {
      cardBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('card-page').classList.remove('hidden');
        setActiveNavButton('card-btn');
      });
    }

    // Back to home from card
    const backToHomeCard = document.getElementById('back-to-home-card');
    if (backToHomeCard) {
      backToHomeCard.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Order card button handler
    const orderCardBtn = document.getElementById('order-card-btn');
    if (orderCardBtn) {
      orderCardBtn.addEventListener('click', () => {
        // Check if user is a member
        if (!userData || !userData.isMember) {
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(255, 107, 53, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-2xl mb-3">Membership Required</h3>
              <p class="text-gray-300 text-base mb-6">You need to be a premium member to order a card. Please subscribe to our $1000 membership plan first.</p>
              <div class="flex gap-3">
                <button onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                <button onclick="this.closest('.fixed').remove(); document.getElementById('membership-btn').click();" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Go to Membership</button>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          return;
        }

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(255, 107, 53, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3">Order Your Xapo Card</h3>
            <p class="text-gray-300 text-base mb-2">Your card will be delivered to:</p>
            <div class="rounded-lg p-4 mb-6 text-left" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
              <p id="delivery-name" class="text-white font-semibold text-sm mb-1">Loading...</p>
              <p class="text-gray-400 text-sm">123 Main Street, Apt 4B</p>
              <p class="text-gray-400 text-sm">New York, NY 10001</p>
              <p class="text-gray-400 text-sm">United States</p>
            </div>
            <p class="text-gray-400 text-sm mb-6">Please allow 7-14 business days for delivery. You will receive a tracking number via email.</p>
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
              <button onclick="const parent = this.closest('.fixed'); parent.innerHTML = '<div class=\\'rounded-2xl p-8 max-w-md w-full mx-4 text-center\\' style=\\'background: #1a1a1a; border: 1px solid #2a2a2a;\\'><div class=\\'w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6\\' style=\\'background: rgba(34, 197, 94, 0.1);\\'><svg width=\\'40\\' height=\\'40\\' fill=\\'none\\' stroke=\\'#22c55e\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\\'></path></svg></div><h3 class=\\'text-white font-bold text-2xl mb-3\\'>Card Order Confirmed!</h3><p class=\\'text-gray-300 text-base mb-6\\'>Your Xapo Card has been ordered successfully. We\\'ll send you a tracking number within 2-3 business days.</p><button onclick=\\'this.closest(\\'.fixed\\').remove(); location.reload();\\' class=\\'w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift\\' style=\\'background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);\\'>Done</button></div>';" class="flex-1 py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Confirm Order</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    // Update address button handler
    const updateAddressBtn = document.getElementById('update-address-btn');
    if (updateAddressBtn) {
      updateAddressBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-md w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <h3 class="text-white font-bold text-xl mb-6">Update Delivery Address</h3>
            <form class="space-y-4">
              <div>
                <label class="text-gray-400 text-sm mb-2 block">Street Address</label>
                <input type="text" value="123 Main Street, Apt 4B" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">City</label>
                  <input type="text" value="New York" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                </div>
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">State/Province</label>
                  <input type="text" value="NY" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Postal Code</label>
                  <input type="text" value="10001" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                </div>
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Country</label>
                  <input type="text" value="United States" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
                </div>
              </div>
              <div class="flex gap-3 pt-2">
                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                <button type="submit" onclick="event.preventDefault(); this.closest('.fixed').remove();" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Save Address</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    // Loans button handler - Navigate to loans page
    const loansBtn = document.getElementById('loans-btn');
    if (loansBtn) {
      loansBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('loans-page').classList.remove('hidden');
        setActiveNavButton('loans-btn');
      });
    }

    // Back to home from loans
    const backToHomeLoans = document.getElementById('back-to-home-loans');
    if (backToHomeLoans) {
      backToHomeLoans.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Loan Calculator functionality
    const loanCalculatorForm = document.getElementById('loan-calculator-form');
    const loanCollateralInput = document.getElementById('loan-collateral-amount');
    const loanCollateralUsdInput = document.getElementById('loan-collateral-usd');
    const availableLoanBtc = document.getElementById('available-loan-btc');
    const availableLoanUsd = document.getElementById('available-loan-usd');
    const loanPeriodRadios = document.querySelectorAll('.loan-period-radio');
    // LTV is now fixed at 50% (removed selector)
    const loanResults = document.getElementById('loan-results');
    
    const btcPrice = 89229.21; // Fixed BTC price for calculations
    const apr = 10.50; // Annual Percentage Rate
    
    // BTC to USD converter
    let isUpdatingCollateral = false;
    
    if (loanCollateralInput) {
      // Initialize with user's actual collateral balance
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      let userCollateralBTC = user.collateralBalanceBTC || 0;
      
      // If BTC is 0 or missing but USD is available, convert USD to BTC using btcPrice
      if (userCollateralBTC === 0 && user.collateralBalanceUSD > 0) {
        userCollateralBTC = user.collateralBalanceUSD / btcPrice;
      }
      
      // Set both fields consistently using the same btcPrice
      loanCollateralInput.value = userCollateralBTC.toFixed(8);
      loanCollateralUsdInput.value = (userCollateralBTC * btcPrice).toFixed(2);
      updateAvailableLoan(userCollateralBTC);
      
      loanCollateralInput.addEventListener('input', () => {
        if (isUpdatingCollateral) return;
        isUpdatingCollateral = true;
        
        const btcAmount = parseFloat(loanCollateralInput.value) || 0;
        const livePrice = cryptoPrices.BTC || btcPrice;
        const usdValue = btcAmount * livePrice;
        loanCollateralUsdInput.value = usdValue.toFixed(2);
        updateAvailableLoan(btcAmount);
        
        isUpdatingCollateral = false;
      });
    }
    
    if (loanCollateralUsdInput) {
      loanCollateralUsdInput.addEventListener('input', () => {
        if (isUpdatingCollateral) return;
        isUpdatingCollateral = true;
        
        const usdAmount = parseFloat(loanCollateralUsdInput.value) || 0;
        const livePrice = cryptoPrices.BTC || btcPrice;
        const btcValue = usdAmount / livePrice;
        loanCollateralInput.value = btcValue.toFixed(8);
        updateAvailableLoan(btcValue);
        
        isUpdatingCollateral = false;
      });
    }
    
    function updateAvailableLoan(btcAmount) {
      const loanBtc = btcAmount * 0.7; // 70% LTV
      const livePrice = cryptoPrices.BTC || btcPrice;
      const loanUsd = loanBtc * livePrice;
      
      if (availableLoanBtc) {
        availableLoanBtc.textContent = loanBtc.toFixed(8) + ' BTC';
      }
      if (availableLoanUsd) {
        availableLoanUsd.textContent = '$' + loanUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
    }

    // Handle loan period selection styling
    loanPeriodRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        document.querySelectorAll('.loan-period-option > div').forEach(div => {
          div.style.borderColor = '#2a2a2a';
          div.style.background = '#0f0f0f';
        });
        const selectedDiv = e.target.parentElement.querySelector('div');
        selectedDiv.style.borderColor = '#ff6b35';
        selectedDiv.style.background = 'rgba(255, 107, 53, 0.05)';
      });
    });

    // LTV selection removed - using fixed 50% value

    // Handle loan calculator form submission
    if (loanCalculatorForm) {
      loanCalculatorForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const collateralBTC = parseFloat(loanCollateralInput.value) || 0;
        const selectedPeriod = parseInt(document.querySelector('input[name="loan-period"]:checked').value);
        const selectedLTV = 50; // Fixed LTV at 50%
        
        // Calculate loan values using live BTC price
        const livePrice = cryptoPrices.BTC || btcPrice;
        const collateralUSD = collateralBTC * livePrice;
        const loanAmount = collateralUSD * (selectedLTV / 100);
        const daysInYear = 365;
        const interestRate = apr / 100;
        const dailyRate = interestRate / daysInYear;
        const estimatedInterest = loanAmount * dailyRate * selectedPeriod;
        const totalRepayment = loanAmount + estimatedInterest;
        
        // Update results
        document.getElementById('result-period').textContent = `${selectedPeriod} days`;
        document.getElementById('result-ltv').textContent = `${selectedLTV}%`;
        document.getElementById('result-apr').textContent = `${apr.toFixed(2)}%`;
        document.getElementById('result-air').textContent = `${apr.toFixed(2)}%`;
        document.getElementById('result-fees').textContent = 'USD 0';
        document.getElementById('result-repayment-fees').textContent = 'USD 0';
        document.getElementById('result-interest').textContent = `USD ${estimatedInterest.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('result-total').textContent = `USD ${totalRepayment.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        // Show results
        loanResults.classList.remove('hidden');
        loanResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    }

    // Apply for loan button handler
    const applyForLoanBtn = document.getElementById('apply-for-loan-btn');
    if (applyForLoanBtn) {
      applyForLoanBtn.addEventListener('click', () => {
        // Require membership before allowing loan application
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user || !user.isMember) {
          // Show membership required modal
          const m = document.createElement('div');
          m.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          m.style.background = 'rgba(0, 0, 0, 0.85)';
          m.innerHTML = `
            <div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <h3 class="text-white font-bold text-xl mb-3">Membership Required</h3>
              <p class="text-gray-300 text-sm mb-4">You must acquire a premium membership to borrow loans. Would you like to apply now?</p>
              <div class="flex gap-3">
                <button onclick="this.closest('.fixed').remove();" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                <button id="go-to-membership" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Apply Membership</button>
              </div>
            </div>
          `;
          document.body.appendChild(m);
          const goto = document.getElementById('go-to-membership');
          if (goto) goto.addEventListener('click', () => {
            try { document.querySelector('.fixed.inset-0.z-\[100\]')?.remove(); } catch(e){}
            // Open membership page
            try { document.getElementById('membership-page')?.classList.remove('hidden'); } catch(e){}
            try { document.getElementById('loans-page')?.classList.add('hidden'); } catch(e){}
            // Scroll to membership
            try { document.getElementById('membership-page')?.scrollIntoView({ behavior: 'smooth' }); } catch(e){}
          });
          return;
        }

        // Check if user has an active unpaid loan
        if (user.activeLoanId && user.activeLoanAmount && Number(user.activeLoanAmount) > 0) {
          const dueDate = user.activeLoanDueDate ? new Date(user.activeLoanDueDate) : null;
          const loanAmount = Number(user.activeLoanAmount || 0);
          
          const m = document.createElement('div');
          m.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          m.style.background = 'rgba(0, 0, 0, 0.85)';
          m.innerHTML = `
            <div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4" style="background: rgba(255, 107, 53, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#ff6b35" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-xl mb-3">Active Loan</h3>
              <p class="text-gray-300 text-sm mb-4">You have an active loan with an outstanding balance of <strong>$${loanAmount.toFixed(2)}</strong>.</p>
              <div class="rounded-lg p-3 mb-4" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.1);">
                <p class="text-gray-300 text-sm"><strong>Outstanding Amount:</strong> $${loanAmount.toFixed(2)}</p>
                ${dueDate ? `<p class="text-gray-300 text-sm mt-2"><strong>Due Date:</strong> ${dueDate.toLocaleDateString()}</p>` : ''}
                <p class="text-gray-400 text-xs mt-2">Please repay your current loan before borrowing again.</p>
              </div>
              <button onclick="this.closest('.fixed').remove();" class="w-full py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">OK</button>
            </div>
          `;
          document.body.appendChild(m);
          return;
        }

        // Check if user has sufficient funds
        if (!hasSufficientFunds(1000)) { // Assuming minimum loan amount or check
          const funds = getAvailableFunds();
          showInsufficientFundsModal(1000, funds.totalAvailable, funds.btcUsd, funds.collateralUsd, 'Insufficient funds to apply');
          return;
        }

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3">Loan Application</h3>
            <p class="text-gray-300 text-base mb-6">Your loan application has been submitted successfully. your loan will be dispatched to your account within 5 minutes.</p>
            <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Got It</button>
          </div>
        `;
        document.body.appendChild(modal);
        try {
          // Build a richer local activeLoan record so the dashboard can display immediately
          const appliedAt = new Date().toISOString();
          // Preferred sources: available loan USD, collateral input, result period
          const availableLoanUsdEl = document.getElementById('available-loan-usd');
          const collateralInput = document.getElementById('loan-collateral-amount');
          const resultPeriodEl = document.getElementById('result-period');

          let principalUSD = 0;
          try {
            if (availableLoanUsdEl) principalUSD = Number((availableLoanUsdEl.textContent || '').toString().replace(/[^0-9.\-]/g, '')) || 0;
            // fallback to result-total if available
            if (!principalUSD) {
              const resultTotal = document.getElementById('result-total');
              if (resultTotal) principalUSD = Number((resultTotal.textContent || '').toString().replace(/[^0-9.\-]/g, '')) || 0;
            }
          } catch (e) { principalUSD = 0; }

          const btcPrice = Number(cryptoPrices.BTC || 0) || 0;
          const principalBTC = btcPrice > 0 ? (Number(principalUSD) / btcPrice) : 0;

          // Collateral (BTC) from input if present
          let collateralBTC = 0;
          try { collateralBTC = Number(collateralInput?.value || 0) || 0; } catch(e) { collateralBTC = 0; }

          // Parse selected period (e.g. "365 days")
          let periodDays = 30;
          try {
            if (resultPeriodEl) {
              const m = (resultPeriodEl.textContent || '').match(/(\d+)/);
              if (m) periodDays = Number(m[1]) || 30;
            }
          } catch (e) { periodDays = 30; }

          const dueDate = new Date();
          dueDate.setDate(dueDate.getDate() + (periodDays || 30));

          const activeLoanObj = {
            appliedAt,
            dueDate: dueDate.toISOString(),
            principalUSD: Number(principalUSD) || 0,
            principalBTC: Number(principalBTC) || 0,
            collateralBTC: Number(collateralBTC) || 0,
            paidUSD: 0,
            lastPaymentAt: null,
          };

          localStorage.setItem('activeLoan', JSON.stringify(activeLoanObj));

          // Also update the local `user` object so other UI checks that use user.activeLoan* work
          try {
            const userRaw = localStorage.getItem('user');
            const localUser = userRaw ? JSON.parse(userRaw) : {};
            localUser.activeLoan = true;
            localUser.activeLoanId = localUser.activeLoanId || `loan-${Date.now()}`;
            localUser.activeLoanAmount = Number(activeLoanObj.principalUSD) || 0;
            localUser.activeLoanDueDate = activeLoanObj.dueDate;
            localStorage.setItem('user', JSON.stringify(localUser));
          } catch (e) { console.debug('failed updating local user loan fields', e); }

          // Update on-page displays immediately
          try {
            const loanBtcEl = document.getElementById('loan-btc-amount');
            const collBtcEl = document.getElementById('collateral-btc-amount');
            const collUsdEl = document.getElementById('collateral-usd-amount');
            if (loanBtcEl) loanBtcEl.textContent = `${activeLoanObj.principalBTC.toFixed(8)} BTC`;
            if (collBtcEl) collBtcEl.textContent = `${activeLoanObj.collateralBTC.toFixed(8)} BTC`;
            if (collUsdEl) collUsdEl.textContent = formatUsd(activeLoanObj.collateralBTC * btcPrice);
          } catch(e) { console.debug('failed updating loan ui', e); }

          try { updateActiveBadges(); } catch(e) {}
          try { updateDaysUntilDue(); } catch(e) {}
        } catch(e) { console.debug('apply-for-loan local persist failed', e); }
      });
    }

    // Stocks button handler - Navigate to stocks page
    const stocksBtn = document.getElementById('stocks-btn');
    if (stocksBtn) {
      stocksBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('stocks-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
        // Render portfolio and load live stocks data when entering stocks page
        renderPortfolio();
        if (typeof loadStocksPage === 'function') loadStocksPage();
      });
    }

    // Transactions button handler - Navigate to transactions page
    const transactionsBtn = document.getElementById('transactions-btn');
    if (transactionsBtn) {
      transactionsBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('transactions-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // View all transactions button handler
    const viewAllTransactionsBtn = document.getElementById('view-all-transactions-btn');
    if (viewAllTransactionsBtn) {
      viewAllTransactionsBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('transactions-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Back to home from transactions
    const backToHomeFromTransactions = document.getElementById('back-to-home-from-transactions');
    if (backToHomeFromTransactions) {
      backToHomeFromTransactions.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Load stocks/popular and user's portfolio and render into page
    // Portfolio management functions
    function getTransactions() {
      const transactions = localStorage.getItem('user-transactions');
      return transactions ? JSON.parse(transactions) : [];
    }

    function saveTransactions(transactions) {
      localStorage.setItem('user-transactions', JSON.stringify(transactions));
    }

    function addTransaction(type, amount, description, timestamp, id) {
      const transactions = getTransactions();
      const ts = timestamp || Date.now();

      // Deduplicate by id when available, otherwise by amount+description+time window
      const exists = transactions.some(t => {
        if (id && t.id) return String(t.id) === String(id);
        const sameAmount = Number(t.amount) === Number(amount);
        const sameDesc = String(t.description) === String(description);
        const timeDiff = Math.abs((t.timestamp || 0) - ts);
        return sameAmount && sameDesc && timeDiff < 5000; // 5s window
      });

      if (exists) {
        console.debug('Skipping duplicate transaction add', { type, amount, description, timestamp, id });
        return;
      }

      transactions.unshift({ type, amount, description, timestamp: ts, id });
      // Keep only last 10
      if (transactions.length > 10) transactions.splice(10);
      saveTransactions(transactions);
      renderTransactions();
      // Refresh profile counter whenever a local transaction is added
      try { updateProfileTransactionsCount(); } catch (e) { console.debug('updateProfileTransactionsCount failed', e); }
    }

    function renderTransactions() {
      const transactions = getTransactions();
      const listEl = document.getElementById('transactions-list') || document.querySelector('#transactions-page .transactions-list-container');
      if (!listEl) return;
      listEl.innerHTML = '';
      transactions.forEach(tx => {
        const date = new Date(tx.timestamp);
        const dateStr = date.toLocaleDateString() + ' • ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const color = tx.amount >= 0 ? '#ff6b35' : '#ff4500';
        const sign = tx.amount >= 0 ? '+' : '';
        const amountStr = tx.amount >= 0 ? `${sign}${tx.amount.toFixed(4)} BTC` : `${tx.amount.toFixed(4)} BTC`;
        const usdStr = `$${(Math.abs(tx.amount) * cryptoPrices.BTC).toFixed(2)}`;
        const icon = tx.amount >= 0 ? 
          `<svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" /></svg>` :
          `<svg width="20" height="20" fill="none" stroke="#ff4500" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6" /></svg>`;
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 rounded-lg hover-lift transition-all';
        div.style.background = '#0f0f0f';
        div.style.border = '1px solid #2a2a2a';
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
              ${icon}
            </div>
            <div>
              <p class="text-white font-semibold text-sm">${tx.type}</p>
              <p class="text-gray-400 text-xs">${dateStr}</p>
            </div>
          </div>
          <div class="text-right w-24">
            <p class="font-bold text-sm" style="color: ${color};">${amountStr}</p>
            <p class="text-gray-400 text-xs">${usdStr}</p>
          </div>
        `;
        listEl.appendChild(div);
      });
    }

    function getPortfolio() {
      try {
        return JSON.parse(localStorage.getItem('stockPortfolio') || '{}');
      } catch (e) {
        return {};
      }
    }

    function savePortfolio(portfolio) {
      localStorage.setItem('stockPortfolio', JSON.stringify(portfolio));
    }

    function addStockToPortfolio(symbol, quantity, price) {
      const portfolio = getPortfolio();
      if (portfolio[symbol]) {
        portfolio[symbol].quantity += quantity;
        portfolio[symbol].avgPrice = ((portfolio[symbol].avgPrice * portfolio[symbol].quantity) + (price * quantity)) / (portfolio[symbol].quantity + quantity);
      } else {
        portfolio[symbol] = { quantity, avgPrice: price };
      }
      savePortfolio(portfolio);
      renderPortfolio();
    }

    function renderPortfolio() {
      const portfolio = getPortfolio();
      const listEl = document.getElementById('portfolio-list');
      if (!listEl) return;
      
      // Clear existing items
      listEl.innerHTML = '';
      let totalValue = 0;
      
      // Check if portfolio is empty
      const portfolioKeys = Object.keys(portfolio);
      if (portfolioKeys.length === 0) {
        listEl.innerHTML = '<p class="text-gray-400 text-center py-8 text-xs">No stocks in your portfolio yet. Start trading!</p>';
        // Update total to 0
        const totalEl = document.querySelector('#stocks-page p.text-white.font-bold.text-3xl');
        if (totalEl) totalEl.textContent = '$0.00';
        return;
      }
      
      // Render each stock holding
      portfolioKeys.forEach(symbol => {
        const holding = portfolio[symbol];
        if (!holding || !holding.quantity) return;
        
        const currentValue = holding.quantity * holding.avgPrice;
        totalValue += currentValue;
        const change = 0;
        const changeColor = change >= 0 ? '#22c55e' : '#ef4444';
        
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 rounded-lg';
        div.style.background = '#0f0f0f';
        div.style.border = '1px solid #2a2a2a';
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
              <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
            </div>
            <div>
              <p class="text-white font-semibold text-sm">${symbol}</p>
              <p class="text-gray-400 text-xs">${holding.quantity.toFixed(4)} shares @ $${holding.avgPrice.toFixed(2)}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-white font-bold text-sm">$${currentValue.toFixed(2)}</p>
            <p class="text-xs font-semibold text-right" style="color: ${changeColor};">${change.toFixed(1)}%</p>
          </div>
        `;
        listEl.appendChild(div);
      });
      
      // Update total portfolio value
      const totalEl = document.querySelector('#stocks-page p.text-white.font-bold.text-3xl');
      if (totalEl) {
        totalEl.textContent = '$' + totalValue.toFixed(2);
      }
    }

    async function loadStocksPage() {
      const API_BASE = (window.API_BASE && String(window.API_BASE).replace(/\/$/, '')) || 'http://localhost:5000';
      // Fetch popular stocks
      try {
        const resp = await fetch(`${API_BASE}/api/stocks/popular`);
        if (resp.ok) {
          const json = await resp.json();
          const list = document.getElementById('popular-list');
          if (list && json && json.data) {
            list.innerHTML = '';
            json.data.forEach(s => {
              const btn = document.createElement('button');
              btn.className = 'stock-item w-full p-4 rounded-lg text-left transition-all hover-lift';
              btn.style.background = '#0f0f0f';
              btn.style.border = '1px solid #2a2a2a';
              btn.dataset.symbol = s.symbol;
              btn.dataset.name = s.name || '';
              btn.dataset.price = (s.price !== null && typeof s.price !== 'undefined') ? String(s.price) : '';
              btn.dataset.change = (s.changePct !== null && typeof s.changePct !== 'undefined') ? String(s.changePct) : '';
              btn.innerHTML = `
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
                      <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                    </div>
                    <div>
                      <p class="text-white font-bold text-sm">${s.symbol}</p>
                      <p class="text-gray-400 text-xs">${s.name || ''}</p>
                    </div>
                  </div>
                  <div class="text-right w-24">
                    <p class="text-white font-bold text-base text-right">${s.price ? ('$' + Number(s.price).toFixed(2)) : '-'}</p>
                    <p class="text-xs font-semibold text-right" style="color: ${Number(s.changePct || 0) >= 0 ? '#22c55e' : '#ef4444'};">${s.changePct ? (Number(s.changePct).toFixed(2) + '%') : ''}</p>
                  </div>
                </div>`;
              list.appendChild(btn);
            });
            // rebind click handlers for newly rendered .stock-item
            bindStockItemClicks();
          }
        }
      } catch (e) {
        console.warn('Failed to load popular stocks', e);
      }

      // Load user's portfolio from localStorage
      renderPortfolio();
    }

    function bindStockItemClicks() {
      document.querySelectorAll('.stock-item').forEach(item => {
        item.removeEventListener && item.removeEventListener('click', ()=>{});
        item.addEventListener('click', () => {
          const symbol = item.dataset.symbol;
          const name = item.dataset.name;
          const price = item.dataset.price;
          const change = item.dataset.change;

          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-6 max-w-md w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h3 class="text-white font-bold text-xl">${symbol}</h3>
                  <p class="text-gray-400 text-sm">${name}</p>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white transition-colors">
                  <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>

              <div class="rounded-lg p-4 mb-6" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <p class="text-gray-400 text-xs mb-1">Current Price</p>
                <div class="flex items-baseline gap-2">
                  <p class="text-white font-bold text-3xl">${price ? ('$' + Number(price).toFixed(2)) : '-'}</p>
                  <span class="text-xs font-semibold" style="color: ${Number(change) >= 0 ? '#22c55e' : '#ef4444'};">${change ? (Number(change).toFixed(2) + '%') : ''}</span>
                </div>
              </div>

              <form id="stock-trade-form" class="space-y-4">
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Order Type</label>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="cursor-pointer">
                      <input type="radio" name="order-type" value="buy" checked class="hidden">
                      <div id="buy-option" class="rounded-lg p-3 text-center transition-all" style="background: rgba(34, 197, 94, 0.05); border: 2px solid #22c55e;">Buy</div>
                    </label>
                    <label class="cursor-pointer">
                      <input type="radio" name="order-type" value="sell" class="hidden">
                      <div id="sell-option" class="rounded-lg p-3 text-center transition-all" style="background: rgba(255, 69, 0, 0.03); border: 2px solid transparent;">Sell</div>
                    </label>
                  </div>
                </div>
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Quantity</label>
                  <input type="number" name="quantity" min="0.0001" step="0.0001" required class="form-input w-full px-4 py-3 text-sm" placeholder="0.00">
                </div>
                <button type="submit" class="w-full py-3 text-white font-bold text-sm transition-all hover-lift rounded-full" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">
                  <span class="submit-text">Buy Stock</span>
                  <span class="submit-loading hidden">Loading...</span>
                </button>
              </form>
            </div>`;
          document.body.appendChild(modal);

          const tradeForm = modal.querySelector('#stock-trade-form');
          const submitBtn = tradeForm.querySelector('button[type="submit"]');
          const submitText = submitBtn.querySelector('.submit-text');
          const submitLoading = submitBtn.querySelector('.submit-loading');
          
          tradeForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const fd = new FormData(tradeForm);
            const side = fd.get('order-type');
            const quantity = Number(fd.get('quantity'));
            if (!quantity || quantity <= 0) return alert('Invalid quantity');

            // Check balance for buy orders
            if (side === 'buy') {
              const requiredUsd = quantity * Number(price);
              if (!hasSufficientFunds(requiredUsd)) {
                const funds = getAvailableFunds();
                showInsufficientFundsModal(requiredUsd, funds.totalAvailable, funds.btcUsd, funds.collateralUsd, 'Insufficient funds for order');
                return;
              }
              
              // Show loading state
              submitBtn.disabled = true;
              submitText.classList.add('hidden');
              submitLoading.classList.remove('hidden');
              
              // Simulate processing delay
              await new Promise(resolve => setTimeout(resolve, 1500));
              
              // Process the order
              addStockToPortfolio(symbol, quantity, Number(price));
              const totalCost = (quantity * Number(price)).toFixed(2);
              const btcSpent = Number(totalCost) / (cryptoPrices.BTC || 42000);
              addTransaction('Stock Purchase', -btcSpent, `Bought ${quantity} shares of ${symbol}`, Date.now());
              
              // Render portfolio immediately and deduct locally
              renderPortfolio();
              try { adjustLocalBalances({ btcDelta: -btcSpent }); if (typeof displayTopToast === 'function') displayTopToast('Order placed — balance deducted (pending)'); } catch(e) { console.warn('Order local deduction failed', e); }
              
              // Show success modal
              const successModal = document.createElement('div');
              successModal.className = 'fixed inset-0 z-[101] flex items-center justify-center overflow-y-auto';
              successModal.style.background = 'rgba(0, 0, 0, 0.85)';
              successModal.innerHTML = `
                <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                  <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                    <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h3 class="text-white text-xl font-bold mb-2">Purchase Successful!</h3>
                  <p class="text-gray-400 text-sm mb-1">You bought <span class="text-green-400 font-semibold">${quantity} shares</span> of <span class="text-green-400 font-semibold">${symbol}</span></p>
                  <p class="text-gray-400 text-sm mb-6">Total: <span class="text-green-400 font-semibold">$${totalCost}</span></p>
                  <p class="text-gray-500 text-xs mb-6">Your stocks appear in "My Portfolio" where you can manage them.</p>
                  <button onclick="this.closest('div').parentElement.remove(); document.querySelector('.fixed[style*=\'0.85\']')?.remove(); renderPortfolio();" class="w-full py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition-all">View Portfolio</button>
                </div>
              `;
              document.body.appendChild(successModal);
              
              // Auto-close after 5 seconds
              setTimeout(() => {
                successModal.remove();
                modal.remove();
                renderPortfolio();
              }, 5000);
            } else {
              alert('Sell not implemented yet');
            }
          });
        });
      });
    }

    // Back to home from stocks
    const backToHomeStocks = document.getElementById('back-to-home-stocks');
    if (backToHomeStocks) {
      backToHomeStocks.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Stock item click handler - Show trading modal
    const stockItems = document.querySelectorAll('.stock-item');
    stockItems.forEach(item => {
      item.addEventListener('click', () => {
        const symbol = item.dataset.symbol;
        const name = item.dataset.name;
        const price = item.dataset.price;
        const change = item.dataset.change;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-md w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="text-white font-bold text-xl">${symbol}</h3>
                <p class="text-gray-400 text-sm">${name}</p>
              </div>
              <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white transition-colors">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <div class="rounded-lg p-4 mb-6" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
              <p class="text-gray-400 text-xs mb-1">Current Price</p>
              <div class="flex items-baseline gap-2">
                <p class="text-white font-bold text-3xl">$${price}</p>
                <span class="text-xs font-semibold" style="color: ${parseFloat(change) >= 0 ? '#22c55e' : '#ef4444'};">${change}%</span>
              </div>
            </div>

            <form id="stock-trade-form" class="space-y-4">
              <div>
                <label class="text-gray-400 text-sm mb-2 block">Order Type</label>
                <div class="grid grid-cols-2 gap-3">
                  <label class="cursor-pointer">
                    <input type="radio" name="order-type" value="buy" checked class="hidden">
                    <div id="buy-option" class="rounded-lg p-3 text-center transition-all" style="background: rgba(34, 197, 94, 0.05); border: 2px solid #22c55e;">
                      <p class="font-bold text-sm" style="color: #22c55e;">Buy</p>
                    </div>
                  </label>
                  <label class="cursor-pointer">
                    <input type="radio" name="order-type" value="sell" class="hidden">
                    <div id="sell-option" class="rounded-lg p-3 text-center transition-all" style="background: #0f0f0f; border: 2px solid #2a2a2a;">
                      <p class="text-white font-bold text-sm">Sell</p>
                    </div>
                  </label>
                </div>
              </div>

              <div>
                <label class="text-gray-400 text-sm mb-2 block">Number of Shares</label>
                <input type="number" id="stock-shares" min="1" step="1" placeholder="1" required class="w-full px-4 py-3 rounded-lg text-white text-sm outline-none" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
              </div>

              <div class="rounded-lg p-3" style="background: rgba(255, 107, 53, 0.05); border: 1px solid rgba(255, 107, 53, 0.2);">
                <div class="flex justify-between items-center">
                  <span class="text-gray-400 text-xs">Total Cost</span>
                  <span id="total-cost" class="font-bold text-sm" style="color: #ff6b35;">$${price}</span>
                </div>
              </div>

              <button type="submit" class="w-full py-3 text-white font-bold text-sm rounded-lg transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Place Order</button>
            </form>
          </div>
        `;
        document.body.appendChild(modal);

        // Update order type styling
        const buyOption = document.getElementById('buy-option');
        const sellOption = document.getElementById('sell-option');
        const orderTypeRadios = modal.querySelectorAll('input[name="order-type"]');
        
        orderTypeRadios.forEach(radio => {
          radio.addEventListener('change', (e) => {
            if (e.target.value === 'buy') {
              buyOption.style.background = 'rgba(34, 197, 94, 0.05)';
              buyOption.style.borderColor = '#22c55e';
              buyOption.querySelector('p').style.color = '#22c55e';
              sellOption.style.background = '#0f0f0f';
              sellOption.style.borderColor = '#2a2a2a';
              sellOption.querySelector('p').style.color = 'white';
            } else {
              sellOption.style.background = 'rgba(239, 68, 68, 0.05)';
              sellOption.style.borderColor = '#ef4444';
              sellOption.querySelector('p').style.color = '#ef4444';
              buyOption.style.background = '#0f0f0f';
              buyOption.style.borderColor = '#2a2a2a';
              buyOption.querySelector('p').style.color = 'white';
            }
          });
        });

        // Update total cost
        const sharesInput = document.getElementById('stock-shares');
        const totalCostEl = document.getElementById('total-cost');
        
        sharesInput.addEventListener('input', () => {
          const shares = parseInt(sharesInput.value) || 1;
          const total = shares * parseFloat(price);
          totalCostEl.textContent = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        });

        // Handle form submission
        const tradeForm = document.getElementById('stock-trade-form');
        tradeForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const orderType = modal.querySelector('input[name="order-type"]:checked').value;
          const shares = parseInt(sharesInput.value) || 1;
          const total = shares * parseFloat(price);

          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h3 class="text-white font-bold text-2xl mb-3">Order Placed!</h3>
              <p class="text-gray-300 text-base mb-2">You ${orderType === 'buy' ? 'bought' : 'sold'} <span class="font-bold" style="color: #ff6b35;">${shares} ${shares === 1 ? 'share' : 'shares'}</span></p>
              <p class="text-gray-300 text-base mb-6">of ${symbol} for <span class="font-bold" style="color: #ff6b35;">$${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span></p>
              <p class="text-gray-400 text-sm mb-6">Your portfolio has been updated</p>
              <button onclick="this.closest('.fixed').remove();" class="w-full py-3 text-white font-bold text-base rounded-xl transition-all hover-lift" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Done</button>
            </div>
          `;
        });
      });
    });

    function getPortfolio() {
      try {
        return JSON.parse(localStorage.getItem('stockPortfolio') || '{}');
      } catch (e) {
        return {};
      }
    }

    function savePortfolio(portfolio) {
      localStorage.setItem('stockPortfolio', JSON.stringify(portfolio));
    }

    function addStockToPortfolio(symbol, quantity, price) {
      const portfolio = getPortfolio();
      if (portfolio[symbol]) {
        portfolio[symbol].quantity += quantity;
        portfolio[symbol].avgPrice = ((portfolio[symbol].avgPrice * portfolio[symbol].quantity) + (price * quantity)) / (portfolio[symbol].quantity + quantity);
      } else {
        portfolio[symbol] = { quantity, avgPrice: price };
      }
      savePortfolio(portfolio);
      renderPortfolio();
    }

    function renderPortfolio() {
      const portfolio = getPortfolio();
      const listEl = document.getElementById('portfolio-list');
      if (!listEl) return;
      
      // Clear existing items
      listEl.innerHTML = '';
      let totalValue = 0;
      
      // Check if portfolio is empty
      const portfolioKeys = Object.keys(portfolio);
      if (portfolioKeys.length === 0) {
        listEl.innerHTML = '<p class="text-gray-400 text-center py-8 text-xs">No stocks in your portfolio yet. Start trading!</p>';
        // Update total to 0
        const totalEl = document.querySelector('#stocks-page p.text-white.font-bold.text-3xl');
        if (totalEl) totalEl.textContent = '$0.00';
        return;
      }
      
      // Render each stock holding
      portfolioKeys.forEach(symbol => {
        const holding = portfolio[symbol];
        if (!holding || !holding.quantity) return;
        
        const currentValue = holding.quantity * holding.avgPrice;
        totalValue += currentValue;
        const change = 0;
        const changeColor = change >= 0 ? '#22c55e' : '#ef4444';
        
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 rounded-lg';
        div.style.background = '#0f0f0f';
        div.style.border = '1px solid #2a2a2a';
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
              <svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
            </div>
            <div>
              <p class="text-white font-semibold text-sm">${symbol}</p>
              <p class="text-gray-400 text-xs">${holding.quantity.toFixed(4)} shares @ $${holding.avgPrice.toFixed(2)}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-white font-bold text-sm">$${currentValue.toFixed(2)}</p>
            <p class="text-xs font-semibold text-right" style="color: ${changeColor};">${change.toFixed(1)}%</p>
          </div>
        `;
        listEl.appendChild(div);
      });
      
      // Update total portfolio value
      const totalEl = document.querySelector('#stocks-page p.text-white.font-bold.text-3xl');
      if (totalEl) {
        totalEl.textContent = '$' + totalValue.toFixed(2);
      }
    }

    async function loadStocksPage() {
      const API_BASE = (window.API_BASE && String(window.API_BASE).replace(/\/$/, '')) || 'http://localhost:5000';
      // Fetch popular stocks
      try {
        const resp = await fetch(`${API_BASE}/api/stocks/popular`);
        if (resp.ok) {
          const json = await resp.json();
          const list = document.getElementById('popular-list');
          if (list && json && json.data) {
            list.innerHTML = '';
            json.data.forEach(s => {
              const btn = document.createElement('button');
              btn.className = 'stock-item w-full p-4 rounded-lg text-left transition-all hover-lift';
              btn.style.background = '#0f0f0f';
              btn.style.border = '1px solid #2a2a2a';
              btn.dataset.symbol = s.symbol;
              btn.dataset.name = s.name || '';
              btn.dataset.price = (s.price !== null && typeof s.price !== 'undefined') ? String(s.price) : '';
              btn.dataset.change = (s.changePct !== null && typeof s.changePct !== 'undefined') ? String(s.changePct) : '';
              btn.innerHTML = `
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
                      <svg width="24" height="24" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                    </div>
                    <div>
                      <p class="text-white font-bold text-sm">${s.symbol}</p>
                      <p class="text-gray-400 text-xs">${s.name || ''}</p>
                    </div>
                  </div>
                  <div class="text-right w-24">
                    <p class="text-white font-bold text-base text-right">${s.price ? ('$' + Number(s.price).toFixed(2)) : '-'}</p>
                    <p class="text-xs font-semibold text-right" style="color: ${Number(s.changePct || 0) >= 0 ? '#22c55e' : '#ef4444'};">${s.changePct ? (Number(s.changePct).toFixed(2) + '%') : ''}</p>
                  </div>
                </div>`;
              list.appendChild(btn);
            });
            // rebind click handlers for newly rendered .stock-item
            bindStockItemClicks();
          }
        }
      } catch (e) {
        console.warn('Failed to load popular stocks', e);
      }

      // Load user's portfolio from localStorage
      renderPortfolio();
    }

    function bindStockItemClicks() {
      document.querySelectorAll('.stock-item').forEach(item => {
        item.removeEventListener && item.removeEventListener('click', ()=>{});
        item.addEventListener('click', () => {
          const symbol = item.dataset.symbol;
          const name = item.dataset.name;
          const price = item.dataset.price;
          const change = item.dataset.change;

          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-6 max-w-md w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h3 class="text-white font-bold text-xl">${symbol}</h3>
                  <p class="text-gray-400 text-sm">${name}</p>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white transition-colors">
                  <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>

              <div class="rounded-lg p-4 mb-6" style="background: #0f0f0f; border: 1px solid #2a2a2a;">
                <p class="text-gray-400 text-xs mb-1">Current Price</p>
                <div class="flex items-baseline gap-2">
                  <p class="text-white font-bold text-3xl">${price ? ('$' + Number(price).toFixed(2)) : '-'}</p>
                  <span class="text-xs font-semibold" style="color: ${Number(change) >= 0 ? '#22c55e' : '#ef4444'};">${change ? (Number(change).toFixed(2) + '%') : ''}</span>
                </div>
              </div>

              <form id="stock-trade-form" class="space-y-4">
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Order Type</label>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="cursor-pointer">
                      <input type="radio" name="order-type" value="buy" checked class="hidden">
                      <div id="buy-option" class="rounded-lg p-3 text-center transition-all" style="background: rgba(34, 197, 94, 0.05); border: 2px solid #22c55e;">Buy</div>
                    </label>
                    <label class="cursor-pointer">
                      <input type="radio" name="order-type" value="sell" class="hidden">
                      <div id="sell-option" class="rounded-lg p-3 text-center transition-all" style="background: rgba(255, 69, 0, 0.03); border: 2px solid transparent;">Sell</div>
                    </label>
                  </div>
                </div>
                <div>
                  <label class="text-gray-400 text-sm mb-2 block">Quantity</label>
                  <input type="number" name="quantity" min="0.0001" step="0.0001" required class="form-input w-full px-4 py-3 text-sm" placeholder="0.00">
                </div>
                <button type="submit" class="w-full py-3 text-white font-bold text-sm transition-all hover-lift rounded-full" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">
                  <span class="submit-text">Buy Stock</span>
                  <span class="submit-loading hidden">Loading...</span>
                </button>
              </form>
            </div>`;
          document.body.appendChild(modal);

          const tradeForm = modal.querySelector('#stock-trade-form');
          const submitBtn = tradeForm.querySelector('button[type="submit"]');
          const submitText = submitBtn.querySelector('.submit-text');
          const submitLoading = submitBtn.querySelector('.submit-loading');
          
          tradeForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const fd = new FormData(tradeForm);
            const side = fd.get('order-type');
            const quantity = Number(fd.get('quantity'));
            if (!quantity || quantity <= 0) return alert('Invalid quantity');

            // Check balance for buy orders
            if (side === 'buy') {
              const requiredUsd = quantity * Number(price);
              if (!hasSufficientFunds(requiredUsd)) {
                const funds = getAvailableFunds();
                showInsufficientFundsModal(requiredUsd, funds.totalAvailable, funds.btcUsd, funds.collateralUsd, 'Insufficient funds for order');
                return;
              }
              
              // Show loading state
              submitBtn.disabled = true;
              submitText.classList.add('hidden');
              submitLoading.classList.remove('hidden');
              
              // Simulate processing delay
              await new Promise(resolve => setTimeout(resolve, 1500));
              
              // Process the order
              addStockToPortfolio(symbol, quantity, Number(price));
              const totalCost = (quantity * Number(price)).toFixed(2);
              const btcSpent = Number(totalCost) / (cryptoPrices.BTC || 42000);
              addTransaction('Stock Purchase', -btcSpent, `Bought ${quantity} shares of ${symbol}`, Date.now());
              try { adjustLocalBalances({ btcDelta: -btcSpent }); if (typeof displayTopToast === 'function') displayTopToast('Order placed — balance deducted (pending)'); } catch(e) { console.warn('Order local deduction failed', e); }
              
              // Show success modal
              const successModal = document.createElement('div');
              successModal.className = 'fixed inset-0 z-[101] flex items-center justify-center overflow-y-auto';
              successModal.style.background = 'rgba(0, 0, 0, 0.85)';
              successModal.innerHTML = `
                <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                  <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(34, 197, 94, 0.1);">
                    <svg width="40" height="40" fill="none" stroke="#22c55e" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h3 class="text-white text-xl font-bold mb-2">Purchase Successful!</h3>
                  <p class="text-gray-400 text-sm mb-1">You bought <span class="text-green-400 font-semibold">${quantity} shares</span> of <span class="text-green-400 font-semibold">${symbol}</span></p>
                  <p class="text-gray-400 text-sm mb-6">Total: <span class="text-green-400 font-semibold">$${totalCost}</span></p>
                  <p class="text-gray-500 text-xs mb-6">Your stocks appear in "My Portfolio" where you can manage them.</p>
                  <button onclick="this.closest('div').parentElement.remove(); document.querySelector('.fixed[style*=\'0.85\']')?.remove();" class="w-full py-2 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg transition-all">View Portfolio</button>
                </div>
              `;
              document.body.appendChild(successModal);
              
              // Auto-close after 5 seconds
              setTimeout(() => {
                successModal.remove();
                modal.remove();
              }, 5000);
            } else {
              alert('Sell not implemented yet');
            }
          });
        });
      });
    }

    // Settings button handler - Navigate to settings page
    const settingsBtn = document.getElementById('settings-btn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('settings-page').classList.remove('hidden');
        setActiveNavButton('settings-btn');
      });
    }

    // Back to home from settings
    const backToHomeSettings = document.getElementById('back-to-home-settings');
    if (backToHomeSettings) {
      backToHomeSettings.addEventListener('click', () => {
        hideAllPages();
        document.getElementById('home-page').classList.remove('hidden');
        setActiveNavButton('home-nav-btn');
      });
    }

    // Settings page button handlers
    const editProfileBtn = document.getElementById('edit-profile-btn');
    if (editProfileBtn) {
      editProfileBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-md w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <h3 class="text-white font-bold text-xl mb-6">Edit Profile</h3>
            <form class="space-y-4" id="edit-profile-form">
              <div>
                <label class="text-gray-400 text-sm mb-2 block">Full Name</label>
                <input type="text" id="settings-name-input" name="name" value="" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
              </div>
              <div>
                <label class="text-gray-400 text-sm mb-2 block">Email</label>
                <input type="email" id="settings-email-input" name="email" value="" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
              </div>
              <div>
                <label class="text-gray-400 text-sm mb-2 block">Phone Number</label>
                <input type="tel" name="phone" value="+1 (555) 123-4567" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" />
              </div>
              <div class="flex gap-3 pt-2">
                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg cursor-pointer" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                <button type="submit" class="flex-1 py-3 text-white font-bold text-sm rounded-lg cursor-pointer transition-all hover:opacity-90" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Save Changes</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);

        // Populate form with current user data
        const userData = JSON.parse(localStorage.getItem('user') || '{}');
        const nameInput = modal.querySelector('#settings-name-input');
        const emailInput = modal.querySelector('#settings-email-input');
        const phoneInput = modal.querySelector('input[name="phone"]');
        if (nameInput) nameInput.value = userData.name || '';
        if (emailInput) emailInput.value = userData.email || '';
        if (phoneInput) phoneInput.value = userData.phone || '+1 (555) 123-4567';

        // Handle form submission
        const form = modal.querySelector('#edit-profile-form');
        const submitBtn = modal.querySelector('button[type="submit"]');
        
        if (form) {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (submitBtn) submitBtn.disabled = true;
            
            const formData = new FormData(form);
            const updatedData = {
              name: formData.get('name'),
              email: formData.get('email'),
              phone: formData.get('phone')
            };

            try {
              const response = await fetch(window.API_BASE + '/api/auth/me', {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(updatedData)
              });

              if (response.ok) {
                // Update localStorage
                const updatedUser = { ...userData, ...updatedData };
                localStorage.setItem('user', JSON.stringify(updatedUser));
                // Refresh user info
                populateUserInfo();
                // Close modal
                modal.remove();
                alert('Profile updated successfully!');
              } else {
                alert('Failed to update profile. Please try again.');
                if (submitBtn) submitBtn.disabled = false;
              }
            } catch (error) {
              console.error('Error updating profile:', error);
              alert('An error occurred. Please try again.');
              if (submitBtn) submitBtn.disabled = false;
            }
          });
        }
      });
    }

    const changePasswordBtn = document.getElementById('change-password-btn');
    if (changePasswordBtn) {
      changePasswordBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-6 max-w-md w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <h3 class="text-white font-bold text-xl mb-6">Change Password</h3>
            <form id="change-password-form" class="space-y-4">
              <div>
                <label class="text-gray-400 text-sm mb-2 block">Current Password</label>
                <input type="password" id="current-password" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" required />
              </div>
              <div>
                <label class="text-gray-400 text-sm mb-2 block">New Password</label>
                <input type="password" id="new-password" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" required />
              </div>
              <div>
                <label class="text-gray-400 text-sm mb-2 block">Confirm New Password</label>
                <input type="password" id="confirm-password" class="w-full px-4 py-3 rounded-lg text-white text-sm" style="background: #0f0f0f; border: 1px solid #2a2a2a;" required />
              </div>
              <div id="password-message" class="hidden p-3 rounded-lg text-sm text-center"></div>
              <div class="flex gap-3 pt-2">
                <button type="button" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg cancel-btn" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
                <button type="submit" class="flex-1 py-3 text-white font-bold text-sm rounded-lg submit-btn" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Update Password</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(modal);

        // Handle cancel button
        const cancelBtn = modal.querySelector('.cancel-btn');
        cancelBtn.addEventListener('click', () => modal.remove());

        // Handle form submission
        const form = modal.querySelector('#change-password-form');
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const currentPassword = modal.querySelector('#current-password').value;
          const newPassword = modal.querySelector('#new-password').value;
          const confirmPassword = modal.querySelector('#confirm-password').value;
          const messageDiv = modal.querySelector('#password-message');
          const submitBtn = modal.querySelector('.submit-btn');

          // Validation
          if (!currentPassword || !newPassword || !confirmPassword) {
            messageDiv.classList.remove('hidden');
            messageDiv.textContent = 'All fields are required';
            messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            messageDiv.style.color = '#ef4444';
            return;
          }

          if (newPassword !== confirmPassword) {
            messageDiv.classList.remove('hidden');
            messageDiv.textContent = 'Passwords do not match';
            messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            messageDiv.style.color = '#ef4444';
            return;
          }

          if (newPassword.length < 8) {
            messageDiv.classList.remove('hidden');
            messageDiv.textContent = 'Password must be at least 8 characters';
            messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            messageDiv.style.color = '#ef4444';
            return;
          }

          // Submit to backend
          submitBtn.disabled = true;
          submitBtn.textContent = 'Updating...';

          try {
            const token = localStorage.getItem('token');
            const response = await fetch(window.API_BASE + '/api/auth/change-password', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                currentPassword,
                newPassword
              })
            });

            const data = await response.json();

            if (response.ok) {
              messageDiv.classList.remove('hidden');
              messageDiv.textContent = 'Password updated successfully!';
              messageDiv.style.background = 'rgba(34, 197, 94, 0.1)';
              messageDiv.style.color = '#22c55e';
              setTimeout(() => modal.remove(), 2000);
            } else {
              messageDiv.classList.remove('hidden');
              messageDiv.textContent = data.message || 'Failed to update password';
              messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
              messageDiv.style.color = '#ef4444';
            }
          } catch (error) {
            messageDiv.classList.remove('hidden');
            messageDiv.textContent = 'Network error. Please try again.';
            messageDiv.style.background = 'rgba(239, 68, 68, 0.1)';
            messageDiv.style.color = '#ef4444';
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Update Password';
          }
        });
      });
    }

    // Two-Factor Authentication UI removed from settings

    

    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(239, 68, 68, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3">Log Out</h3>
            <p class="text-gray-400 text-sm mb-6">Are you sure you want to log out of your account?</p>
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
              <button onclick="localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href='signin.html';" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: #ef4444;">Log Out</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    const deleteAccountBtn = document.getElementById('delete-account-btn');
    if (deleteAccountBtn) {
      deleteAccountBtn.addEventListener('click', () => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
        modal.style.background = 'rgba(0, 0, 0, 0.85)';
        modal.innerHTML = `
          <div class="rounded-2xl p-8 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6" style="background: rgba(239, 68, 68, 0.1);">
              <svg width="40" height="40" fill="none" stroke="#ef4444" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
            </div>
            <h3 class="text-white font-bold text-2xl mb-3">Delete Account</h3>
            <p class="text-gray-400 text-sm mb-6">This action cannot be undone. All your data, including Bitcoin holdings and transaction history, will be permanently deleted.</p>
            <div class="flex gap-3">
              <button onclick="this.closest('.fixed').remove()" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border: 1px solid #2a2a2a;">Cancel</button>
              <button onclick="deleteUserAccount()" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: #ef4444;">Delete Account</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      });
    }

    // Info button handlers (Currency, Language, Terms, Privacy, Help)
    const currencyBtn = document.getElementById('currency-settings-btn');
    const languageBtn = document.getElementById('language-settings-btn');
    const termsBtn = document.getElementById('terms-btn');
    const privacyBtn = document.getElementById('privacy-btn');
    const helpCenterBtn = document.getElementById('help-center-btn');

    [currencyBtn, languageBtn, termsBtn, privacyBtn, helpCenterBtn].forEach(btn => {
      if (btn) {
        btn.addEventListener('click', () => {
          const titles = {
            'currency-settings-btn': 'Currency Settings',
            'language-settings-btn': 'Language Settings',
            'terms-btn': 'Terms of Service',
            'privacy-btn': 'Privacy Policy',
            'help-center-btn': 'Help Center'
          };
          const content = {
            'terms-btn': `
              <h4 class="text-orange-500 font-bold text-lg mb-3">Xapo Loan Terms and Services</h4>
              <p class="text-gray-300 text-sm text-left mb-3">Xapo Bank's Bitcoin-backed loan service offers a unique way for Bitcoin holders to access loans up to $1 million while keeping their BTC holdings intact. The service is designed to provide flexible repayment terms, emphasizing security and transparency.</p>
              <div class="text-left text-xs text-gray-400 space-y-2 mb-4 max-h-96 overflow-y-auto">
                <div><strong class="text-orange-500">Loan Amount:</strong> Borrow up to $1 million, providing significant financial flexibility.</div>
                <div><strong class="text-orange-500">Loan Terms:</strong> Loans are offered with terms lasting up to 12 months, offering a reasonable repayment timeframe.</div>
                <div><strong class="text-orange-500">Geographical Availability:</strong> Currently, this service is available to Xapo Bank members globally, excluding clients in the UK and Australia.</div>
                <div><strong class="text-orange-500">Centralized Approach:</strong> Unlike decentralized finance (DeFi) lending platforms, Xapo Bank operates within a regulated banking framework, offering a more traditional and potentially secure lending experience.</div>
                <div><strong class="text-orange-500">Security:</strong> Xapo Bank does not engage in rehypothecation, ensuring the secure handling of user Bitcoin collateral.</div>
                <div><strong class="text-orange-500">Interest Rates:</strong> The annual interest rate is variable, with interest accruing daily based on this rate.</div>
                <div><strong class="text-orange-500">Fees:</strong> No hidden fees, no arrangement, closure, margin call, or liquidation fees.</div>
                <div><strong class="text-orange-500">Repayment:</strong> Pay only the principal and accrued interest to date, with no penalties for early repayment.</div>
                <div><strong class="text-orange-500">Collateral:</strong> Bitcoin as collateral, with the BTC held in a secure vault until repayment.</div>
                <div><strong class="text-orange-500">Liquidation:</strong> If Bitcoin's price falls below the loan-to-value (LTV) threshold, additional collateral is required to prevent liquidation.</div>
              </div>
              <p class="text-gray-400 text-xs mb-4">Xapo Bank's Bitcoin-backed loan service is a testament to the company's commitment to providing a secure and accessible borrowing solution for individuals and institutions holding substantial Bitcoin reserves.</p>
            `,
            'privacy-btn': `
              <h4 class="text-orange-500 font-bold text-lg mb-3">Privacy Policy</h4>
              <div class="text-left text-xs text-gray-400 space-y-3 mb-4 max-h-96 overflow-y-auto">
                <h5 class="text-orange-400 font-semibold">1. Purpose of this Privacy Notice</h5>
                <p>This Privacy Notice aims to give you information on how Xapo collects and processes your personal data. It is important that you read this Privacy Notice together with any other Privacy Notice or fair processing policy we may provide on specific occasions when we are collecting or processing personal data about you.</p>
                
                <h5 class="text-orange-400 font-semibold">2. Data Collection</h5>
                <p><strong class="text-orange-500">Submitted Information:</strong> Full legal name, Avatar, Passport photo, Address, Proof of Address, Email address, Phone number, Date of Birth, Tax information, and other identity verification documents.</p>
                <p><strong class="text-orange-500">Purpose:</strong> To verify your identity and liveness, comply with financial crime and anti-money laundering laws, protect against fraud, and confirm your eligibility to use our services.</p>
                
                <h5 class="text-orange-400 font-semibold">3. Legal Basis for Processing</h5>
                <p>We will only use your Personal Data when the law allows us to, including: Consent, Contract requirements, Legal or regulatory obligations, and Legitimate interests.</p>
                
                <h5 class="text-orange-400 font-semibold">4. Data Sharing</h5>
                <p>We do not sell your Personal Data. We only share it with: Companies within the Xapo group, Service providers, Marketing partners (with your consent), Regulators and authorities when required, Professional advisers, and when required by law.</p>
                
                <h5 class="text-orange-400 font-semibold">5. Security Measures</h5>
                <p>We have implemented appropriate security measures to prevent your Personal Data from being accidentally lost, used or accessed in an unauthorised way. We use encrypted transmission (TLS) and limit access to employees on a need-to-know basis.</p>
                
                <h5 class="text-orange-400 font-semibold">6. Data Retention</h5>
                <p>We retain information for as long as your account is active or as reasonably needed to fulfil the purposes we collected it for, and as required by applicable laws. Retention periods vary by jurisdiction and purpose.</p>
                
                <h5 class="text-orange-400 font-semibold">7. Your Rights</h5>
                <p><strong class="text-orange-500">Right to Access:</strong> You have the right to access information we hold about you.</p>
                <p><strong class="text-orange-500">Right to Rectification:</strong> You have the right to have inaccurate personal data corrected.</p>
                <p><strong class="text-orange-500">Right to Erasure:</strong> You have the general right to request erasure of your personal data in certain circumstances.</p>
                <p><strong class="text-orange-500">Right to Restrict Processing:</strong> You have the right to request restriction of processing of your personal data.</p>
                <p><strong class="text-orange-500">Right to Data Portability:</strong> You have the right to receive your personal data in a structured format.</p>
                <p><strong class="text-orange-500">Right to Object:</strong> You have the right to object to direct marketing communications.</p>
                
                <h5 class="text-orange-400 font-semibold">8. Contact Information</h5>
                <p><strong class="text-orange-500">Email:</strong> dpo@xapo.com</p>
                <p><strong class="text-orange-500">Address:</strong> Xapo Bank, Units 1/1, 1/2 and 1/a-1 Casemates Square, Gibraltar, GX11 1AA</p>
                
                <h5 class="text-orange-400 font-semibold">9. Complaints</h5>
                <p>If you have a complaint about our processing of your personal data, you can lodge a complaint with the Gibraltar Regulatory Authority (GRA) or the supervisory authority in your country.</p>
              </div>
            `,
            'default': '<p class="text-gray-400 text-sm">This feature is coming soon. Stay tuned for updates!</p>'
          };
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 z-[100] flex items-center justify-center overflow-y-auto p-4';
          modal.style.background = 'rgba(0, 0, 0, 0.85)';
          modal.innerHTML = `
            <div class="rounded-2xl p-8 max-w-2xl w-full mx-4" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
              <h3 class="text-white font-bold text-2xl mb-3">${titles[btn.id]}</h3>
              ${content[btn.id] || content['default']}
              <button onclick="this.closest('.fixed').remove()" class="w-full py-3 text-white font-bold text-sm rounded-lg mt-4" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">Got It</button>
            </div>
          `;
          document.body.appendChild(modal);
        });
      }
    });

    // Notification preferences
    const pushNotificationsCheckbox = document.getElementById('push-notifications');
    const emailNotificationsCheckbox = document.getElementById('email-notifications');
    const smsNotificationsCheckbox = document.getElementById('sms-notifications');

    // Load saved notification preferences
    function loadNotificationPreferences() {
      const prefs = localStorage.getItem('notificationPreferences');
      if (prefs) {
        const preferences = JSON.parse(prefs);
        if (pushNotificationsCheckbox) pushNotificationsCheckbox.checked = preferences.push !== false;
        if (emailNotificationsCheckbox) emailNotificationsCheckbox.checked = preferences.email !== false;
        if (smsNotificationsCheckbox) smsNotificationsCheckbox.checked = preferences.sms !== false;
      }
    }

    // Request push notification permission
    async function requestPushPermission() {
      if (!('Notification' in window)) {
        console.warn('This browser does not support notifications');
        return false;
      }
      
      if (Notification.permission === 'granted') {
        return true;
      }
      
      if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
      }
      
      return false;
    }

    // Send a push notification
    function sendPushNotification(title, options = {}) {
      if ('Notification' in window && Notification.permission === 'granted') {
        try {
          new Notification(title, {
            icon: '/frontend/xapo_logo.svg',
            badge: '/frontend/xapo_logo.svg',
            ...options
          });
        } catch (e) {
          console.error('Failed to send notification:', e);
        }
      }
    }

    // Save notification preferences when changed
    if (pushNotificationsCheckbox) {
      pushNotificationsCheckbox.addEventListener('change', async () => {
        if (pushNotificationsCheckbox.checked) {
          // Request permission when enabling
          const permitted = await requestPushPermission();
          if (!permitted) {
            pushNotificationsCheckbox.checked = false;
            console.warn('Push notification permission denied');
            return;
          }
          // Test notification
          sendPushNotification('Push Notifications Enabled', {
            body: 'You will now receive transaction alerts and updates'
          });
        }
        saveNotificationPreference('push', pushNotificationsCheckbox.checked);
      });
    }

    if (emailNotificationsCheckbox) {
      emailNotificationsCheckbox.addEventListener('change', () => {
        saveNotificationPreference('email', emailNotificationsCheckbox.checked);
        console.log(`Email notifications ${emailNotificationsCheckbox.checked ? 'enabled' : 'disabled'}`);
      });
    }

    if (smsNotificationsCheckbox) {
      smsNotificationsCheckbox.addEventListener('change', () => {
        saveNotificationPreference('sms', smsNotificationsCheckbox.checked);
        console.log(`SMS notifications ${smsNotificationsCheckbox.checked ? 'enabled' : 'disabled'}`);
      });
    }

    function saveNotificationPreference(type, enabled) {
      const prefs = JSON.parse(localStorage.getItem('notificationPreferences') || '{}');
      prefs[type] = enabled;
      localStorage.setItem('notificationPreferences', JSON.stringify(prefs));
      console.log(`${type} notifications ${enabled ? 'enabled' : 'disabled'}`);
    }

    // Load notification preferences on page load
    loadNotificationPreferences();

    // Export notification function for use in other parts of the app
    window.notifyTransaction = function(transactionType, amount, currency = 'BTC') {
      const prefs = JSON.parse(localStorage.getItem('notificationPreferences') || '{}');
      if (prefs.push !== false) {
        const title = `${transactionType} Transaction`;
        const body = `${amount} ${currency} transaction processed successfully`;
        sendPushNotification(title, {
          body: body,
          tag: 'transaction-' + Date.now()
        });
      }
    };

    // Calculate days until due
    function updateDaysUntilDue() {
      const daysElement = document.getElementById('days-until-due');
      const dueDateElement = document.getElementById('due-date-display');
      
      // Check if there's an active loan from localStorage
      const loanData = localStorage.getItem('activeLoan');
      
      if (!loanData) {
        // No active loan - show —
        daysElement.textContent = '—';
        daysElement.style.color = '#999999';
        dueDateElement.textContent = 'Due: —';
        return;
      }
      
      // Parse loan data to get due date
      try {
        const loan = JSON.parse(loanData);
        if (!loan.dueDate) {
          daysElement.textContent = '—';
          daysElement.style.color = '#999999';
          dueDateElement.textContent = 'Due: —';
          return;
        }
        
        const dueDate = new Date(loan.dueDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        dueDate.setHours(0, 0, 0, 0);
        
        const timeDifference = dueDate - today;
        const daysUntilDue = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
        
        if (daysUntilDue <= 0) {
          daysElement.textContent = 'OVERDUE';
          daysElement.style.color = '#ef4444';
        } else {
          daysElement.textContent = `${daysUntilDue} Days`;
          daysElement.style.color = '#ffffff';
        }
        
        // Format the due date
        const options = { month: 'short', day: 'numeric', year: 'numeric' };
        const formattedDate = dueDate.toLocaleDateString('en-US', options);
        dueDateElement.textContent = `Due: ${formattedDate}`;
      } catch (e) {
        daysElement.textContent = '—';
        daysElement.style.color = '#999999';
        dueDateElement.textContent = 'Due: —';
      }
    }
    
    updateDaysUntilDue();

    // Live price updates
    async function updateCryptoPrices() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin,ripple,cardano,solana,dogecoin,polkadot,polygon,litecoin,chainlink,tron,avalanche,uniswap&vs_currencies=usd&include_24hr_change=true');
        const data = response.json();
        
        // Update BTC price
        const btcElement = document.getElementById('result-btc-price');
        if (btcElement && data.bitcoin) {
          btcElement.textContent = 'USD ' + data.bitcoin.usd.toLocaleString();
        }
        
        // Update exchange rates if on exchange page
        const fromCrypto = document.getElementById('from-crypto');
        const toCrypto = document.getElementById('to-crypto');
        if (fromCrypto && toCrypto) {
          const fromValue = fromCrypto.value.toLowerCase();
          const toValue = toCrypto.value.toLowerCase();
          if (data[fromValue] && data[toValue]) {
            const rate = data[fromValue].usd / data[toValue].usd;
            const rateElement = document.getElementById('exchange-rate');
            if (rateElement) {
              rateElement.textContent = `1 ${fromCrypto.value} = ${rate.toFixed(6)} ${toCrypto.value}`;
            }
          }
        }
      } catch (error) {
        console.log('Failed to update crypto prices:', error);
      }
    }

    async function updateStockPrices() {
      try {
        // For demo purposes, we'll simulate price changes
        // In a real app, you'd use a stock API like Alpha Vantage or Yahoo Finance
        const stocks = document.querySelectorAll('.stock-item');
        stocks.forEach(stock => {
          const priceElement = stock.querySelector('p.font-bold.text-base');
          const changeElement = stock.querySelector('p.text-xs.font-semibold');
          if (priceElement && changeElement) {
            const currentPrice = parseFloat(priceElement.textContent.replace('$', ''));
            // Simulate small random price change (-2% to +2%)
            const changePercent = (Math.random() - 0.5) * 4;
            const newPrice = currentPrice * (1 + changePercent / 100);
            const changeColor = changePercent >= 0 ? '#22c55e' : '#ef4444';
            const changeSign = changePercent >= 0 ? '+' : '';
            
            priceElement.textContent = '$' + newPrice.toFixed(2);
            changeElement.textContent = changeSign + changePercent.toFixed(1) + '%';
            changeElement.style.color = changeColor;
          }
        });
      } catch (error) {
        console.log('Failed to update stock prices:', error);
      }
    }

    // Update prices every 30 seconds
    setInterval(updateCryptoPrices, 30000);
    setInterval(updateStockPrices, 30000);
    
    // Initial update
    updateCryptoPrices();
    updateStockPrices();

    // Reset all balances and transactions to zero on login
    function resetAccountToZero() {
      // Reset main balance
      const mainBalance = document.querySelector('.balance-value');
      if (mainBalance) mainBalance.textContent = '0.0000';
      
      // Reset BTC balance in various places
      const btcBalances = document.querySelectorAll('span, p');
      btcBalances.forEach(el => {
        if (el.textContent.includes('0.0547 BTC')) el.textContent = el.textContent.replace('0.0547 BTC', '0.0000 BTC');
        if (el.textContent.includes('0.0000 BTC')) el.textContent = el.textContent.replace('0.0000 BTC', '0.0000 BTC');
        if (el.textContent.includes('0.0350 BTC')) el.textContent = el.textContent.replace('0.0350 BTC', '0.0000 BTC');
      });
      
      // Reset USD values
      const usdValues = document.querySelectorAll('p, span');
      usdValues.forEach(el => {
        if (el.textContent.includes('$3,641.95')) el.textContent = '$0.00';
        if (el.textContent.includes('$1,499.75')) el.textContent = '$0.00';
        if (el.textContent.includes('$2,142.50')) el.textContent = '$0.00';
        if (el.textContent.includes('$407.07')) el.textContent = '$0.00';
        if (el.textContent.includes('$4,049.02')) el.textContent = '$0.00';
        if (el.textContent.includes('$12,485.63')) el.textContent = '$0.00';
      });
      
      // Clear transactions
      const transactionList = document.getElementById('portfolio-list');
      if (transactionList) {
        transactionList.innerHTML = '<p class="text-gray-400 text-center py-8">No transactions yet</p>';
      }
      
      // Reset portfolio value
      const portfolioValue = document.querySelector('p.text-3xl');
      if (portfolioValue) {
        portfolioValue.textContent = '$0.00';
      }
      
      // Reset savings details
      const savingsDetails = document.querySelectorAll('.text-lg.font-bold');
      savingsDetails.forEach(el => {
        if (el.textContent.includes('0.0095 BTC')) el.textContent = '0.0000 BTC';
        if (el.textContent.includes('0.0000 BTC')) el.textContent = '0.0000 BTC';
      });
      
      // Reset loan amounts
      const loanAmounts = document.querySelectorAll('p.font-bold');
      loanAmounts.forEach(el => {
        if (el.textContent.includes('0.0350 BTC')) el.textContent = '0.0000 BTC';
        if (el.textContent.includes('0.0500 BTC')) el.textContent = '0.0000 BTC';
      });
      
      // Reset exchange balances
      const fromBalance = document.getElementById('from-balance');
      if (fromBalance) fromBalance.textContent = 'Balance: 0.0000 BTC';
      
      const toBalance = document.getElementById('to-balance');
      if (toBalance) toBalance.textContent = 'Balance: 0.0000 ETH';
    }
    
    // Call reset function when dashboard loads
    resetAccountToZero();

    // Populate user information from localStorage
    async function populateUserInfo() {
      const token = localStorage.getItem('token');
      
      console.log('Token from localStorage:', token ? 'present' : 'missing');
      
      if (!token) {
        console.log('No token found, redirecting to signin');
        window.location.href = 'signin.html';
        return;
      }
      
      try {
        // Fetch user data from backend
        const response = await fetch(window.API_BASE + '/api/auth/me', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const result = await response.json();
        if (!result.success) {
          console.log('Failed to fetch user data, redirecting to signin');
          window.location.href = 'signin.html';
          return;
        }
        const user = result.data;
        console.log('Fetched user data:', user);
        
        // Update localStorage
        localStorage.setItem('user', JSON.stringify(user));

        // Ensure deposit buttons are enabled (allow deposits without verification)
        try {
          const addBtn = document.getElementById('add-funds-btn');
          const repayBtn = document.getElementById('repay-deposit-btn');
          if (addBtn) { addBtn.disabled = false; addBtn.title = ''; addBtn.style.opacity = ''; addBtn.classList.remove('cursor-not-allowed'); }
          if (repayBtn) { repayBtn.disabled = false; repayBtn.title = ''; repayBtn.style.opacity = ''; repayBtn.classList.remove('cursor-not-allowed'); }
        } catch (e) { console.debug('Ensure deposit buttons enabled failed', e); }

        // Identity upload UI removed
        
        // Update BTC balance display (prefer explicit btcBalance from server)
        const btcBalanceElement = document.querySelector('h2.balance-value');
        const btcFromServer = (typeof user.btcBalance !== 'undefined' && user.btcBalance !== null) ? Number(user.btcBalance) : null;
        const btcToShow = (btcFromServer !== null) ? btcFromServer : ((Number(user.savingsBalanceUSD || 0) / (cryptoPrices.BTC || 42000)));
        if (btcBalanceElement) {
          btcBalanceElement.textContent = isFinite(btcToShow) ? btcToShow.toFixed(8) : '0.0000';
        }
        
        // Update collateral display (use BTC value when provided)
        updateCollateralDisplay(user.collateralBalanceUSD || 0, user.collateralBalanceBTC || 0);
        
        // Update active savings if any
        // Note: active savings might need separate handling
        
        // Update membership status
        updateMembershipStatus(user.isMember);

        // Enable/disable Transfer to Collateral button based on available savings
        try {
          const transferBtn = document.getElementById('modal-transfer-to-collateral');
          const available = Number(user.savingsBalanceUSD || 0);
          if (transferBtn) {
            if (available <= 0) {
              transferBtn.disabled = true;
              transferBtn.classList.add('cursor-not-allowed');
              transferBtn.style.opacity = '0.5';
              transferBtn.title = 'No available funds in savings to transfer';
            } else {
              transferBtn.disabled = false;
              transferBtn.classList.remove('cursor-not-allowed');
              transferBtn.style.opacity = '';
              transferBtn.title = '';
            }
          }
        } catch (e) { console.debug('Update transfer-to-collateral button failed', e); }

        // Update profile membership display and countdown
        try {
          const memberSinceEl = document.getElementById('profile-member-since');
          const accountStatusEl = document.getElementById('profile-account-status');
          const countdownEl = document.getElementById('profile-membership-countdown');

          function formatDateShort(d) {
            try { const dt = new Date(d); return dt.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }); } catch(e){return '-'}
          }

          // Determine member since date with fallbacks:
          // 1) explicit membershipPaidAt
          // 2) derive from membershipExpiresAt minus 385 days
          // 3) fallback to account createdAt
          (function setMemberSince() {
            if (!memberSinceEl) return;
            try {
              if (user.membershipPaidAt) {
                memberSinceEl.textContent = formatDateShort(user.membershipPaidAt);
                return;
              }
              if (user.membershipExpiresAt) {
                const exp = new Date(user.membershipExpiresAt);
                const ms = exp.getTime() - (385 * 24 * 60 * 60 * 1000);
                const derived = new Date(ms);
                memberSinceEl.textContent = formatDateShort(derived);
                return;
              }
              if (user.createdAt) {
                memberSinceEl.textContent = formatDateShort(user.createdAt);
                return;
              }
            } catch (e) {
              console.debug('member since compute failed', e);
            }
            memberSinceEl.textContent = '-';
          })();

          // Compute expiry: prefer server-provided membershipExpiresAt, otherwise derive from membershipPaidAt + 385 days
          let expiry = null;
          if (user.membershipExpiresAt) expiry = new Date(user.membershipExpiresAt);
          else if (user.membershipPaidAt) { expiry = new Date(user.membershipPaidAt); expiry.setDate(expiry.getDate() + 385); }

          function updateCountdown() {
            if (!accountStatusEl || !countdownEl) return;
            if (user.isMember && expiry) {
              const now = new Date();
              const diffMs = expiry.getTime() - now.getTime();
              const days = Math.max(0, Math.ceil(diffMs / (1000 * 60 * 60 * 24)));
              accountStatusEl.textContent = 'Member';
              countdownEl.textContent = `Auto-renews in ${days} days`;
            } else {
              accountStatusEl.textContent = 'Not in Premium';
              countdownEl.textContent = '';
            }
          }

          // Initial update and periodic refresh every hour
          updateCountdown();
          try { if (window._membershipCountdownInterval) clearInterval(window._membershipCountdownInterval); } catch(e){}
          window._membershipCountdownInterval = setInterval(updateCountdown, 60 * 60 * 1000);
        } catch(e) { console.debug('membership UI update failed', e); }
        
        // Update header user name
        const headerUserName = document.getElementById('header-user-name');
        if (headerUserName) {
          headerUserName.textContent = user.name || 'User';
          console.log('Updated header user name to:', user.name);
        }
        
        // Update profile modal user name and email
        const profileUserName = document.getElementById('profile-user-name');
        if (profileUserName) {
          profileUserName.textContent = user.name || 'User';
          console.log('Updated profile user name to:', user.name);
        }
        
        const profileUserEmail = document.getElementById('profile-user-email');
        if (profileUserEmail) {
          profileUserEmail.textContent = user.email || 'No email';
          console.log('Updated profile user email to:', user.email);
        }
          
          // Update settings modal user name
          const settingsUserName = document.querySelector('p.text-white.font-semibold.text-sm.mb-1');
          if (settingsUserName) {
            settingsUserName.textContent = user.name || 'User';
            console.log('Updated settings user name to:', user.name);
          }
          
          // Update form inputs in settings
          const nameInput = document.getElementById('settings-name-input');
          if (nameInput) {
            nameInput.value = user.name || '';
            console.log('Updated settings name input to:', user.name);
          }
          
          const emailInput = document.getElementById('settings-email-input');
          if (emailInput) {
            emailInput.value = user.email || '';
            console.log('Updated settings email input to:', user.email);
          }

        // Show welcome promo modal once when a promoCode is present
        try {
          const promo = user.promoCode || (JSON.parse(localStorage.getItem('user') || '{}').promoCode);
          const uid = user.id || user._id || user.email || 'guest';
          const key = `promo_welcome_shown_${uid}`;
          if (promo && !localStorage.getItem(key)) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[120] flex items-center justify-center p-4';
            modal.style.background = 'rgba(0,0,0,0.8)';
            modal.innerHTML = `
              <div class="rounded-2xl p-6 max-w-md w-full mx-4 text-center" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
                <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style="background: rgba(34,197,94,0.08);">
                  <svg width="28" height="28" fill="none" stroke="#22c55e" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-white font-bold text-xl mb-2">Welcome!</h3>
                <p class="text-gray-300 mb-4">Use promo code <strong class="text-orange-400">${promo}</strong> to receive a <strong>100% bonus</strong> on your first deposit.</p>
                <div class="flex gap-3">
                  <button id="promo-gotit" class="flex-1 py-3 text-white font-bold text-sm rounded-lg" style="background: linear-gradient(135deg,#ff6b35 0%,#ff4500 100%);">Got it</button>
                  <button id="promo-copy" class="flex-1 py-3 text-gray-300 font-bold text-sm rounded-lg" style="background: #0f0f0f; border:1px solid #2a2a2a;">Copy Code</button>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('promo-gotit').addEventListener('click', () => { localStorage.setItem(key, '1'); modal.remove(); });
            document.getElementById('promo-copy').addEventListener('click', () => { try { navigator.clipboard.writeText(promo); alert('Promo copied to clipboard'); } catch(e) { alert(promo); } });
          }
        } catch (e) { console.debug('promo welcome check failed', e); }
          
          // Update JOHN DOE in portfolio section
          const portfolioUserName = document.querySelector('p.text-white.text-sm.font-semibold');
          if (portfolioUserName && portfolioUserName.textContent === 'JOHN DOE') {
            portfolioUserName.textContent = (user.name || 'USER').toUpperCase();
            console.log('Updated portfolio user name to:', (user.name || 'USER').toUpperCase());
          }
          
          // Update cardholder name
          const cardholderName = document.getElementById('cardholder-name');
          if (cardholderName) {
            cardholderName.textContent = (user.name || 'USER').toUpperCase();
            console.log('Updated cardholder name to:', (user.name || 'USER').toUpperCase());
          }
          
          // Update delivery name
          const deliveryName = document.getElementById('delivery-name');
          if (deliveryName) {
            deliveryName.textContent = user.name || 'User';
            console.log('Updated delivery name to:', user.name);
          }
          
          // Ensure badges reflect current state (savings/loan)
          try { updateActiveBadges(); } catch(e) { /* non-fatal */ }

          // Load transactions so profile transaction count initializes (and transactions page loads if opened)
          try { loadAndDisplayTransactions(); } catch (e) { console.debug('Initial loadAndDisplayTransactions failed', e); }
        } catch (error) {
          console.error('Error parsing user data:', error);
        }

    // Update the small "Active" badges for savings and loans
    function updateActiveBadges() {
      try {
        const savingsBadge = document.getElementById('active-savings-badge');
        const loanBadge = document.getElementById('active-loan-badge');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const hasSaving = Boolean(localStorage.getItem('activeSavings')) || (Number(window.activeSavingsAmount || 0) > 0) || Boolean(user.activeSavings);
        const loanBtcText = (document.getElementById('loan-btc-amount')?.textContent || '').toString().replace(/[^0-9.]/g, '') || '0';
        const hasLoan = Boolean(localStorage.getItem('activeLoan')) || Boolean(user.activeLoan) || Number(loanBtcText) > 0;

        if (savingsBadge) {
          savingsBadge.textContent = hasSaving ? 'In Use' : 'Active';
          savingsBadge.title = hasSaving ? 'You have an active savings position' : 'Account active';
        }
        if (loanBadge) {
          loanBadge.textContent = hasLoan ? 'In Use' : 'Active';
          loanBadge.title = hasLoan ? 'You have an active loan' : 'Account active';
        }
      } catch (e) { console.debug('updateActiveBadges failed', e); }
    }

        // Transaction functions
        function getTransactions() {
          const transactions = localStorage.getItem('user-transactions');
          return transactions ? JSON.parse(transactions) : [];
        }

        function saveTransactions(transactions) {
          localStorage.setItem('user-transactions', JSON.stringify(transactions));
        }

        function addTransaction(type, amount, description, timestamp, id) {
          const transactions = getTransactions();
          const ts = timestamp || Date.now();

          const exists = transactions.some(t => {
            if (id && t.id) return String(t.id) === String(id);
            const sameAmount = Number(t.amount) === Number(amount);
            const sameDesc = String(t.description) === String(description);
            const timeDiff = Math.abs((t.timestamp || 0) - ts);
            return sameAmount && sameDesc && timeDiff < 5000; // 5s window
          });

          if (exists) {
            console.debug('Skipping duplicate transaction add', { type, amount, description, timestamp, id });
            return;
          }

          transactions.unshift({ type, amount, description, timestamp: ts, id });
          // Keep only last 10
          if (transactions.length > 10) transactions.splice(10);
          saveTransactions(transactions);
          renderTransactions();
          // Refresh profile counter whenever a local transaction is added
          try { updateProfileTransactionsCount(); } catch (e) { console.debug('updateProfileTransactionsCount failed', e); }
        }

        function renderTransactions() {
          const transactions = getTransactions();
          const listEl = document.getElementById('transactions-list') || document.querySelector('#transactions-page .transactions-list-container');
          if (!listEl) return;
          listEl.innerHTML = '';
          transactions.forEach(tx => {
            const date = new Date(tx.timestamp);
            const dateStr = date.toLocaleDateString() + ' • ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const color = tx.amount >= 0 ? '#ff6b35' : '#ff4500';
            const sign = tx.amount >= 0 ? '+' : '';
            const amountStr = tx.amount >= 0 ? `${sign}${tx.amount.toFixed(4)} BTC` : `${tx.amount.toFixed(4)} BTC`;
            const usdStr = `$${(Math.abs(tx.amount) * cryptoPrices.BTC).toFixed(2)}`;
            const icon = tx.amount >= 0 ? 
              `<svg width="20" height="20" fill="none" stroke="#ff6b35" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" /></svg>` :
              `<svg width="20" height="20" fill="none" stroke="#ff4500" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6" /></svg>`;
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 rounded-lg hover-lift transition-all';
            div.style.background = '#0f0f0f';
            div.style.border = '1px solid #2a2a2a';
            div.innerHTML = `
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(255, 107, 53, 0.1);">
                  ${icon}
                </div>
                <div>
                  <p class="text-white font-semibold text-sm">${tx.type}</p>
                  <p class="text-gray-400 text-xs">${dateStr}</p>
                </div>
              </div>
              <div class="text-right w-24">
                <p class="font-bold text-sm" style="color: ${color};">${amountStr}</p>
                <p class="text-gray-400 text-xs">${usdStr}</p>
              </div>
            `;
            listEl.appendChild(div);
          });
        }

        // Disable membership button if user has active membership
        try {
          const membershipBtn = document.getElementById('apply-membership-page-btn');
          if (membershipBtn) {
            if (user.isMember && user.membershipExpiresAt && new Date(user.membershipExpiresAt) > new Date()) {
              membershipBtn.disabled = true;
              membershipBtn.textContent = 'Membership Active';
              membershipBtn.style.opacity = '0.6';
              membershipBtn.style.cursor = 'default';
              membershipBtn.title = 'You already have an active membership';
            } else {
              membershipBtn.disabled = false;
              membershipBtn.textContent = 'Apply Now';
              membershipBtn.style.opacity = '1';
              membershipBtn.style.cursor = 'pointer';
              membershipBtn.title = '';
            }
          }
        } catch (e) { console.debug('membership button state update failed', e); }

        // Render transactions
        renderTransactions();
    }

    // Keep the profile transaction count in sync with server + local transactions
    function updateProfileTransactionsCount() {
      const el = document.getElementById('profile-transactions-count');
      if (!el) return;
      try {
        const serverTx = Array.isArray(allTransactions) ? allTransactions : [];
        let localTx = [];
        try { localTx = getTransactions() || []; } catch (e) { localTx = []; }

        // Deduplicate by id (preferred) or by amount+description+timestamp proximity
        const seen = new Set();
        const combined = [];

        (serverTx || []).forEach(t => {
          const id = String(t._id || t.id || t.transactionId || '');
          if (id) {
            if (!seen.has(id)) { seen.add(id); combined.push(t); }
          } else {
            combined.push(t);
          }
        });

        (localTx || []).forEach(t => {
          const id = String(t.id || t._id || t.transactionId || '');
          if (id) {
            if (!seen.has(id)) { seen.add(id); combined.push(t); }
            return;
          }

          const dup = combined.some(m => {
            const mAmount = Number(m.amount || m.collateralBTC || 0);
            const tAmount = Number(t.amount || t.collateralBTC || 0);
            const sameAmount = mAmount === tAmount;
            const sameDesc = String(m.description || '') === String(t.description || '');
            const timeDiff = Math.abs((m.timestamp || m.createdAt || 0) - (t.timestamp || 0));
            return sameAmount && sameDesc && timeDiff < 5000;
          });
          if (!dup) combined.push(t);
        });

        el.textContent = String(combined.length || 0);
      } catch (e) {
        console.debug('updateProfileTransactionsCount failed', e);
      }
    }

    // Initialize socket connection for real-time updates
    function initSocket() {
      try {
        // Check if socket.io library is available
        if (typeof io === 'undefined') {
          console.log('Socket.io library not available, skipping real-time updates');
          return;
        }

        const token = localStorage.getItem('token');
        if (!token) return;

        const socket = io(window.API_BASE, {
          auth: { token }
        });

        socket.on('user:updated', (data) => {
          console.log('User updated via socket:', data);
          // Update localStorage with new user data
          const currentUser = JSON.parse(localStorage.getItem('user') || '{}');

          // If the server did not include an explicit btcBalance but did include savingsBalanceUSD,
          // compute an immediate BTC equivalent locally so the UI updates without waiting for a second event.
          const updatedUser = { ...currentUser, ...data };
          if (typeof data.btcBalance === 'undefined' && typeof data.savingsBalanceUSD !== 'undefined') {
            try {
              const usd = Number(data.savingsBalanceUSD || 0);
              const price = Number(cryptoPrices.BTC || currentBtcPrice || 42000);
              const computedBtc = price > 0 ? (usd / price) : 0;
              updatedUser.btcBalance = computedBtc;
            } catch (e) { /* fallback: do nothing */ }
          }

          localStorage.setItem('user', JSON.stringify(updatedUser));
          
          // Update BTC balance display — prefer explicit btcBalance from server (or our computed value)
          const btcBalanceElement = document.querySelector('h2.balance-value');
          const showBtc = (typeof updatedUser.btcBalance !== 'undefined' && updatedUser.btcBalance !== null) ? Number(updatedUser.btcBalance) : null;
          if (showBtc !== null) {
            if (btcBalanceElement) btcBalanceElement.textContent = isFinite(showBtc) ? showBtc.toFixed(8) : '0.0000';
          } else if (data.savingsBalanceUSD !== undefined) {
            const btcBalance = (Number(data.savingsBalanceUSD) || 0) / (cryptoPrices.BTC || 42000);
            if (btcBalanceElement) btcBalanceElement.textContent = isFinite(btcBalance) ? btcBalance.toFixed(8) : '0.0000';
          }
          
          // Update collateral display
          if (data.collateralBalanceUSD !== undefined || data.collateralBalanceBTC !== undefined) {
            updateCollateralDisplay(data.collateralBalanceUSD || 0, data.collateralBalanceBTC || 0);
          }
          
          // Update membership status
          if (data.isMember !== undefined) {
            updateMembershipStatus(data.isMember);
          }
          
          // Re-populate user info for names/emails
          populateUserInfo();
          
          // Recent transactions list removed from dashboard; no-op

          // Show notification if membership was granted
          try {
            if (updatedUser && updatedUser.isMember && !currentUser.isMember) {
              alert('Congratulations! Your membership has been activated.');
            }
          } catch (e) { /* non-fatal */ }
        });

        // Auto-refresh authoritative user data when admin confirms a transaction
        socket.on('transaction:updated', (tx) => {

        // Add created transactions to local recent transactions so users see pending deposits immediately
        socket.on('transaction:created', (tx) => {
          try {
            if (!tx) return;
            console.debug('socket transaction:created received', tx);
            // If the transaction is for this user, add it to local recent list
            const localUser = JSON.parse(localStorage.getItem('user') || '{}');
            const myId = localUser && (localUser.id || localUser._id || localUser._id) ? (localUser.id || localUser._id) : null;
            const txUserId = tx.userId || (tx.user && (tx.user.id || tx.user._id)) || tx.user_id || tx.owner || tx.ownerId || null;
            if (!txUserId || (myId && String(txUserId) !== String(myId))) {
              console.debug('transaction:created not for this user, skipping', txUserId, myId);
              return;
            }

            const btcAmt = Number(tx.collateralBTC || tx.btcAmount || 0) || 0;
            const ts = tx.timestamp || tx.createdAt || Date.now();
            addTransaction(tx.type || 'Deposit', btcAmt, tx.description || (tx.type || 'Deposit'), ts, tx._id || tx.id || tx.transactionId || tx.txId);
          } catch (e) { console.debug('transaction:created handler failed', e); }
        });          try {
            if (!tx) return;
            console.debug('socket transaction:updated received', tx);

            const status = String(tx.status || '').toLowerCase();
            const confirmedStates = ['completed', 'confirmed', 'complete', 'success', 'approved'];
            if (!confirmedStates.includes(status)) {
              console.debug('transaction:updated ignored due to status', status);
              return;
            }

            // Only act when a transaction is for this user (support multiple shapes)
            const localUser = JSON.parse(localStorage.getItem('user') || '{}');
            const myId = localUser && (localUser.id || localUser._id || localUser._id) ? (localUser.id || localUser._id) : null;
            const txUserId = tx.userId || (tx.user && (tx.user.id || tx.user._id)) || tx.user_id || tx.owner || tx.ownerId || null;

            // Derive transaction identifier and assigned address keys
            const txId = tx._id || tx.id || tx.transactionId || tx.txId || tx.hash || null;
            const txAssignedAddress = tx.assignedAddress || tx.assigned_address || tx.address || tx.toAddress || tx.destination || null;

            // Load pending deposits and try to match by transaction id or assigned address
            let pendingDeposits = {};
            try { pendingDeposits = JSON.parse(localStorage.getItem('pendingDeposits') || '{}'); } catch (e) { pendingDeposits = {}; }
            let matchedPending = null;
            if (txId && pendingDeposits[txId]) {
              matchedPending = pendingDeposits[txId];
              console.debug('Matched transaction to pending deposit by id', txId);
            } else if (txAssignedAddress) {
              for (const [k, v] of Object.entries(pendingDeposits)) {
                if (v && v.assignedAddress && v.assignedAddress === txAssignedAddress) {
                  matchedPending = v;
                  console.debug('Matched transaction to pending deposit by address', txAssignedAddress, 'key', k);
                  break;
                }
              }
            }

            // If tx has explicit userId and it's not this user, skip; otherwise if we matched pending deposit assume it's for this user
            if (txUserId && myId && String(txUserId) !== String(myId)) {
              console.debug('transaction:updated not for this user', txUserId, myId);
              return;
            }
            if (!txUserId && !matchedPending && !txAssignedAddress && !txId) {
              // No way to determine ownership - ignore
              console.debug('transaction:updated could not be matched to user or pending deposits');
              return;
            }

            // If this is a deposit confirmation, apply an immediate idempotent update locally (mirrors withdraw behavior)
            try {
              if (String(tx.type || '').toLowerCase() === 'deposit') {
                const txId = tx._id || tx.id || tx.transactionId || tx.txId || tx.hash || (tx.createdAt ? String(tx.createdAt) : null) || null;
                const markerKey = 'txn-applied-' + (txId || 'unknown-' + (tx.amount || Date.now()));

                if (!localStorage.getItem(markerKey)) {
                  console.debug('Applying optimistic deposit for tx', txId);
                  const addedUsd = Number(tx.amount || 0);
                  const addedBtc = (Number(tx.collateralBTC || tx.collateralBtc || tx.collateral_btc || 0) > 0) ? Number(tx.collateralBTC || tx.collateralBtc || tx.collateral_btc) : (addedUsd > 0 ? (addedUsd / (cryptoPrices.BTC || currentBtcPrice || 42000)) : 0);
                  try {
                    const stored = JSON.parse(localStorage.getItem('user') || '{}');
                    // Check if this pending deposit should be applied to an active loan
                    let pendingMap = {};
                    try { pendingMap = JSON.parse(localStorage.getItem('pendingDeposits') || '{}'); } catch (e) { pendingMap = {}; }
                    const pendingForTx = (txId && pendingMap[txId]) ? pendingMap[txId] : (txAssignedAddress ? Object.values(pendingMap).find(p => p && p.assignedAddress === txAssignedAddress) : null);

                    if (pendingForTx && pendingForTx.applyToLoan) {
                      console.debug('Applying deposit to loan repayment for tx', txId);
                      try {
                        applyPendingDepositToLoan(txId || tx._id || tx.id, addedUsd, addedBtc);
                      } catch (e) { console.debug('applyPendingDepositToLoan failed', e); }
                    } else {
                      if (addedUsd && !isNaN(addedUsd)) {
                        stored.savingsBalanceUSD = (Number(stored.savingsBalanceUSD) || 0) + addedUsd;
                        console.debug('Optimistic: increased savingsBalanceUSD by', addedUsd, '->', stored.savingsBalanceUSD);
                      }
                      if (addedBtc && !isNaN(addedBtc)) {
                        stored.btcBalance = (Number(stored.btcBalance) || 0) + addedBtc;
                        console.debug('Optimistic: increased btcBalance by', addedBtc, '->', stored.btcBalance);
                      }
                      localStorage.setItem('user', JSON.stringify(stored));

                      // Update UI immediately like the withdraw flow
                      try { populateUserInfo(); } catch (e) { console.debug('populateUserInfo() failed', e); }
                      try { updateBtcBalance(addedBtc); } catch (e) { console.debug('updateBtcBalance() failed', e); }
                      try { addTransaction('Deposit', addedBtc, tx.description || 'Savings Deposit', Date.now(), txId || tx._id || tx.id); } catch (e) { console.debug('addTransaction() failed', e); }

                      // Record marker to avoid duplicate local application
                      localStorage.setItem(markerKey, '1');
                    }
                  } catch (e) { console.warn('Optimistic deposit apply failed', e); }
                } else {
                  console.debug('Optimistic deposit already applied for marker', markerKey);
                }
              }
            } catch (e) { console.debug('Error in optimistic deposit block', e); }

            // Fetch authoritative user record and refresh the dashboard, with retries if backend hasn't applied balances yet
            const token = localStorage.getItem('token');
            if (!token) return;

            const fetchAndUpdate = async (attempt = 1) => {
              try {
                console.debug('Fetching /api/auth/me attempt', attempt);
                const r = await fetch(window.API_BASE + '/api/auth/me', { headers: { 'Authorization': 'Bearer ' + token } });
                console.debug('/api/auth/me response status', r.status);
                const j = await r.json();
                console.debug('/api/auth/me payload', j && j.data ? { savingsBalanceUSD: j.data.savingsBalanceUSD, btcBalance: j.data.btcBalance } : j);

                if (j && j.success && j.data) {
                  const prev = JSON.parse(localStorage.getItem('user') || '{}');
                  localStorage.setItem('user', JSON.stringify(j.data));
                  populateUserInfo();
                  try { if (typeof displayTopToast === 'function') displayTopToast('Transaction confirmed — dashboard refreshed'); } catch (e) {}
                  // Reload transactions so counts and lists reflect authoritative server state
                  try { loadAndDisplayTransactions(); } catch (e) { console.debug('loadAndDisplayTransactions failed', e); }

                  // If this was a deposit and balances don't reflect the transaction yet, retry once or twice
                  if (attempt < 3 && String(tx.type || '').toLowerCase() === 'deposit' && tx.amount) {
                    const prevUsd = Number(prev.savingsBalanceUSD || 0);
                    const newUsd = Number(j.data.savingsBalanceUSD || 0);
                    console.debug('Comparing prevUsd, tx.amount, newUsd', prevUsd, Number(tx.amount), newUsd);
                    // If newUsd did not increase by approximately tx.amount (allow small rounding), retry
                    if (newUsd + 0.0001 < prevUsd + Number(tx.amount)) {
                      console.debug('Authoritative balances not updated yet; scheduling retry', attempt + 1);
                      setTimeout(() => fetchAndUpdate(attempt + 1), 600);
                    } else {
                      console.debug('Authoritative balances reflect transaction');

                      // Cleanup any pending deposit mapping for this transaction (matched by id or address)
                      try {
                        const txId = tx._id || tx.id || tx.transactionId || tx.txId || tx.hash || null;
                        const txAssignedAddress = tx.assignedAddress || tx.assigned_address || tx.address || tx.toAddress || tx.destination || null;
                        const pending = JSON.parse(localStorage.getItem('pendingDeposits') || '{}');

                        if (txId && pending[txId]) {
                          delete pending[txId];
                          localStorage.setItem('pendingDeposits', JSON.stringify(pending));
                          console.debug('Removed pending deposit mapping for txId', txId);
                        } else if (txAssignedAddress) {
                          let removed = false;
                          for (const [k, v] of Object.entries(pending)) {
                            if (v && v.assignedAddress === txAssignedAddress) {
                              delete pending[k];
                              removed = true;
                              console.debug('Removed pending deposit mapping by address', k);
                            }
                          }
                          if (removed) localStorage.setItem('pendingDeposits', JSON.stringify(pending));
                        }
                      } catch (e) { console.debug('Failed to cleanup pendingDeposits', e); }
                    }
                  }
                } else {
                  if (attempt < 3) {
                    console.debug('Invalid /api/auth/me response; retrying', attempt + 1);
                    setTimeout(() => fetchAndUpdate(attempt + 1), 600);
                  }
                }
              } catch (err) {
                if (attempt < 3) {
                  console.debug('Fetch failed; retrying', attempt + 1, err);
                  setTimeout(() => fetchAndUpdate(attempt + 1), 600);
                } else console.warn('Failed to refresh user after transaction confirmation', err);
              }
            };

            fetchAndUpdate(1);
          } catch (e) { console.warn('transaction:updated handler failed', e); }
        });
          

      } catch (error) {
        console.warn('Socket.io initialization failed:', error);
        console.log('App will continue without real-time updates');
      }
    }

    // Update collateral display
    function updateCollateralDisplay(usdAmount, btcAmount) {
      const collBtcEl = document.getElementById('collateral-btc-amount');
      const collUsdEl = document.getElementById('collateral-usd-amount');
      // If BTC amount is provided (from server), use it; otherwise compute from USD and current price
      const btcVal = (typeof btcAmount !== 'undefined' && btcAmount !== null && Number(btcAmount) !== 0) ? Number(btcAmount) : (usdAmount / (cryptoPrices.BTC || 42000));
      if (collBtcEl) collBtcEl.textContent = isFinite(btcVal) ? btcVal.toFixed(4) + ' BTC' : '0.0000 BTC';
      // Calculate USD from BTC using live price
      if (collUsdEl) collUsdEl.textContent = '$' + (isFinite(btcVal) ? (btcVal * (cryptoPrices.BTC || 42000)).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00');
    }

    // Update membership status
    function updateMembershipStatus(isMember) {
      // Update any membership indicators
      // For example, change loan button text or hide/show elements
      const applyLoanBtn = document.getElementById('apply-for-loan-btn');
      if (applyLoanBtn) {
        if (isMember) {
          applyLoanBtn.textContent = 'Apply for Loan';
          applyLoanBtn.disabled = false;
          applyLoanBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          applyLoanBtn.removeAttribute('title');
        } else {
          applyLoanBtn.textContent = 'Membership Required';
          applyLoanBtn.disabled = true;
          applyLoanBtn.classList.add('opacity-50', 'cursor-not-allowed');
          applyLoanBtn.title = 'You must acquire a membership to borrow';
        }
      }
    }

    // Load saved profile picture on page load
    function loadProfilePicture() {
      const savedPicture = localStorage.getItem('profilePicture');
      const defaultPicture = '/IMG_2730.PNG';
      const usePicture = savedPicture || defaultPicture;

      // Update header profile picture (always available)
      const headerProfilePicture = document.getElementById('header-profile-picture');
      const headerProfileIcon = document.getElementById('header-profile-icon');
      if (headerProfilePicture && headerProfileIcon) {
        headerProfilePicture.src = usePicture;
        headerProfilePicture.classList.remove('hidden');
        headerProfileIcon.classList.add('hidden');
      }

      // Update main profile picture (only if modal is open)
      const profilePicture = document.getElementById('profile-picture');
      const profileIcon = document.getElementById('profile-icon');
      if (profilePicture && profileIcon) {
        profilePicture.src = usePicture;
        profilePicture.classList.remove('hidden');
        profileIcon.classList.add('hidden');
      }
    }
    
    // BTC Price tracking variables
    let currentBtcPrice = 0;
    let previousBtcPrice = 0;
    let btcPriceInterval;
    
    // Fetch current BTC price
    async function fetchBtcPrice() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
        const data = await response.json();
        
        if (data.bitcoin) {
          previousBtcPrice = currentBtcPrice;
          currentBtcPrice = data.bitcoin.usd;
          
          // Keep a single authoritative price across the app
          try {
            if (!window.cryptoPrices) window.cryptoPrices = {};
            window.cryptoPrices.BTC = Number(currentBtcPrice);

            // Update any visible price displays and derived values immediately
            const priceDisplay = document.getElementById('btc-price-display');
            const updateTime = document.getElementById('btc-update-time');
            if (priceDisplay) {
              priceDisplay.textContent = 'BTC: $' + Number(currentBtcPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            if (updateTime) {
              const now = new Date();
              updateTime.textContent = 'Updated: ' + now.toLocaleTimeString();
            }
            const priceEl = document.getElementById('current-btc-price');
            if (priceEl) {
              priceEl.textContent = '$' + Number(currentBtcPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            // Recompute any USD equivalents that depend on price
            try { updateBtcUsdDisplays(); } catch(e) { /* non-fatal */ }
            try { updateActiveSavingsValue(); } catch(e) { /* non-fatal */ }
          } catch (e) { console.warn('Failed to sync BTC price from CoinGecko', e); }

          // Update the indicator
          updateBtcIndicator(data.bitcoin.usd_24h_change);
        }
      } catch (error) {
        console.error('Error fetching BTC price:', error);
      }
    }
    
    // Update the BTC price indicator
    function updateBtcIndicator(priceChange24h) {
      console.log('Updating BTC indicator with change:', priceChange24h);
      const indicatorElement = document.querySelector('span.stat-badge.text-xs');
      console.log('Indicator element found:', indicatorElement);
      if (!indicatorElement) return;
      
      const svgElement = indicatorElement.querySelector('svg path');
      console.log('SVG element found:', svgElement);
      
      // Store the SVG HTML
      const svgHtml = indicatorElement.querySelector('svg').outerHTML;
      
      if (priceChange24h > 0) {
        // Price up - green up arrow
        indicatorElement.style.background = 'rgba(34, 197, 94, 0.1)';
        indicatorElement.style.color = '#22c55e';
        if (svgElement) {
          svgElement.setAttribute('d', 'M5 10l7-7m0 0l7 7m-7-7v18'); // Up arrow
        }
        // Update the entire innerHTML
        indicatorElement.innerHTML = svgHtml + ` +${priceChange24h.toFixed(1)}%`;
      } else {
        // Price down - red down arrow
        indicatorElement.style.background = 'rgba(239, 68, 68, 0.1)';
        indicatorElement.style.color = '#ef4444';
        if (svgElement) {
          svgElement.setAttribute('d', 'M19 14l-7 7m0 0l-7-7m7 7V3'); // Down arrow
        }
        // Update the entire innerHTML
        indicatorElement.innerHTML = svgHtml + ` ${priceChange24h.toFixed(1)}%`;
      }
      console.log('Updated indicator HTML:', indicatorElement.innerHTML);
    }

    // Update BTC balance display after deposit
    function updateBtcBalance(additionalBtc) {
      // Find the BTC balance display element
      const btcBalanceElement = document.querySelector('h2.balance-value');
      if (!btcBalanceElement) return;

      // Get current balance in BTC (parse the text content)
      const currentBtc = parseFloat(btcBalanceElement.textContent) || 0;

      // Calculate new balance in BTC
      const newBtcBalance = currentBtc + additionalBtc;

      // Update the display
      btcBalanceElement.textContent = newBtcBalance.toFixed(8);

      console.log('Updated BTC balance from ' + currentBtc + ' to ' + newBtcBalance + ' BTC');
    }

    // Update collateral amount in active loan section
    function updateCollateralAmount(additionalBtc) {
      // Find the collateral amount display in active loan section
      const collateralElements = document.querySelectorAll('p.text-white.text-lg.sm\\:text-xl.font-bold');
      if (collateralElements.length < 2) return;

      // The second element should be the collateral amount
      const collateralElement = collateralElements[1];
      const usdElement = collateralElement.nextElementSibling;

      // Get current collateral amount
      const currentText = collateralElement.textContent;
      const currentBtcMatch = currentText.match(/([\d.]+) BTC/);
      if (!currentBtcMatch) return;

      const currentBtc = parseFloat(currentBtcMatch[1]);
      const newBtc = currentBtc + additionalBtc;
      const newUsd = newBtc * cryptoPrices.BTC;

      // Update displays
      collateralElement.textContent = newBtc.toFixed(4) + ' BTC';
      if (usdElement) {
        usdElement.textContent = '$' + newUsd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      console.log('Updated collateral from ' + currentBtc + ' BTC to ' + newBtc + ' BTC');
    }

    // Deduct amount from BTC balance (for savings)
    function deductFromBtcBalance(deductAmount) {
      // Find the BTC balance display element
      const btcBalanceElement = document.querySelector('h2.balance-value');
      if (!btcBalanceElement) return;

      // Get current balance in BTC
      const currentBtc = parseFloat(btcBalanceElement.textContent) || 0;

      // Calculate new balance
      const newBtcBalance = Math.max(0, currentBtc - deductAmount);

      // Update the display
      btcBalanceElement.textContent = newBtcBalance.toFixed(8);

      console.log('Deducted ' + deductAmount + ' BTC from balance, new balance: ' + newBtcBalance + ' BTC');
    }

    // Check if account has sufficient funds in collateral and BTC balance
    // NOTE: prefer authoritative balances from localStorage to avoid transient DOM parsing issues
    function hasSufficientFunds(requiredUsd = 0) {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        // Prefer explicit BTC balance, otherwise derive from savings USD
        const btc = (typeof user.btcBalance !== 'undefined' && user.btcBalance !== null)
          ? Number(user.btcBalance)
          : (Number(user.savingsBalanceUSD || 0) / (cryptoPrices.BTC || 42000));

        const btcBalanceUsd = (btc || 0) * (cryptoPrices.BTC || 42000);
        const collateralBalanceUsd = Number(user.collateralBalanceUSD || 0);

        const totalAvailable = btcBalanceUsd + collateralBalanceUsd;
        return totalAvailable >= Number(requiredUsd || 0);
      } catch (e) {
        // Fallback to DOM parsing if localStorage lookup fails for any reason
        console.debug('hasSufficientFunds fallback to DOM due to', e && e.message);

        // Get BTC balance
        const btcBalanceElement = document.querySelector('h2.balance-value');
        let btcBalanceUsd = 0;
        if (btcBalanceElement) {
          const currentBtc = parseFloat(btcBalanceElement.textContent) || 0;
          btcBalanceUsd = currentBtc * cryptoPrices.BTC;
        }

        // Get collateral balance
        let collateralBalanceUsd = 0;
        const collateralElements = document.querySelectorAll('p.text-white.text-lg.sm\\:text-xl.font-bold');
        if (collateralElements.length >= 2) {
          const collateralElement = collateralElements[1];
          const usdElement = collateralElement.nextElementSibling;
          if (usdElement) {
            const usdText = usdElement.textContent.replace('$', '').replace(/,/g, '');
            collateralBalanceUsd = parseFloat(usdText) || 0;
          }
        }

        const totalAvailable = btcBalanceUsd + collateralBalanceUsd;
        return totalAvailable >= requiredUsd;
      }
    }

    // Override window.alert for legacy insufficient-funds messages so they show styled modal instead
    (function(){
      const _nativeAlert = window.alert;
      window.alert = function(msg) {
        try {
          if (typeof msg === 'string' && msg.startsWith('Insufficient funds')) {
            const m = msg.match(/\$([0-9,]+\.?[0-9]*)/);
            const req = m ? Number(m[1].replace(/,/g, '')) : 0;
            const funds = getAvailableFunds();
            showInsufficientFundsModal(req, funds.totalAvailable, funds.btcUsd, funds.collateralUsd);
            return;
          }
        } catch(e) { console.warn('alert override error', e); }
        _nativeAlert(msg);
      };
    })();

    // Adjust local user balances optimistically (btcDelta in BTC units, collateralUsdDelta in USD, collateralBtcDelta in BTC)
    function adjustLocalBalances({ btcDelta = 0, collateralUsdDelta = 0, collateralBtcDelta = 0, savingsUsdDelta = 0 } = {}) {
      try {
        const stored = JSON.parse(localStorage.getItem('user') || '{}');
        stored.btcBalance = Number(stored.btcBalance || 0) + Number(btcDelta || 0);
        stored.collateralBalanceUSD = Number(stored.collateralBalanceUSD || 0) + Number(collateralUsdDelta || 0);
        stored.collateralBalanceBTC = Number(stored.collateralBalanceBTC || 0) + Number(collateralBtcDelta || 0);
        stored.savingsBalanceUSD = Number(stored.savingsBalanceUSD || 0) + Number(savingsUsdDelta || 0);

        // Clamp to reasonable non-negative values
        if (stored.btcBalance < 0) stored.btcBalance = 0;
        if (stored.collateralBalanceUSD < 0) stored.collateralBalanceUSD = 0;
        if (stored.collateralBalanceBTC < 0) stored.collateralBalanceBTC = 0;
        if (stored.savingsBalanceUSD < 0) stored.savingsBalanceUSD = 0;

        localStorage.setItem('user', JSON.stringify(stored));

        // Update UI
        populateUserInfo();
        try { updateCollateralDisplay(stored.collateralBalanceUSD || 0, stored.collateralBalanceBTC || 0); } catch(e) {}
        try { if (typeof displayTopToast === 'function') displayTopToast('Balance updated (pending)'); } catch (e) {}
      } catch (e) {
        console.warn('adjustLocalBalances failed', e && e.message);
      }
    }

    // Store active savings info for countdown
    let activeSavingsStartDate = null;
    let activeSavingsTerm = 0;

    // Update active savings display with countdown timer
    function updateActiveSavings(amount, apy, term, maturityDate, startDate) {
      // Allow restoring a previously persisted startDate
      activeSavingsStartDate = startDate ? new Date(startDate) : new Date();
      activeSavingsTerm = term;

      // Persist active savings so it survives page reloads
      try {
        const saveObj = {
          amount: Number(amount) || 0,
          apy: Number(apy) || 0,
          term: Number(term) || 0,
          startDate: activeSavingsStartDate.toISOString(),
          maturityDate: maturityDate ? (maturityDate.toISOString ? maturityDate.toISOString() : new Date(maturityDate).toISOString()) : null
        };
        localStorage.setItem('activeSavings', JSON.stringify(saveObj));
      } catch (e) {
        console.warn('Failed to persist active savings', e && e.message);
      }

      // Update locked amount
      const lockedAmountElements = document.querySelectorAll('span.text-white.font-bold.text-base.sm\\:text-lg');
      if (lockedAmountElements.length > 0) {
        lockedAmountElements[0].textContent = amount.toFixed(4) + ' BTC';
      }

      // Update current value
      const currentValueElements = document.querySelectorAll('span.text-gray-300.text-sm');
      if (currentValueElements.length > 0) {
        const currentValue = amount * cryptoPrices.BTC;
        currentValueElements[0].textContent = '$' + currentValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      // Update interest earned (initially 0)
      const interestElements = document.querySelectorAll('p.text-lg.sm\\:text-xl.font-bold');
      if (interestElements.length > 1) {
        interestElements[1].textContent = '0.0000 BTC';
        interestElements[1].nextElementSibling.textContent = '$0.00';
      }

      // Update APY rate
      const apyElements = document.querySelectorAll('p.text-lg.sm\\:text-xl.font-bold');
      if (apyElements.length > 2) {
        apyElements[2].textContent = apy + '%';
        apyElements[2].nextElementSibling.textContent = term + ' Days Term';
      }

      // Update dates
      const startedDateEl = document.getElementById('started-date');
      const maturityDateEl = document.getElementById('maturity-date');
      if (startedDateEl) {
        startedDateEl.textContent = 'Started: ' + activeSavingsStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
      if (maturityDateEl) {
        maturityDateEl.textContent = 'Matures: ' + maturityDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      // Update total at maturity
      const totalElements = document.querySelectorAll('p.text-white.font-bold.text-sm');
      if (totalElements.length >= 2) {
        totalElements[totalElements.length - 2].textContent = amount.toFixed(4) + ' BTC';
      }

      // Start countdown timer
      updateSavingsCountdown();

      // Ensure interest and APY elements are updated robustly
      (function() {
        const el = document.querySelectorAll('p.text-lg.sm\\:text-xl.font-bold');
        if (el.length > 0) {
          el[0].textContent = '0.0000 BTC';
          if (el[0].nextElementSibling) el[0].nextElementSibling.textContent = '$0.00';
        }
        if (el.length > 1) {
          el[1].textContent = apy + '%';
          if (el[1].nextElementSibling) el[1].nextElementSibling.textContent = term + ' Days Term';
        }
      })();
      console.log('Updated active savings display', { amount, apy, term });
      try { updateActiveBadges(); } catch(e) { /* non-fatal */ }
    }

    // Update savings countdown every second
    function updateSavingsCountdown() {
      const daysRemainingEl = document.getElementById('days-remaining');
      const progressFill = document.querySelector('.savings-progress-fill');

      if (!activeSavingsStartDate || activeSavingsTerm === 0) {
        // Show default when no savings is active
        if (daysRemainingEl) {
          daysRemainingEl.textContent = '0 Days';
        }
        return;
      }

      const now = new Date();
      const elapsedMs = now - activeSavingsStartDate;
      const totalMs = activeSavingsTerm * 24 * 60 * 60 * 1000;
      const remainingMs = Math.max(0, totalMs - elapsedMs);
      
      // Calculate days, hours, minutes, seconds
      const totalSeconds = Math.ceil(remainingMs / 1000);
      const days = Math.floor(totalSeconds / (24 * 60 * 60));
      const hours = Math.floor((totalSeconds % (24 * 60 * 60)) / (60 * 60));
      const minutes = Math.floor((totalSeconds % (60 * 60)) / 60);
      const seconds = totalSeconds % 60;

      if (daysRemainingEl) {
        if (remainingMs > 0) {
          let countdownText = '';
          if (days > 0) {
            countdownText = days + 'd ' + hours + 'h ' + minutes + 'm';
          } else if (hours > 0) {
            countdownText = hours + 'h ' + minutes + 'm ' + seconds + 's';
          } else {
            countdownText = minutes + 'm ' + seconds + 's';
          }
          daysRemainingEl.textContent = '⏱ ' + countdownText;
        } else {
          daysRemainingEl.textContent = '✓ Matured';
        }
      }

      // Update progress bar
      const progressPercent = Math.min(100, ((activeSavingsTerm * 24 * 60 * 60 * 1000 - remainingMs) / (activeSavingsTerm * 24 * 60 * 60 * 1000)) * 100);
      if (progressFill) {
        progressFill.style.width = progressPercent + '%';
      }
    }

    // Update countdown every second
    setInterval(updateSavingsCountdown, 1000);
    
    // Start fetching BTC price on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fetchBtcPrice);
    } else {
      fetchBtcPrice();
    }
    
    // Update BTC price every 30 seconds
    btcPriceInterval = setInterval(fetchBtcPrice, 30000);

    // Restore persisted active savings (if any)
    function loadActiveSavingsFromStorage() {
      try {
        const raw = localStorage.getItem('activeSavings');
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (!obj || !obj.amount || !obj.term) return;
        const maturity = obj.maturityDate ? new Date(obj.maturityDate) : null;
        updateActiveSavings(Number(obj.amount), Number(obj.apy) || 0, Number(obj.term), maturity, obj.startDate);
        console.log('Loaded active savings from storage', obj);
      } catch (e) {
        console.warn('Failed to load active savings', e && e.message);
      }
    }

    loadActiveSavingsFromStorage();

    // Delete user account function
    async function deleteUserAccount() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('No authentication token found. Please log in again.');
        window.location.href = 'signin.html';
        return;
      }

      try {
        const response = await fetch(window.API_BASE + '/api/auth/delete-account', {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          // Clear all user data from localStorage
          localStorage.clear();
          
          // Close the modal
          document.querySelector('.fixed').remove();
          
          // Show success message and redirect
          alert('Account deleted successfully.');
          window.location.href = 'signup.html';
        } else {
          const errorData = await response.json();
          alert(`Failed to delete account: ${errorData.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error deleting account:', error);
        alert('An error occurred while deleting your account. Please try again.');
      }
    }

    // Debug helper for face-api loading issues
    window.debugFaceAPI = async function() {
      console.log('=== Face-API Debug ===');
      
      // Check TensorFlow
      console.log('TensorFlow loaded:', typeof tf !== 'undefined');
      if (typeof tf !== 'undefined') {
        console.log('TensorFlow version:', tf.version.tfjs);
      }
      
      // Check Face-API
      console.log('Face-API loaded:', typeof faceapi !== 'undefined');
      if (typeof faceapi !== 'undefined') {
        console.log('Face-API nets available:', Object.keys(faceapi.nets || {}));
      }
      
      // Test model loading
      const MODEL_URLS = [
        'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@0.1.19/model/',
        'https://unpkg.com/@vladmandic/face-api@0.1.19/model/',
      ];
      
      for (const MODEL_URL of MODEL_URLS) {
        console.log('\n--- Testing:', MODEL_URL);
        try {
          console.log('Attempting to load tinyFaceDetector...');
          await Promise.race([
            faceapi.nets.tinyFaceDetector.load(MODEL_URL),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
          ]);
          console.log('✓ tinyFaceDetector loaded successfully');
          
          console.log('Attempting to load faceLandmark68...');
          await Promise.race([
            faceapi.nets.faceLandmark68.load(MODEL_URL),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
          ]);
          console.log('✓ faceLandmark68 loaded successfully');
          
          console.log('\n✓ Models loaded successfully from:', MODEL_URL);
          console.log('=== End Debug ===');
          return;
        } catch (error) {
          console.error('✗ Failed:', error.message);
        }
      }
      
      console.error('\n✗ All CDNs failed to load models');
      console.log('=== End Debug ===');
    };
    
    // Test camera access
    window.testCamera = async function() {
      console.log('Testing camera access...');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        
        const tracks = stream.getTracks();
        console.log('✓ Camera access granted');
        console.log('Video tracks:', tracks.length);
        tracks.forEach(track => {
          console.log('  -', track.kind, ':', track.label);
          track.stop();
        });
      } catch (error) {
        console.error('✗ Camera access denied:', error.message);
      }
    };
    
    // Quick test for everything
    window.quickTest = async function() {
      console.log('=== QUICK TEST ===');
      console.log('TensorFlow:', typeof tf !== 'undefined' ? '✓' : '✗');
      console.log('Face-API:', typeof faceapi !== 'undefined' ? '✓' : '✗');
      await window.testCamera();
      console.log('\nRun window.debugFaceAPI() to test model loading');
      console.log('=== END TEST ===');
    };

</script>
</body>
</html>
