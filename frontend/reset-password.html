<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0a">
  <title>XapoBank - Reset Password</title>
  <script src="/frontend/config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }

    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    * {
      font-family: 'Poppins', system-ui, -apple-system, sans-serif;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .hover-lift {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .form-input {
      background: #0f0f0f;
      border: 1px solid #2a2a2a;
      border-radius: 999px;
      color: white;
      transition: all 0.2s ease;
    }

    .form-input:focus {
      border-color: #ff6b35;
      outline: none;
    }

    .form-input::placeholder {
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .auth-card {
        margin: 1rem;
        padding: 1.5rem;
      }
    }
  </style>
 </head>
 <body class="h-full w-full" style="background: #0a0a0a;">
  <div class="min-h-screen flex items-center justify-center px-4 py-8">
   <div class="auth-card rounded-xl md:rounded-2xl p-6 sm:p-8 md:p-10 max-w-md w-full hover-lift" style="background: #1a1a1a; border: 1px solid #2a2a2a;">
    <!-- Logo/Brand -->
    <div class="text-center mb-8">
     <div class="w-32 h-32 mx-auto mb-4 flex items-center justify-center">
      <img src="xapo_logo.svg" alt="Xapo Logo" class="w-full h-full object-contain">
     </div>
     <p class="text-gray-400 text-sm">Secure Bitcoin Banking</p>
    </div>

    <h2 class="text-xl font-bold text-white text-center mb-6">Reset Your Password</h2>

    <!-- Reset Password Form -->
    <form id="reset-password-form">
     <div class="space-y-4">
      <div>
       <label class="text-gray-400 text-sm mb-2 block">New Password</label>
       <input type="password" name="password" placeholder="Enter new password" required class="form-input w-full px-4 py-3 text-sm" minlength="6">
      </div>
      <div>
       <label class="text-gray-400 text-sm mb-2 block">Confirm New Password</label>
       <input type="password" name="confirmPassword" placeholder="Confirm new password" required class="form-input w-full px-4 py-3 text-sm" minlength="6">
      </div>
      <button type="submit" class="w-full py-3 text-white font-bold text-sm transition-all hover-lift rounded-full" style="background: linear-gradient(135deg, #ff6b35 0%, #ff4500 100%);">
       Reset Password
      </button>
     </div>
    </form>

    <div id="reset-message" class="mt-4 text-sm text-center hidden"></div>

    <div class="mt-6 text-center">
     <a href="signin.html" class="text-orange-500 hover:text-orange-400 text-sm transition-colors">‚Üê Back to Sign In</a>
    </div>
   </div>
  </div>

  <script>
    function initializeResetPassword() {
      // Get token from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (!token) {
        document.getElementById('reset-message').textContent = 'Invalid reset link. Please request a new password reset.';
        document.getElementById('reset-message').className = 'mt-4 text-sm text-center text-red-400';
        document.getElementById('reset-message').classList.remove('hidden');
        document.getElementById('reset-password-form').style.display = 'none';
      }

      // Reset password form submission
      document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const password = e.target.password.value;
        const confirmPassword = e.target.confirmPassword.value;

        if (password !== confirmPassword) {
          showMessage('Passwords do not match', 'red');
          return;
        }

        if (password.length < 6) {
          showMessage('Password must be at least 6 characters long', 'red');
          return;
        }

        try {
          if (typeof window.API_BASE === 'undefined') {
            throw new Error('API configuration not loaded');
          }

          const response = await fetch(window.API_BASE + '/api/auth/resetpassword', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              token,
              password
            })
          });

          const data = await response.json();

          if (response.ok) {
            showMessage('Password reset successful! Redirecting to sign in...', 'green');
            setTimeout(() => {
              window.location.href = 'signin.html';
            }, 2000);
          } else {
            showMessage(data.message || 'Failed to reset password', 'red');
          }
        } catch (error) {
          console.error('Reset password error:', error);
          showMessage('Network error. Please try again.', 'red');
        }
      });

      function showMessage(message, color) {
        const messageEl = document.getElementById('reset-message');
        messageEl.textContent = message;
        messageEl.className = `mt-4 text-sm text-center text-${color}-400`;
        messageEl.classList.remove('hidden');
      }
    }

    // Wait for config.js to load
    function waitForConfig() {
      if (typeof window.API_BASE !== 'undefined') {
        initializeResetPassword();
      } else {
        setTimeout(waitForConfig, 100);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForConfig);
    } else {
      waitForConfig();
    }
  </script>
 </body>
</html>